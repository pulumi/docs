# NOTE: This workflow is currently disabled due to consistent failures from disk space
# exhaustion on GitHub Actions runners. The workflow attempts to test 385+ example programs
# across all languages, which exceeds the ~14GB disk space available.
#
# The workflow can be manually triggered via workflow_dispatch if needed, but it will
# likely still fail without significant changes to reduce disk usage.
#
# See issue #17321 for details and potential solutions.

permissions: write-all # Equivalent to default permissions + id-token: write
name: "Scheduled Jobs: Upgrade Examples"
on:
  # schedule:
  #   - cron: "0 6 * * *"  # DISABLED: See issue #17321
  workflow_dispatch: {}

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  AWS_REGION: "us-west-2"
  ESC_ACTION_OIDC_AUTH: true
  ESC_ACTION_OIDC_ORGANIZATION: pulumi
  ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
  ESC_ACTION_ENVIRONMENT: github-secrets/pulumi-docs
  ESC_ACTION_EXPORT_ENVIRONMENT_VARIABLES: PULUMI_ACCESS_TOKEN=PULUMI_ACCESS_TOKEN

jobs:
  upgrade:
    runs-on: ${{ matrix.platform }}
    strategy:
      matrix:
        platform:
          - ubuntu-latest
        go-version:
          - 1.25.x
        node-version:
          - 24.x
        python-version:
          - 3.9
        dotnet-version:
          - 8.0.x
        java-version:
          - 11

    steps:
      - name: Fetch secrets from ESC
        id: esc-secrets
        uses: pulumi/esc-action@v1
      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java-version }}

      - name: Install DotNet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Install Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.154.5"
          extended: true

      - name: Install Pulumi
        uses: pulumi/actions@v6

      - name: Check out the code
        uses: actions/checkout@v6
        with:
          token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-region: ${{ env.AWS_REGION }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          role-duration-seconds: 14400 # 4 hours
          role-session-name: pulumi-docs-examples@githubActions
          role-to-assume: ${{ steps.esc-secrets.outputs.AWS_CI_ROLE_ARN }}

      - name: Upgrade and test example programs
        run: make upgrade-programs test-programs

      - name: Create a pull request
        uses: peter-evans/create-pull-request@v8
        with:
          branch: examples/upgrade
          author: Pulumi Bot <bot@pulumi.com>
          committer: Pulumi Bot <bot@pulumi.com>
          title: Upgrade Go module dependencies in example programs
          # labels: "automation/merge"
          commit-message: Upgrade Go module dependencies in example programs
          token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
          body: |
            Upgrades Go module dependencies in example programs to their latest versions.
