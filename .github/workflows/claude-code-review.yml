name: Claude Code Review

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Skip automated PRs from pulumi-bot and dependabot (secrets not available)
    if: github.event.pull_request.user.login != 'pulumi-bot' && github.event.pull_request.user.login != 'dependabot[bot]'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Check organization membership
        id: check-membership
        run: |
          # Check if PR author is a member of the pulumi organization
          ORG="pulumi"
          AUTHOR="${{ github.event.pull_request.user.login }}"

          # Use GitHub API to check membership (returns 204 if member, 404 if not)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/orgs/$ORG/members/$AUTHOR")

          if [ "$HTTP_CODE" = "204" ]; then
            echo "is_member=true" >> $GITHUB_OUTPUT
            echo "✓ PR author $AUTHOR is a member of $ORG"
          else
            echo "is_member=false" >> $GITHUB_OUTPUT
            echo "✗ PR author $AUTHOR is not a member of $ORG (HTTP $HTTP_CODE)"
          fi

      - name: Run Claude Code Review
        if: steps.check-membership.outputs.is_member == 'true'
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Invoke the docs-review slash command, which contains all review criteria and CI-specific guidance.
          # See .claude/commands/docs-review.md for the complete review workflow.
          prompt: |
            You are running in a CI environment.

            Review pull request #${{ github.event.pull_request.number }} by following the instructions in `.claude/commands/docs-review.md` under the "Continuous Integration (CI) Context" section.

