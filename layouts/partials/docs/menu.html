{{- $page := .page }}

{{/*
    BREADCRUMB BUILDING

    Breadcrumbs are built as a side effect of rendering the menu. As the menu walker
    (inline/menu/walk.html) iterates through menu items, it identifies ancestors of the
    current page using Hugo's .HasMenuCurrent function and adds them to .Scratch.

    After all menus are rendered, we prepend "Docs" root and append the current page.
    The breadcrumb.html partial retrieves this data from .Scratch and renders it.
*/}}

{{/* Initialize empty breadcrumb list - will be populated as menu renders */}}
{{ $page.Scratch.Set "breadcrumbs" slice }}

{{/* Build URL lookup maps per menu for performance */}}
{{ range $menuName, $menuEntries := site.Menus }}
    {{ $page.Scratch.Set (printf "menuURLs-%s" $menuName) dict }}
    {{ partial "inline/menu/collecturls" (dict "menuName" $menuName "menuEntries" $menuEntries "page" $page) }}
{{ end }}

{{/* Detect current section for auto-expansion */}}
{{ $currentSection := "home" }}
{{ if eq $page.Path "/docs/" }}
    {{ $currentSection = "home" }}
{{ else if hasPrefix $page.Path "/docs/get-started" }}
    {{ $currentSection = "get-started" }}
{{ else if hasPrefix $page.Path "/docs/iac" }}
    {{ $currentSection = "iac" }}
{{ else if hasPrefix $page.Path "/docs/esc" }}
    {{ $currentSection = "esc" }}
{{ else if hasPrefix $page.Path "/docs/insights" }}
    {{ $currentSection = "insights" }}
{{ else if hasPrefix $page.Path "/docs/idp" }}
    {{ $currentSection = "idp" }}
{{ else if hasPrefix $page.Path "/docs/ai" }}
    {{ $currentSection = "ai" }}
{{ else if hasPrefix $page.Path "/docs/deployments" }}
    {{ $currentSection = "deployments" }}
{{ else if hasPrefix $page.Path "/docs/migration" }}
    {{ $currentSection = "migration" }}
{{ else if hasPrefix $page.Path "/docs/administration" }}
    {{ $currentSection = "administration" }}
{{ else if hasPrefix $page.Path "/docs/reference" }}
    {{ $currentSection = "reference" }}
{{ else if hasPrefix $page.Path "/docs/support" }}
    {{ $currentSection = "support" }}
{{ else if hasPrefix $page.Path "/tutorials" }}
    {{ $currentSection = "get-started" }}
{{ end }}

<nav class="text-sm mt-5 mr-2">
    {{/* Search box moved from top nav */}}
    <div class="docs-search mb-4">
        <div
            id="search"
            data-app-id="{{ getenv "ALGOLIA_APP_ID" }}"
            data-search-key="{{ getenv "ALGOLIA_APP_SEARCH_KEY" }}"
            data-facets="Docs,Registry,Tutorials,Blog"
            data-index="production"
        ></div>
    </div>

    <pulumi-docs-nav expanded-menu-ids="{{ delimit (default slice $page.Params.expanded_menu_ids) "," }}">
        <ul class="list-none pl-0">

            <li class="" data-menu-id="docs-home">
                <ul class="list-none">
                    <li><a href="/docs/"{{ if eq $page.RelPermalink "/docs/" }} class="active" aria-current="page"{{ end }}>
                        <button><i class="fa fa-caret-right"></i></button>
                        <span>Docs Home</span>
                    </a></li>
                </ul>
            </li>

            {{/* Get Started Section */}}
            {{- with index site.Menus "get-started" }}
            <li class="expandable expanded{{ if eq $currentSection "get-started" }} expanded{{ end }}" data-menu-id="get-started-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "get-started" "currentSection" $currentSection "menuEntries" . "allMenuEntries" . "forceTopLevelLabel" "Get Started") }}
                </ul>
            </li>
            {{- end }}

            {{/* Infrastructure as Code Section */}}
            {{- with index site.Menus "iac" }}
            <li class="expandable expanded{{ if eq $currentSection "iac" }} expanded{{ end }}" data-menu-id="iac-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "iac" "currentSection" $currentSection "menuEntries" . "allMenuEntries" . "forceTopLevelLabel" "Infrastructure as Code") }}
                </ul>
            </li>
            {{- end }}

            {{/* Deployments & Workflows Section */}}
            {{- with index site.Menus "deployments" }}
            <li class="expandable expanded{{ if eq $currentSection "deployments" }} expanded{{ end }}" data-menu-id="deployments-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "deployments" "currentSection" $currentSection "menuEntries" . "allMenuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Secrets & Configuration Section */}}
            {{- with index site.Menus "esc" }}
            <li class="expandable expanded{{ if eq $currentSection "esc" }} expanded{{ end }}" data-menu-id="esc-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "esc" "currentSection" $currentSection "menuEntries" . "allMenuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Insights & Governance Section */}}
            {{- with index site.Menus "insights" }}
            <li class="expandable expanded{{ if eq $currentSection "insights" }} expanded{{ end }}" data-menu-id="insights-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "insights" "currentSection" $currentSection "menuEntries" . "allMenuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Internal Developer Platform Section */}}
            {{- with index site.Menus "idp" }}
            <li class="expandable expanded{{ if eq $currentSection "idp" }} expanded{{ end }}" data-menu-id="idp-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "idp" "currentSection" $currentSection "menuEntries" . "allMenuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* AI-Driven Tasks Section */}}
            {{- with index site.Menus "ai" }}
            <li class="expandable expanded{{ if eq $currentSection "ai" }} expanded{{ end }}" data-menu-id="ai-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "ai" "currentSection" $currentSection "menuEntries" . "allMenuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Migration Section */}}
            {{- with index site.Menus "migration" }}
            <li class="expandable expanded{{ if eq $currentSection "migration" }} expanded{{ end }}" data-menu-id="migration-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "migration" "currentSection" $currentSection "menuEntries" . "allMenuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Administration Section */}}
            {{- with index site.Menus "administration" }}
            <li class="expandable expanded{{ if eq $currentSection "administration" }} expanded{{ end }}" data-menu-id="administration-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "administration" "currentSection" $currentSection "menuEntries" . "allMenuEntries" . "forceTopLevelLabel" "Administration") }}
                </ul>
            </li>
            {{- end }}

            {{/* Reference Section */}}
            {{- with index site.Menus "reference" }}
            <li class="expandable expanded{{ if eq $currentSection "reference" }} expanded{{ end }}" data-menu-id="reference-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "reference" "currentSection" $currentSection "menuEntries" . "allMenuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Tutorials External Link */}}
            <li class="" data-menu-id="tutorials-external">
                <ul class="list-none">
                    <li><a href="https://www.pulumi.com/tutorials/" target="_blank" rel="noopener noreferrer">
                        <button><i class="fa fa-caret-right"></i></button>
                        <span>Tutorials ↗</span>
                    </a></li>
                </ul>
            </li>

            {{/* Support Section */}}
            {{- with index site.Menus "support" }}
            <li class="expandable expanded{{ if eq $currentSection "support" }} expanded{{ end }}" data-menu-id="support-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "support" "currentSection" $currentSection "menuEntries" . "allMenuEntries" .) }}
                </ul>
            </li>
            {{- end }}

        </ul>
    </pulumi-docs-nav>
</nav>

{{/*
    BREADCRUMB FINALIZATION

    After all menus have been rendered and ancestors collected, complete the breadcrumb chain:
    1. Prepend "Docs" root at the beginning
    2. Append the current page at the end
    Result: Docs → [ancestor1] → [ancestor2] → Current Page
*/}}
{{ $existingCrumbs := $page.Scratch.Get "breadcrumbs" }}
{{ $finalBreadcrumbs := slice (dict "name" "Docs" "url" "/docs/") }}
{{ range $existingCrumbs }}
    {{ $finalBreadcrumbs = $finalBreadcrumbs | append . }}
{{ end }}
{{ $finalBreadcrumbs = $finalBreadcrumbs | append (dict "name" $page.LinkTitle "url" $page.RelPermalink) }}
{{ $page.Scratch.Set "breadcrumbs" $finalBreadcrumbs }}

{{- define "partials/inline/menu/collecturls" }}
    {{- $menuName := .menuName }}
    {{- $page := .page }}
    {{- range .menuEntries }}
        {{- if .URL }}
            {{- $page.Scratch.SetInMap (printf "menuURLs-%s" $menuName) .URL true }}
        {{- end }}
        {{- with .Children }}
            {{- partial "inline/menu/collecturls" (dict "menuName" $menuName "menuEntries" . "page" $page) }}
        {{- end }}
    {{- end }}
{{- end }}

{{- define "partials/inline/menu/walk.html" }}
    {{- $page := .page }}
    {{- $rootMenuID := .rootMenuID }}
    {{- $allMenuEntries := .allMenuEntries }}

    {{- range .menuEntries }}
        {{/* Skip Overview pages since we add them manually */}}
        {{/* Skip root home items that we've already created manually */}}
        {{- if and (ne .Name "Overview") (ne .Identifier $rootMenuID) }}
            {{- $attrs := dict "href" .URL }}
            {{- if $page.IsMenuCurrent .Menu . }}
                {{- $attrs = merge $attrs (dict "class" "active" "aria-current" "page") }}
            {{- else if $page.HasMenuCurrent .Menu .}}
                {{- $attrs = merge $attrs (dict "class" "ancestor" "aria-current" "true") }}
            {{- end }}
            {{- $name := .Name }}
            {{- with .Identifier }}
                {{- with T . }}
                    {{- $name = . }}
                {{- end }}
            {{- end }}

            {{/* Store the current menu item before entering Children context */}}
            {{- $currentMenuItem := . }}

            {{/*
                BREADCRUMB COLLECTION

                Only collect breadcrumbs if:
                1. This menu item is an ancestor of the current page (HasMenuCurrent returns true)
                2. AND the page is actually in this menu (either in frontmatter OR in menus.yml)
                3. AND the menu being walked matches the current section

                This prevents collecting breadcrumbs from multiple menus when parent pages
                are in multiple menus (e.g., /docs/iac/cli/ is in both iac and reference menus).
            */}}
            {{- $menuName := .Menu }}
            {{- $isAncestor := $page.HasMenuCurrent $menuName $currentMenuItem }}
            {{- $pageHasThisMenu := and $page.Params.menu (index $page.Params.menu $menuName) }}
            {{- $pageInMenuYML := index ($page.Scratch.Get (printf "menuURLs-%s" $menuName)) $page.RelPermalink }}
            {{- $menuMatchesSection := eq $rootMenuID $.currentSection }}
            {{- if and $isAncestor (or $pageHasThisMenu $pageInMenuYML) $menuMatchesSection }}
                {{- $page.Scratch.Add "breadcrumbs" (dict "name" $currentMenuItem.Name "url" $currentMenuItem.URL) }}
            {{- end }}

            <li {{ if (and .Children (ne .Identifier $rootMenuID)) }} class="expandable" {{ end }}
                {{ if .Identifier }} data-menu-id="{{ .Identifier }}" {{ end }}
                >
                {{- if and .Children (ne .Identifier $rootMenuID) }}
                    {{/* Parent with children - make it clickable for expand/collapse but not navigation */}}
                    <a href="javascript:void(0)"{{- if $page.HasMenuCurrent .Menu . }} class="ancestor"{{ end }} onclick="this.closest('li').classList.toggle('expanded'); return false;">
                    <button style="pointer-events: none;">
                        <i class="fa fa-caret-right"></i>
                    </button>
                    <span>{{ $name }}</span>
                    </a>
                {{- else }}
                    {{/* Regular link or root menu item */}}
                    <a
                        {{- range $k, $v := $attrs }}
                            {{- with $v }}
                                {{- printf " %s=%q" $k $v | safeHTMLAttr }}
                            {{- end }}
                        {{- end -}}
                    >
                    <button>
                        <i class="fa fa-caret-right"></i>
                    </button>
                    <span>{{ $name }}</span>
                    </a>
                {{- end }}
                {{- with .Children }}
                    <ul class="list-none">
                        {{/* Add Overview link for parent pages that have a URL */}}
                        {{- if $currentMenuItem.URL }}
                            {{- $overviewPage := site.GetPage $currentMenuItem.URL }}
                            {{- if $overviewPage }}
                                <li data-menu-id="overview">
                                    <a href="{{ $overviewPage.RelPermalink }}"
                                        {{- if eq $page.RelPermalink $overviewPage.RelPermalink }}
                                            class="active" aria-current="page"
                                        {{- end }}
                                    >
                                    <button>
                                        <i class="fa fa-caret-right"></i>
                                    </button>
                                    <span>{{ if $overviewPage.Params.overview_name }}{{ $overviewPage.Params.overview_name }}{{ else }}Overview{{ end }}</span>
                                    </a>
                                </li>
                            {{- end }}
                        {{- end }}
                        {{- partial "inline/menu/walk.html" (dict "page" $page "menuEntries" . "rootMenuID" $rootMenuID "currentSection" $.currentSection "allMenuEntries" $allMenuEntries) }}
                    </ul>
                {{- end }}
            </li>
        {{- end }}
    {{- end }}
{{- end }}