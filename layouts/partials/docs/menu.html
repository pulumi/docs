{{- $page := .page }}

{{/* Detect current section for auto-expansion */}}
{{ $currentSection := "home" }}
{{ if eq $page.Path "/docs/" }}
    {{ $currentSection = "docs" }}
{{ else if hasPrefix $page.Path "/docs/iac" }}
    {{ $currentSection = "iac" }}
{{ else if hasPrefix $page.Path "/docs/esc" }}
    {{ $currentSection = "esc" }}
{{ else if hasPrefix $page.Path "/docs/idp" }}
    {{ $currentSection = "idp" }}
{{ else if hasPrefix $page.Path "/docs/pulumi-cloud" }}
    {{ $currentSection = "cloud" }}
{{ else if hasPrefix $page.Path "/docs/insights" }}
    {{ $currentSection = "insights" }}
{{ else if hasPrefix $page.Path "/registry" }}
    {{ $currentSection = "packages" }}
{{ else if hasPrefix $page.Path "/tutorials" }}
    {{ $currentSection = "tutorials" }}
{{ end }}

<nav class="text-sm mt-7 mr-2">
    <pulumi-docs-nav expanded-menu-ids="{{ delimit (default slice $page.Params.expanded_menu_ids) "," }}">
        <ul class="list-none pl-0">


            <li class="expandable{{ if eq $currentSection "docs" }} expanded{{ end }}" data-menu-id="docs-home">
                <a href="javascript:void(0)" onclick="this.closest('li').classList.toggle('expanded'); return false;">
                    <button style="pointer-events: none;"><i class="fa fa-caret-right"></i></button>
                    <span>docs</span>
                </a>
                <ul class="list-none">
                    <li><a href="/docs/"{{ if eq $page.RelPermalink "/docs/" }} class="active" aria-current="page"{{ end }}>
                        <button><i class="fa fa-caret-right"></i></button>
                        <span>Docs Home</span>
                    </a></li>
                </ul>
            </li>

            {{/* Pulumi IaC Section */}}
            {{- with index site.Menus "iac" }}
                <li class="expandable{{ if eq $currentSection "iac" }} expanded{{ end }}" data-menu-id="iac-top">
                    <a href="javascript:void(0)" onclick="this.closest('li').classList.toggle('expanded'); return false;">
                        <button style="pointer-events: none;"><i class="fa fa-caret-right"></i></button>
                        <span>Pulumi IaC</span>
                    </a>
                    <ul class="list-none">
                        {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "iac" "menuEntries" .) }}
                    </ul>
                </li>
            {{- end }}

            {{/* Pulumi ESC Section */}}
            {{- with index site.Menus "esc" }}
                <li class="expandable{{ if eq $currentSection "esc" }} expanded{{ end }}" data-menu-id="esc-top">
                    <a href="javascript:void(0)" onclick="this.closest('li').classList.toggle('expanded'); return false;">
                        <button style="pointer-events: none;"><i class="fa fa-caret-right"></i></button>
                        <span>Pulumi ESC</span>
                    </a>
                    <ul class="list-none">
                        {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "esc" "menuEntries" .) }}
                    </ul>
                </li>
            {{- end }}

            {{/* Pulumi Cloud Section */}}
            {{- with index site.Menus "cloud" }}
                <li class="expandable{{ if eq $currentSection "cloud" }} expanded{{ end }}" data-menu-id="cloud-top">
                    <a href="javascript:void(0)" onclick="this.closest('li').classList.toggle('expanded'); return false;">
                        <button style="pointer-events: none;"><i class="fa fa-caret-right"></i></button>
                        <span>Pulumi Cloud</span>
                    </a>
                    <ul class="list-none">
                        {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "cloud" "menuEntries" .) }}
                    </ul>
                </li>
            {{- end }}

            {{/* Pulumi IDP Section */}}
            {{- with index site.Menus "idp" }}
                <li class="expandable{{ if eq $currentSection "idp" }} expanded{{ end }}" data-menu-id="idp-top">
                    <a href="javascript:void(0)" onclick="this.closest('li').classList.toggle('expanded'); return false;">
                        <button style="pointer-events: none;"><i class="fa fa-caret-right"></i></button>
                        <span>Pulumi IDP</span>
                    </a>
                    <ul class="list-none">
                        {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "idp" "menuEntries" .) }}
                    </ul>
                </li>
            {{- end }}

            {{/* Pulumi Insights Section */}}
            {{- with index site.Menus "insights" }}
                <li class="expandable{{ if eq $currentSection "insights" }} expanded{{ end }}" data-menu-id="insights-top">
                    <a href="javascript:void(0)" onclick="this.closest('li').classList.toggle('expanded'); return false;">
                        <button style="pointer-events: none;"><i class="fa fa-caret-right"></i></button>
                        <span>Pulumi Insights</span>
                    </a>
                    <ul class="list-none">
                        {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "insights" "menuEntries" .) }}
                    </ul>
                </li>
            {{- end }}

            {{/* Packages Section */}}
            <li class="expandable{{ if eq $currentSection "packages" }} expanded{{ end }}" data-menu-id="packages-top">
                <a href="javascript:void(0)" onclick="this.closest('li').classList.toggle('expanded'); return false;">
                    <button style="pointer-events: none;"><i class="fa fa-caret-right"></i></button>
                    <span>Packages</span>
                </a>
                <ul class="list-none">
                    <li><a href="/registry/">
                        <button><i class="fa fa-caret-right"></i></button>
                        <span>Browse Packages</span>
                    </a></li>
                </ul>
            </li>

            {{/* Tutorials Section */}}
            <li class="expandable{{ if eq $currentSection "tutorials" }} expanded{{ end }}" data-menu-id="tutorials-top">
                <a href="javascript:void(0)" onclick="this.closest('li').classList.toggle('expanded'); return false;">
                    <button style="pointer-events: none;"><i class="fa fa-caret-right"></i></button>
                    <span>Tutorials</span>
                </a>
                <ul class="list-none">
                    <li><a href="/tutorials/">
                        <button><i class="fa fa-caret-right"></i></button>
                        <span>All Tutorials</span>
                    </a></li>
                </ul>
            </li>

        </ul>
    </pulumi-docs-nav>
</nav>

{{- define "partials/inline/menu/walk.html" }}
    {{- $page := .page }}
    {{- $rootMenuID := .rootMenuID }}

    {{- range .menuEntries }}
        {{/* Skip Overview pages since we add them manually */}}
        {{/* Skip root home items that we've already created manually */}}
        {{- if and (ne .Name "Overview") (ne .Identifier $rootMenuID) }}
            {{- $attrs := dict "href" .URL }}
            {{- if $page.IsMenuCurrent .Menu . }}
                {{- $attrs = merge $attrs (dict "class" "active" "aria-current" "page") }}
            {{- else if $page.HasMenuCurrent .Menu .}}
                {{- $attrs = merge $attrs (dict "class" "ancestor" "aria-current" "true") }}
            {{- end }}
            {{- $name := .Name }}
            {{- with .Identifier }}
                {{- with T . }}
                    {{- $name = . }}
                {{- end }}
            {{- end }}

            {{/* Store the current menu item before entering Children context */}}
            {{- $currentMenuItem := . }}

            <li {{ if (and .Children (ne .Identifier $rootMenuID)) }} class="expandable" {{ end }}
                {{ if .Identifier }} data-menu-id="{{ .Identifier }}" {{ end }}
                >
                {{- if and .Children (ne .Identifier $rootMenuID) }}
                    {{/* Parent with children - make it clickable for expand/collapse but not navigation */}}
                    <a href="javascript:void(0)"{{- if $page.HasMenuCurrent .Menu . }} class="ancestor"{{ end }} onclick="this.closest('li').classList.toggle('expanded'); return false;">
                    <button style="pointer-events: none;">
                        <i class="fa fa-caret-right"></i>
                    </button>
                    <span>{{ $name }}</span>
                    </a>
                {{- else }}
                    {{/* Regular link or root menu item */}}
                    <a
                        {{- range $k, $v := $attrs }}
                            {{- with $v }}
                                {{- printf " %s=%q" $k $v | safeHTMLAttr }}
                            {{- end }}
                        {{- end -}}
                    >
                    <button>
                        <i class="fa fa-caret-right"></i>
                    </button>
                    <span>{{ $name }}</span>
                    </a>
                {{- end }}
                {{- with .Children }}
                    <ul class="list-none">
                        {{/* Add Overview link for pages marked as overview pages */}}
                        {{- $overviewPage := "" }}
                        {{- if $currentMenuItem.URL }}
                            {{- $overviewPage = site.GetPage $currentMenuItem.URL }}
                        {{- end }}

                        {{- if and $overviewPage $overviewPage.Params.is_overview }}
                            <li data-menu-id="overview">
                                <a href="{{ $overviewPage.RelPermalink }}"
                                    {{- if eq $page.RelPermalink $overviewPage.RelPermalink }}
                                        class="active" aria-current="page"
                                    {{- end }}
                                >
                                <button>
                                    <i class="fa fa-caret-right"></i>
                                </button>
                                <span>Overview</span>
                                </a>
                            </li>
                        {{- end }}
                        {{- partial "inline/menu/walk.html" (dict "page" $page "menuEntries" . "rootMenuID" $rootMenuID) }}
                    </ul>
                {{- end }}
            </li>
        {{- end }}
    {{- end }}
{{- end }}