{{- $page := .page }}

{{/* Detect current section for auto-expansion */}}
{{ $currentSection := "home" }}
{{ if eq $page.Path "/docs/" }}
    {{ $currentSection = "home" }}
{{ else if hasPrefix $page.Path "/docs/get-started" }}
    {{ $currentSection = "get-started" }}
{{ else if hasPrefix $page.Path "/docs/iac" }}
    {{ $currentSection = "iac" }}
{{ else if hasPrefix $page.Path "/docs/esc" }}
    {{ $currentSection = "esc" }}
{{ else if hasPrefix $page.Path "/docs/insights" }}
    {{ $currentSection = "insights" }}
{{ else if hasPrefix $page.Path "/docs/idp" }}
    {{ $currentSection = "idp" }}
{{ else if hasPrefix $page.Path "/docs/ai" }}
    {{ $currentSection = "ai" }}
{{ else if hasPrefix $page.Path "/docs/platform" }}
    {{ $currentSection = "platform" }}
{{ else if hasPrefix $page.Path "/docs/migration" }}
    {{ $currentSection = "migration" }}
{{ else if hasPrefix $page.Path "/docs/administration" }}
    {{ $currentSection = "administration" }}
{{ else if hasPrefix $page.Path "/docs/reference" }}
    {{ $currentSection = "reference" }}
{{ else if hasPrefix $page.Path "/docs/support" }}
    {{ $currentSection = "support" }}
{{ else if hasPrefix $page.Path "/registry" }}
    {{ $currentSection = "reference" }}
{{ else if hasPrefix $page.Path "/tutorials" }}
    {{ $currentSection = "get-started" }}
{{ end }}

<nav class="text-sm mt-5 mr-2">
    {{/* Search box moved from top nav */}}
    <div class="docs-search mb-4">
        <div
            id="search"
            data-app-id="{{ getenv "ALGOLIA_APP_ID" }}"
            data-search-key="{{ getenv "ALGOLIA_APP_SEARCH_KEY" }}"
            data-facets="Docs,Registry,Tutorials,Blog"
            data-index="production"
        ></div>
    </div>

    <pulumi-docs-nav expanded-menu-ids="{{ delimit (default slice $page.Params.expanded_menu_ids) "," }}">
        <ul class="list-none pl-0">

            <li class="" data-menu-id="docs-home">
                <ul class="list-none">
                    <li><a href="/docs/"{{ if eq $page.RelPermalink "/docs/" }} class="active" aria-current="page"{{ end }}>
                        <button><i class="fa fa-caret-right"></i></button>
                        <span>Docs Home</span>
                    </a></li>
                </ul>
            </li>

            {{/* Get Started Section */}}
            {{- with index site.Menus "get-started" }}
            <li class="expandable expanded{{ if eq $currentSection "get-started" }} expanded{{ end }}" data-menu-id="get-started-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "get-started" "menuEntries" . "forceTopLevelLabel" "Get Started") }}
                </ul>
            </li>
            {{- end }}

            {{/* Infrastructure as Code Section */}}
            {{- with index site.Menus "iac" }}
            <li class="expandable expanded{{ if eq $currentSection "iac" }} expanded{{ end }}" data-menu-id="iac-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "iac" "menuEntries" . "forceTopLevelLabel" "Infrastructure as Code") }}
                </ul>
            </li>
            {{- end }}

            {{/* Platform Features Section */}}
            {{- with index site.Menus "platform" }}
            <li class="expandable expanded{{ if eq $currentSection "platform" }} expanded{{ end }}" data-menu-id="platform-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "platform" "menuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Secrets & Configuration Section */}}
            {{- with index site.Menus "esc" }}
            <li class="expandable expanded{{ if eq $currentSection "esc" }} expanded{{ end }}" data-menu-id="esc-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "esc" "menuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Insights & Governance Section */}}
            {{- with index site.Menus "insights" }}
            <li class="expandable expanded{{ if eq $currentSection "insights" }} expanded{{ end }}" data-menu-id="insights-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "insights" "menuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Internal Developer Platform Section */}}
            {{- with index site.Menus "idp" }}
            <li class="expandable expanded{{ if eq $currentSection "idp" }} expanded{{ end }}" data-menu-id="idp-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "idp" "menuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* AI-Driven Tasks Section */}}
            {{- with index site.Menus "ai" }}
            <li class="expandable expanded{{ if eq $currentSection "ai" }} expanded{{ end }}" data-menu-id="ai-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "ai" "menuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Migration Section */}}
            {{- with index site.Menus "migration" }}
            <li class="expandable expanded{{ if eq $currentSection "migration" }} expanded{{ end }}" data-menu-id="migration-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "migration" "menuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Administration Section */}}
            {{- with index site.Menus "administration" }}
            <li class="expandable expanded{{ if eq $currentSection "administration" }} expanded{{ end }}" data-menu-id="administration-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "administration" "menuEntries" . "forceTopLevelLabel" "Administration") }}
                </ul>
            </li>
            {{- end }}

            {{/* Reference Section */}}
            {{- with index site.Menus "reference" }}
            <li class="expandable expanded{{ if eq $currentSection "reference" }} expanded{{ end }}" data-menu-id="reference-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "reference" "menuEntries" .) }}
                </ul>
            </li>
            {{- end }}

            {{/* Tutorials External Link */}}
            <li class="" data-menu-id="tutorials-external">
                <ul class="list-none">
                    <li><a href="https://www.pulumi.com/tutorials/" target="_blank" rel="noopener noreferrer">
                        <button><i class="fa fa-caret-right"></i></button>
                        <span>Tutorials ðŸ”—</span>
                    </a></li>
                </ul>
            </li>

            {{/* Support Section */}}
            {{- with index site.Menus "support" }}
            <li class="expandable expanded{{ if eq $currentSection "support" }} expanded{{ end }}" data-menu-id="support-top">
                <ul class="list-none">
                    {{- partial "inline/menu/walk.html" (dict "page" $page "rootMenuID" "support" "menuEntries" .) }}
                </ul>
            </li>
            {{- end }}

        </ul>
    </pulumi-docs-nav>
</nav>

{{- define "partials/inline/menu/walk.html" }}
    {{- $page := .page }}
    {{- $rootMenuID := .rootMenuID }}

    {{- range .menuEntries }}
        {{/* Skip Overview pages since we add them manually */}}
        {{/* Skip root home items that we've already created manually */}}
        {{- if and (ne .Name "Overview") (ne .Identifier $rootMenuID) }}
            {{- $attrs := dict "href" .URL }}
            {{- if $page.IsMenuCurrent .Menu . }}
                {{- $attrs = merge $attrs (dict "class" "active" "aria-current" "page") }}
            {{- else if $page.HasMenuCurrent .Menu .}}
                {{- $attrs = merge $attrs (dict "class" "ancestor" "aria-current" "true") }}
            {{- end }}
            {{- $name := .Name }}
            {{- with .Identifier }}
                {{- with T . }}
                    {{- $name = . }}
                {{- end }}
            {{- end }}

            {{/* Store the current menu item before entering Children context */}}
            {{- $currentMenuItem := . }}

            <li {{ if (and .Children (ne .Identifier $rootMenuID)) }} class="expandable" {{ end }}
                {{ if .Identifier }} data-menu-id="{{ .Identifier }}" {{ end }}
                >
                {{- if and .Children (ne .Identifier $rootMenuID) }}
                    {{/* Parent with children - make it clickable for expand/collapse but not navigation */}}
                    <a href="javascript:void(0)"{{- if $page.HasMenuCurrent .Menu . }} class="ancestor"{{ end }} onclick="this.closest('li').classList.toggle('expanded'); return false;">
                    <button style="pointer-events: none;">
                        <i class="fa fa-caret-right"></i>
                    </button>
                    <span>{{ $name }}</span>
                    </a>
                {{- else }}
                    {{/* Regular link or root menu item */}}
                    <a
                        {{- range $k, $v := $attrs }}
                            {{- with $v }}
                                {{- printf " %s=%q" $k $v | safeHTMLAttr }}
                            {{- end }}
                        {{- end -}}
                    >
                    <button>
                        <i class="fa fa-caret-right"></i>
                    </button>
                    <span>{{ $name }}</span>
                    </a>
                {{- end }}
                {{- with .Children }}
                    <ul class="list-none">
                        {{/* Add Overview link for section index pages with child content */}}
                        {{- $overviewPage := "" }}
                        {{- if $currentMenuItem.URL }}
                            {{- $overviewPage = site.GetPage $currentMenuItem.URL }}
                        {{- end }}

                        {{/* Automatically detect if this is an overview page: _index.md with child content */}}
                        {{- $isOverview := and $overviewPage $overviewPage.IsSection (or $overviewPage.Pages $overviewPage.Sections) (not $overviewPage.Params.no_overview) }}
                        {{- if $isOverview }}
                            <li data-menu-id="overview">
                                <a href="{{ $overviewPage.RelPermalink }}"
                                    {{- if eq $page.RelPermalink $overviewPage.RelPermalink }}
                                        class="active" aria-current="page"
                                    {{- end }}
                                >
                                <button>
                                    <i class="fa fa-caret-right"></i>
                                </button>
                                <span>Overview</span>
                                </a>
                            </li>
                        {{- end }}
                        {{- partial "inline/menu/walk.html" (dict "page" $page "menuEntries" . "rootMenuID" $rootMenuID) }}
                    </ul>
                {{- end }}
            </li>
        {{- end }}
    {{- end }}
{{- end }}