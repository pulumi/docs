{{/* Enhanced BlogPosting Schema - Migrated from head.html with AI optimizations */}}

{{ if and (eq .Type "blog") .IsPage }}
  {{/* Get aggregated content using the content aggregator */}}
  {{ $aggregatedContent := partial "schema/utils/content-aggregator.html" . }}
  {{ $effectiveContent := $aggregatedContent.content }}
  {{ $effectiveWordCount := $aggregatedContent.wordCount }}

  {{/* Enhanced date handling with fallbacks */}}
  {{ $publishDate := .Date }}
  {{ $modifiedDate := or .Lastmod .Date }}

  {{/* Handle invalid/zero dates with fallbacks */}}
  {{ if or (not $publishDate) (eq ($publishDate.Format "2006-01-02") "0001-01-01") }}
    {{ if and .GitInfo .GitInfo.AuthorDate }}
      {{ $publishDate = .GitInfo.AuthorDate }}
    {{ else }}
      {{ $publishDate = now }}
    {{ end }}
  {{ end }}

  {{ if or (not $modifiedDate) (eq ($modifiedDate.Format "2006-01-02") "0001-01-01") }}
    {{ if and .GitInfo .GitInfo.AuthorDate }}
      {{ $modifiedDate = .GitInfo.AuthorDate }}
    {{ else }}
      {{ $modifiedDate = $publishDate }}
    {{ end }}
  {{ end }}

  {{/* Handle image */}}
  {{ $image := .Params.meta_image | default "/logos/brand/og-default.png" }}
  {{ if not (hasPrefix $image "http") }}
    {{ if in "blog templates" .Section }}
      {{ with .Resources.GetMatch .Params.meta_image }}
        {{ $image = .Permalink }}
      {{ end }}
    {{ else }}
      {{ $image = printf "https://www.pulumi.com%s" $image }}
    {{ end }}
  {{ end }}

  {{/* Build schema */}}
  {{ $schema := dict
    "@context" "https://schema.org"
    "@type" "BlogPosting"
    "@id" (printf "%s#article" .Permalink)
    "headline" (or .Params.h1 .Title)
    "description" (or .Params.meta_desc .Summary)
    "datePublished" ($publishDate.Format "2006-01-02T15:04:05Z07:00")
    "dateModified" ($modifiedDate.Format "2006-01-02T15:04:05Z07:00")
    "mainEntityOfPage" (dict
      "@type" "WebPage"
      "@id" .Permalink
    )
    "image" $image
    "url" .Permalink
    "wordCount" $effectiveWordCount
    "articleSection" "Engineering Blog"
    "inLanguage" "en-US"
    "publisher" (dict
      "@type" "Organization"
      "@id" "https://www.pulumi.com/#organization"
      "name" "Pulumi"
      "logo" (dict
        "@type" "ImageObject"
        "url" "https://www.pulumi.com/logos/brand/logo.png"
      )
    )
  }}

  {{/* Get enhanced author entities with knowledge graph properties */}}
  {{ $authors := partial "schema/utils/author-entities.html" . }}
  
  {{ if $authors }}
    {{ $schema = merge $schema (dict "author" $authors) }}
  {{ else }}
    {{ $schema = merge $schema (dict "author" (dict
      "@type" "Organization"
      "@id" "https://www.pulumi.com/#organization"
    )) }}
  {{ end }}

  {{/* Add tags as keywords */}}
  {{ with .Params.tags }}
    {{ $schema = merge $schema (dict "keywords" (delimit . ", ")) }}
  {{ end }}

  {{/* AI Enhancement: Add speakable specification */}}
  {{ $schema = merge $schema (dict "speakable" (dict
    "@type" "SpeakableSpecification"
    "cssSelector" (slice "article h1" "article h2" "article p:first-of-type")
  )) }}

  {{/* AI Enhancement: Add articleBody for context */}}
  {{ $content := $effectiveContent | plainify | truncate 5000 }}
  {{ $schema = merge $schema (dict "articleBody" $content) }}

  {{/* AI Enhancement: Add about and mentions */}}
  {{ $schema = merge $schema (dict "about" (dict
    "@type" "Thing"
    "name" "Infrastructure as Code"
    "@id" "https://www.pulumi.com/#pulumi-cli"
  )) }}

  {{/* Get technology entities with Wikipedia/Wikidata links */}}
  {{ $mentions := partial "schema/utils/technology-entities.html" . }}
  
  {{/* Detect cloud providers */}}
  {{ $cloudProviders := partial "schema/utils/cloud-provider-detector.html" . }}
  
  {{/* Extract cloud resource types and services */}}
  {{ $cloudResources := partial "schema/utils/resource-type-extractor.html" . }}
  
  {{/* Detect infrastructure patterns */}}
  {{ $infraPatterns := partial "schema/utils/infrastructure-patterns.html" . }}
  
  {{/* Combine all mentions and deduplicate */}}
  {{ $allMentions := $mentions }}
  {{ if $cloudResources.cloudServices }}
    {{ $allMentions = $allMentions | append $cloudResources.cloudServices }}
  {{ end }}
  {{ if $infraPatterns }}
    {{ $allMentions = $allMentions | append $infraPatterns }}
  {{ end }}
  
  {{/* Deduplicate mentions by @id or name */}}
  {{ if $allMentions }}
    {{ $mentionIds := slice }}
    {{ $uniqueMentions := slice }}
    {{ range $allMentions }}
      {{ $identifier := or (index . "@id") .name }}
      {{ if not (in $mentionIds $identifier) }}
        {{ $uniqueMentions = $uniqueMentions | append . }}
        {{ $mentionIds = $mentionIds | append $identifier }}
      {{ end }}
    {{ end }}
    {{ if $uniqueMentions }}
      {{ $schema = merge $schema (dict "mentions" $uniqueMentions) }}
    {{ end }}
  {{ end }}

  {{/* Get related content relationships */}}
  {{ $relatedContent := partial "schema/utils/related-content.html" . }}
  {{ if $relatedContent }}
    {{ $schema = merge $schema (dict "citation" $relatedContent) }}
  {{ end }}
  
  {{/* Cloud provider information now handled in mentions for semantic accuracy */}}
  
  {{/* Infrastructure patterns now handled in mentions section for semantic accuracy */}}
  
  {{/* Add software requirements based on detected packages */}}
  {{ $requirements := slice }}
  {{ if in .Content "@pulumi/aws" }}
    {{ $requirements = $requirements | append "@pulumi/aws" }}
  {{ end }}
  {{ if in .Content "@pulumi/azure" }}
    {{ $requirements = $requirements | append "@pulumi/azure" }}
  {{ end }}
  {{ if in .Content "@pulumi/gcp" }}
    {{ $requirements = $requirements | append "@pulumi/gcp" }}
  {{ end }}
  {{ if in .Content "@pulumi/kubernetes" }}
    {{ $requirements = $requirements | append "@pulumi/kubernetes" }}
  {{ end }}
  {{ if $requirements }}
    {{ $schema = merge $schema (dict "softwareRequirements" (delimit $requirements ", ")) }}
  {{ end }}

  {{/* Phase 4: Advanced Semantic Layer */}}
  
  {{/* Add discussionUrl if comments are enabled */}}
  {{ if .Params.comments }}
    {{ $schema = merge $schema (dict "discussionUrl" (printf "%s#comments" .Permalink)) }}
  {{ end }}
  
  {{/* Add potential actions for blog posts */}}
  {{ $actions := slice (dict
    "@type" "ReadAction"
    "target" .Permalink
    "name" "Read Article"
  ) }}
  
  {{ if .Params.github_url }}
    {{ $actions = $actions | append (dict
      "@type" "ViewAction"
      "target" .Params.github_url
      "name" "View Code on GitHub"
    ) }}
  {{ end }}
  
  {{ $schema = merge $schema (dict "potentialAction" $actions) }}
  
  {{/* Add work examples for technical blog posts */}}
  {{ if in .Content "```" }}
    {{ $examples := slice }}
    {{ if in .Content "pulumi new" }}
      {{ $examples = $examples | append (dict
        "@type" "HowToStep"
        "name" "Create Pulumi Project"
        "text" "Initialize a new Pulumi project"
        "tool" (dict "@id" "https://www.pulumi.com/#pulumi-cli")
      ) }}
    {{ end }}
    {{ if in .Content "pulumi up" }}
      {{ $examples = $examples | append (dict
        "@type" "HowToStep"
        "name" "Deploy Infrastructure"
        "text" "Deploy infrastructure using Pulumi"
        "tool" (dict "@id" "https://www.pulumi.com/#pulumi-cli")
      ) }}
    {{ end }}
    {{ if $examples }}
      {{ $schema = merge $schema (dict "step" $examples) }}
    {{ end }}
  {{ end }}
  
  {{/* Add isPartOf for blog series */}}
  {{ with .Params.series }}
    {{ $schema = merge $schema (dict "isPartOf" (dict
      "@type" "BlogPosting"
      "name" .
      "url" (printf "https://www.pulumi.com/blog/series/%s/" (urlize .))
    )) }}
  {{ end }}
  
  {{/* Add backstory/context for announcement posts */}}
  {{ if or (in .Title "Announcing") (in .Title "Introducing") }}
    {{ $schema = merge $schema (dict "backstory" (dict
      "@type" "CreativeWork"
      "name" "Product Development"
      "creator" (dict "@id" "https://www.pulumi.com/#organization")
    )) }}
  {{ end }}

  <script type="application/ld+json">
  {{ $schema | jsonify | safeJS }}
  </script>
{{ end }}