{{/* HowTo Schema for Step-by-Step Tutorials */}}

{{/* Only process if content has numbered steps */}}
{{ $hasNumberedSteps := false }}
{{ $steps := slice }}

{{/* Check for numbered list patterns (1. 2. 3. etc.) */}}
{{ $numberedSteps := findRE `(?m)^\d+\.\s+(.+)` .Content }}
{{ if ge (len $numberedSteps) 2 }}
  {{ $hasNumberedSteps = true }}

  {{/* Extract step content */}}
  {{ $contentLines := split .Content "\n" }}
  {{ $currentStep := dict }}
  {{ $stepText := "" }}
  {{ $stepNumber := 0 }}

  {{ range $contentLines }}
    {{ $line := . }}
    {{/* Check if this is a numbered step */}}
    {{ if findRE `^\d+\.\s+` $line }}
      {{/* Save previous step if exists */}}
      {{ if and $currentStep.name (ne $stepText "") }}
        {{ $currentStep = merge $currentStep (dict "text" ($stepText | plainify | chomp)) }}
        {{ $steps = $steps | append $currentStep }}
      {{ end }}

      {{/* Start new step */}}
      {{ $stepNumber = add $stepNumber 1 }}
      {{ $stepName := replaceRE `^\d+\.\s+(.+)` "$1" $line }}
      {{ $currentStep = dict "name" ($stepName | plainify | chomp) }}
      {{ $stepText = "" }}
    {{ else if $currentStep.name }}
      {{/* Accumulate text for current step */}}
      {{ if ne $line "" }}
        {{ $stepText = printf "%s %s" $stepText $line }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Add final step */}}
  {{ if and $currentStep.name (ne $stepText "") }}
    {{ $currentStep = merge $currentStep (dict "text" ($stepText | plainify | chomp)) }}
    {{ $steps = $steps | append $currentStep }}
  {{ end }}
{{ end }}

{{/* Alternative: Check for "Step 1", "Step 2" pattern */}}
{{ if not $hasNumberedSteps }}
  {{ $stepHeaders := findRE `(?i)(?:^|\n)(?:###?\s+)?Step\s+\d+[:\s]+(.+)` .Content }}
  {{ if ge (len $stepHeaders) 2 }}
    {{ $hasNumberedSteps = true }}

    {{/* Extract steps with this pattern */}}
    {{ range $stepHeaders }}
      {{ $stepName := replaceRE `(?i)(?:^|\n)(?:###?\s+)?Step\s+\d+[:\s]+(.+)` "$1" . }}
      {{ $steps = $steps | append (dict
        "name" ($stepName | plainify | chomp)
        "text" "Follow the instructions for this step"
      ) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Generate HowTo schema if we have valid steps */}}
{{ if and $hasNumberedSteps (ge (len $steps) 2) }}
  {{/* Build HowToStep array */}}
  {{ $howToSteps := slice }}
  {{ range $index, $step := $steps }}
    {{ $howToStep := dict
      "@type" "HowToStep"
      "name" $step.name
      "text" (or $step.text $step.name)
      "position" (add $index 1)
    }}

    {{/* Add URL if this is a link to another page */}}
    {{ if in $step.text "href=" }}
      {{ $url := replaceRE `.*href="([^"]+)".*` "$1" $step.text }}
      {{ if $url }}
        {{ $howToStep = merge $howToStep (dict "url" $url) }}
      {{ end }}
    {{ end }}

    {{ $howToSteps = $howToSteps | append $howToStep }}
  {{ end }}

  {{/* Determine total time based on content */}}
  {{ $totalTime := "" }}
  {{ if .Params.estimated_time }}
    {{ $totalTime = printf "PT%dM" .Params.estimated_time }}
  {{ else if .Params.duration }}
    {{ $totalTime = .Params.duration }}
  {{ else }}
    {{/* Estimate based on word count */}}
    {{ $words := .WordCount | default 500 }}
    {{ $minutes := div $words 200 }}
    {{ if lt $minutes 5 }}{{ $minutes = 5 }}{{ end }}
    {{ $totalTime = printf "PT%dM" $minutes }}
  {{ end }}

  {{/* Build main HowTo schema */}}
  {{ $schema := dict
    "@context" "https://schema.org"
    "@type" "HowTo"
    "@id" (printf "%s#howto" .Permalink)
    "name" (or .Params.howto_title .Title)
    "description" (or .Params.meta_desc .Summary (printf "How to %s" .Title))
    "step" $howToSteps
    "totalTime" $totalTime
    "tool" (slice)
  }}

  {{/* Add prerequisites/tools if specified */}}
  {{ $tools := slice }}

  {{/* Auto-detect common tools */}}
  {{ if in .Content "Pulumi CLI" }}
    {{ $tools = $tools | append (dict
      "@type" "HowToTool"
      "name" "Pulumi CLI"
    ) }}
  {{ end }}

  {{ if in .Content "AWS CLI" }}
    {{ $tools = $tools | append (dict
      "@type" "HowToTool"
      "name" "AWS CLI"
    ) }}
  {{ end }}

  {{ if or (in .Content "Node.js") (in .Content "npm") }}
    {{ $tools = $tools | append (dict
      "@type" "HowToTool"
      "name" "Node.js"
    ) }}
  {{ end }}

  {{ if in .Content "Python" }}
    {{ $tools = $tools | append (dict
      "@type" "HowToTool"
      "name" "Python"
    ) }}
  {{ end }}

  {{ if in .Content "Docker" }}
    {{ $tools = $tools | append (dict
      "@type" "HowToTool"
      "name" "Docker"
    ) }}
  {{ end }}

  {{/* Add tools if any detected */}}
  {{ if gt (len $tools) 0 }}
    {{ $schema = merge $schema (dict "tool" $tools) }}
  {{ end }}

  {{/* Add yield/result if specified */}}
  {{ with .Params.howto_result }}
    {{ $schema = merge $schema (dict "yield" .) }}
  {{ end }}

  {{/* Add image if available */}}
  {{ with or .Params.meta_image .Params.howto_image }}
    {{ $image := . }}
    {{ if not (hasPrefix $image "http") }}
      {{ $image = printf "https://www.pulumi.com%s" $image }}
    {{ end }}
    {{ $schema = merge $schema (dict "image" $image) }}
  {{ end }}

  <script type="application/ld+json">
  {{ $schema | jsonify | safeJS }}
  </script>
{{ end }}