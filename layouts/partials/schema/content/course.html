{{/* Course Schema for Tutorials - Required for Course rich results */}}

{{ if eq .Type "tutorials" }}
  {{/* Get aggregated content using the content aggregator */}}
  {{ $aggregatedContent := partial "schema/utils/content-aggregator.html" . }}
  {{ $effectiveContent := $aggregatedContent.content }}
  {{ $effectiveWordCount := $aggregatedContent.wordCount }}

  {{/* Enhanced date handling with fallbacks */}}
  {{ $publishDate := .Date }}
  {{ $modifiedDate := or .Lastmod .Date }}

  {{/* Handle invalid/zero dates with fallbacks */}}
  {{ if or (not $publishDate) (eq ($publishDate.Format "2006-01-02") "0001-01-01") }}
    {{ if and .GitInfo .GitInfo.AuthorDate }}
      {{ $publishDate = .GitInfo.AuthorDate }}
    {{ else }}
      {{ $publishDate = now }}
    {{ end }}
  {{ end }}

  {{ if or (not $modifiedDate) (eq ($modifiedDate.Format "2006-01-02") "0001-01-01") }}
    {{ if and .GitInfo .GitInfo.AuthorDate }}
      {{ $modifiedDate = .GitInfo.AuthorDate }}
    {{ else }}
      {{ $modifiedDate = $publishDate }}
    {{ end }}
  {{ end }}

  {{/* Get technology entities with Wikipedia/Wikidata links */}}
  {{ $techEntities := partial "schema/utils/technology-entities.html" . }}
  
  {{/* Get related content relationships */}}
  {{ $relatedContent := partial "schema/utils/related-content.html" . }}
  
  {{/* Detect cloud providers */}}
  {{ $cloudProviders := partial "schema/utils/cloud-provider-detector.html" . }}
  
  {{/* Extract cloud resource types and services */}}
  {{ $cloudResources := partial "schema/utils/resource-type-extractor.html" . }}
  
  {{/* Detect infrastructure patterns */}}
  {{ $infraPatterns := partial "schema/utils/infrastructure-patterns.html" . }}
  
  {{ $image := .Params.meta_image | default "/images/docs/meta-images/docs-meta.png" }}
  {{ if not (hasPrefix $image "http") }}
    {{ $image = printf "https://www.pulumi.com%s" $image }}
  {{ end }}

  {{/* Auto-detect what this tutorial teaches */}}
  {{ $teaches := slice }}
  {{ $titleLower := lower .Title }}
  {{ $content := $effectiveContent | plainify }}
  
  {{ if in $titleLower "aws" }}
    {{ $teaches = $teaches | append "AWS Infrastructure" }}
  {{ end }}
  {{ if in $titleLower "azure" }}
    {{ $teaches = $teaches | append "Azure Infrastructure" }}
  {{ end }}
  {{ if in $titleLower "gcp" }}
    {{ $teaches = $teaches | append "Google Cloud Infrastructure" }}
  {{ end }}
  {{ if in $titleLower "kubernetes" }}
    {{ $teaches = $teaches | append "Kubernetes Management" }}
  {{ end }}
  {{ if in $titleLower "import" }}
    {{ $teaches = $teaches | append "Infrastructure Import" }}
  {{ end }}
  {{ if in $titleLower "secret" }}
    {{ $teaches = $teaches | append "Secrets Management" }}
  {{ end }}
  {{ if in $titleLower "deployment" }}
    {{ $teaches = $teaches | append "Automated Deployments" }}
  {{ end }}
  {{ if in $titleLower "esc" }}
    {{ $teaches = $teaches | append "Pulumi ESC" }}
  {{ end }}
  
  {{/* Default if no specific topic detected */}}
  {{ if not $teaches }}
    {{ $teaches = slice "Infrastructure as Code" "Cloud Engineering" }}
  {{ end }}
  
  {{/* Override with frontmatter if provided */}}
  {{ with .Params.skills }}
    {{ $teaches = . }}
  {{ else }}
    {{ with .Params.teaches }}
      {{ $teaches = . }}
    {{ end }}
  {{ end }}

  {{/* Auto-detect prerequisites */}}
  {{ $prerequisites := slice }}
  {{ if or (in $content "Pulumi CLI") (in $content "pulumi new") }}
    {{ $prerequisites = $prerequisites | append "Pulumi CLI installed" }}
  {{ end }}
  {{ if in $content "AWS account" }}
    {{ $prerequisites = $prerequisites | append "AWS Account" }}
  {{ end }}
  {{ if in $content "Azure account" }}
    {{ $prerequisites = $prerequisites | append "Azure Account" }}
  {{ end }}
  {{ if in $content "Google Cloud account" }}
    {{ $prerequisites = $prerequisites | append "Google Cloud Account" }}
  {{ end }}
  
  {{/* Override with frontmatter if provided */}}
  {{ with .Params.prerequisites }}
    {{ $prerequisites = . }}
  {{ end }}

  {{/* Determine educational level */}}
  {{ $level := "Intermediate" }}
  {{ if or (in $titleLower "getting started") (in $titleLower "creating resources") }}
    {{ $level = "Beginner" }}
  {{ else if or (in $titleLower "advanced") (in $titleLower "drift") (in $titleLower "compliance") }}
    {{ $level = "Advanced" }}
  {{ end }}
  {{ with .Params.skill_level }}
    {{ $level = . }}
  {{ else }}
    {{ with .Params.educational_level }}
      {{ $level = . }}
    {{ end }}
  {{ end }}

  {{/* Estimate duration */}}
  {{ $duration := "PT1H" }}
  {{ with .Params.duration }}
    {{ $duration = . }}
  {{ else }}
    {{/* Estimate based on word count */}}
    {{ $readTime := div $effectiveWordCount 150 }}
    {{ if lt $readTime 30 }}{{ $readTime = 30 }}{{ end }}
    {{ if gt $readTime 120 }}{{ $readTime = 120 }}{{ end }}
    {{ $duration = printf "PT%dM" $readTime }}
  {{ end }}

  {{ $schema := dict
    "@context" "https://schema.org"
    "@type" "Course"
    "@id" (printf "%s#course" .Permalink)
    "name" .Title
    "description" (or .Params.meta_desc .Summary (printf "Learn %s with this hands-on Pulumi tutorial" .Title))
    "url" .Permalink
    "image" $image
    "datePublished" ($publishDate.Format "2006-01-02T15:04:05Z07:00")
    "dateModified" ($modifiedDate.Format "2006-01-02T15:04:05Z07:00")
    "provider" (dict
      "@type" "Organization"
      "@id" "https://www.pulumi.com/#organization"
      "name" "Pulumi"
    )
    "hasCourseInstance" (dict
      "@type" "CourseInstance"
      "courseMode" "online"
      "courseWorkload" $duration
      "instructor" (dict
        "@type" "Organization"
        "@id" "https://www.pulumi.com/#organization"
      )
    )
    "educationalLevel" $level
    "inLanguage" "en-US"
    "teaches" $teaches
    "about" (dict
      "@type" "Thing"
      "name" "Infrastructure as Code"
    )
    "timeRequired" $duration
    "isAccessibleForFree" true
    "availableLanguage" (slice "en-US")
    "audience" (dict
      "@type" "Audience"
      "audienceType" "Developers"
    )
  }}

  {{/* Add prerequisites if any */}}
  {{ if $prerequisites }}
    {{ $schema = merge $schema (dict "coursePrerequisites" $prerequisites) }}
  {{ end }}

  {{/* Add keywords */}}
  {{ $keywords := printf "%s, infrastructure as code, pulumi tutorial" (delimit $teaches ", ") }}
  {{ with .Params.tags }}
    {{ $keywords = delimit . ", " }}
  {{ end }}
  {{ $schema = merge $schema (dict "keywords" $keywords) }}

  {{/* Add programming languages if detected */}}
  {{ $languages := slice }}
  {{ if or (in .Content "```typescript") (in .Content "```ts") }}
    {{ $languages = $languages | append "TypeScript" }}
  {{ end }}
  {{ if or (in .Content "```python") (in .Content "```py") }}
    {{ $languages = $languages | append "Python" }}
  {{ end }}
  {{ if in .Content "```go" }}
    {{ $languages = $languages | append "Go" }}
  {{ end }}
  {{ if in .Content "```csharp" }}
    {{ $languages = $languages | append "C#" }}
  {{ end }}
  {{ if in .Content "```yaml" }}
    {{ $languages = $languages | append "YAML" }}
  {{ end }}
  {{ if $languages }}
    {{ $schema = merge $schema (dict "programmingLanguage" $languages) }}
  {{ end }}

  {{/* Combine and deduplicate technology entity mentions */}}
  {{ $allMentions := $techEntities }}
  {{ if $cloudResources.cloudServices }}
    {{ $allMentions = $allMentions | append $cloudResources.cloudServices }}
  {{ end }}
  
  {{/* Deduplicate mentions by @id or name */}}
  {{ if $allMentions }}
    {{ $mentionIds := slice }}
    {{ $uniqueMentions := slice }}
    {{ range $allMentions }}
      {{ $identifier := or (index . "@id") .name }}
      {{ if not (in $mentionIds $identifier) }}
        {{ $uniqueMentions = $uniqueMentions | append . }}
        {{ $mentionIds = $mentionIds | append $identifier }}
      {{ end }}
    {{ end }}
    {{ if $uniqueMentions }}
      {{ $schema = merge $schema (dict "mentions" $uniqueMentions) }}
    {{ end }}
  {{ end }}

  {{/* Add related content for knowledge graph connections */}}
  {{ if $relatedContent }}
    {{ $schema = merge $schema (dict "relatedLink" $relatedContent) }}
  {{ end }}
  
  {{/* Add cloud provider as targetPlatform */}}
  {{ if $cloudProviders.primary }}
    {{ $schema = merge $schema (dict "targetPlatform" $cloudProviders.primary) }}
  {{ end }}
  
  {{/* Add infrastructure patterns as applicationCategory */}}
  {{ if $infraPatterns }}
    {{ $categories := slice }}
    {{ range $infraPatterns }}
      {{ $categories = $categories | append .name }}
    {{ end }}
    {{ $schema = merge $schema (dict "applicationCategory" $categories) }}
  {{ end }}
  
  {{/* Add software requirements based on detected packages */}}
  {{ $requirements := slice }}
  {{ if in .Content "@pulumi/aws" }}
    {{ $requirements = $requirements | append "@pulumi/aws" }}
  {{ end }}
  {{ if in .Content "@pulumi/azure" }}
    {{ $requirements = $requirements | append "@pulumi/azure" }}
  {{ end }}
  {{ if in .Content "@pulumi/gcp" }}
    {{ $requirements = $requirements | append "@pulumi/gcp" }}
  {{ end }}
  {{ if in .Content "@pulumi/kubernetes" }}
    {{ $requirements = $requirements | append "@pulumi/kubernetes" }}
  {{ end }}
  {{ if $requirements }}
    {{ $schema = merge $schema (dict "softwareRequirements" (delimit $requirements ", ")) }}
  {{ end }}
  
  {{/* Add Pulumi resource types if detected */}}
  {{ if $cloudResources.pulumiTypes }}
    {{ $schema = merge $schema (dict "additionalProperty" (dict
      "@type" "PropertyValue"
      "name" "pulumiResourceTypes"
      "value" $cloudResources.pulumiTypes
    )) }}
  {{ end }}

  <script type="application/ld+json">
  {{ $schema | jsonify | safeJS }}
  </script>
{{ end }}