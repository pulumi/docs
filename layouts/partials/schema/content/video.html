{{/* VideoObject Schema for Embedded YouTube Videos */}}

{{/* Detect YouTube embeds in content */}}
{{ $hasYouTube := false }}
{{ $videoIds := slice }}

{{/* Check for YouTube shortcode usage */}}
{{ if in .RawContent "{{< youtube" }}
  {{ $hasYouTube = true }}
  {{/* Extract video ID from shortcode */}}
  {{ $shortcodes := findRE `\{\{< youtube\s+"?([^"\s>]+)"?\s*>\}\}` .RawContent }}
  {{ range $shortcodes }}
    {{ $id := replaceRE `\{\{< youtube\s+"?([^"\s>]+)"?\s*>\}\}` "$1" . }}
    {{ $videoIds = $videoIds | append $id }}
  {{ end }}
{{ end }}

{{/* Check for YouTube iframe embeds */}}
{{ if in .Content "youtube.com/embed" }}
  {{ $hasYouTube = true }}
  {{/* Extract video IDs from iframe embeds */}}
  {{ $iframes := findRE `youtube\.com/embed/([^"?\s]+)` .Content }}
  {{ range $iframes }}
    {{ $id := replaceRE `youtube\.com/embed/([^"?\s]+)` "$1" . }}
    {{ $videoIds = $videoIds | append $id }}
  {{ end }}
{{ end }}

{{/* Generate VideoObject schema for each video */}}
{{ if and $hasYouTube (gt (len $videoIds) 0) }}
  {{/* Get publish date with fallback */}}
  {{ $publishDate := .Date }}
  {{ if or (not $publishDate) (eq ($publishDate.Format "2006-01-02") "0001-01-01") }}
    {{ if and .GitInfo .GitInfo.AuthorDate }}
      {{ $publishDate = .GitInfo.AuthorDate }}
    {{ else }}
      {{ $publishDate = now }}
    {{ end }}
  {{ end }}

  {{/* Generate schema for first video (primary video) */}}
  {{ $primaryVideoId := index $videoIds 0 }}
  {{ $videoTitle := .Title }}
  {{ $videoDescription := or .Params.meta_desc .Summary (printf "Video tutorial: %s" .Title) }}

  {{/* Generate thumbnail URL using YouTube's standard pattern */}}
  {{ $thumbnailUrl := printf "https://img.youtube.com/vi/%s/maxresdefault.jpg" $primaryVideoId }}
  {{ $embedUrl := printf "https://www.youtube.com/embed/%s" $primaryVideoId }}

  {{ $schema := dict
    "@context" "https://schema.org"
    "@type" "VideoObject"
    "@id" (printf "%s#video" .Permalink)
    "name" $videoTitle
    "description" $videoDescription
    "uploadDate" ($publishDate.Format "2006-01-02")
    "thumbnailUrl" $thumbnailUrl
    "embedUrl" $embedUrl
    "contentUrl" (printf "https://www.youtube.com/watch?v=%s" $primaryVideoId)
    "publisher" (dict "@id" "https://www.pulumi.com/#organization")
  }}

  {{/* Add duration if specified in frontmatter */}}
  {{ with .Params.video_duration }}
    {{ $schema = merge $schema (dict "duration" .) }}
  {{ end }}

  {{/* Add transcript if available */}}
  {{ with .Params.video_transcript }}
    {{ $schema = merge $schema (dict "transcript" .) }}
  {{ end }}

  {{/* Add interactionStatistic if view count is known */}}
  {{ with .Params.video_views }}
    {{ $schema = merge $schema (dict "interactionStatistic" (dict
      "@type" "InteractionCounter"
      "interactionType" "https://schema.org/WatchAction"
      "userInteractionCount" .
    )) }}
  {{ end }}

  <script type="application/ld+json">
  {{ $schema | jsonify | safeJS }}
  </script>

  {{/* Generate additional schemas for other videos if multiple exist */}}
  {{ if gt (len $videoIds) 1 }}
    {{ range $index, $videoId := (after 1 $videoIds) }}
      {{ $additionalSchema := dict
        "@context" "https://schema.org"
        "@type" "VideoObject"
        "@id" (printf "%s#video%d" $.Permalink (add $index 2))
        "name" (printf "%s - Video %d" $videoTitle (add $index 2))
        "description" $videoDescription
        "uploadDate" ($publishDate.Format "2006-01-02")
        "thumbnailUrl" (printf "https://img.youtube.com/vi/%s/maxresdefault.jpg" $videoId)
        "embedUrl" (printf "https://www.youtube.com/embed/%s" $videoId)
        "contentUrl" (printf "https://www.youtube.com/watch?v=%s" $videoId)
        "publisher" (dict "@id" "https://www.pulumi.com/#organization")
      }}

      <script type="application/ld+json">
      {{ $additionalSchema | jsonify | safeJS }}
      </script>
    {{ end }}
  {{ end }}
{{ end }}