{{/* Returns FAQPage entity for FAQ pages in @graph */}}

{{/* Initialize FAQ schema */}}
{{ $schema := dict
  "@type" "FAQPage"
  "@id" "#main-content"
  "url" .Permalink
  "name" (or .Params.title_tag .Title)
  "inLanguage" "en-US"
}}

{{/* Add description if available */}}
{{ with (or .Params.meta_desc .Summary) }}
  {{ $schema = merge $schema (dict "description" .) }}
{{ end }}

{{/* Extract Q&A pairs from content */}}
{{ $questions := slice }}
{{ $rawContent := .RawContent }}

{{/* Parse markdown content for questions and answers */}}
{{/* Questions are H3 headers or H2 headers ending with ?, answers are the content following them */}}
{{ $lines := split $rawContent "\n" }}
{{ $currentQuestion := "" }}
{{ $currentAnswer := slice }}
{{ $inQuestion := false }}

{{ range $index, $line := $lines }}
  {{/* Check if this is a question (H2 ending with ? or context-aware H3) */}}
  {{/* Context-aware H3 detection:
       - In FAQ pages (/faq in URL): All H3s are treated as questions
       - Elsewhere: H3 must end with ? to be a question */}}
  {{ $isH3Question := false }}
  {{ if strings.Contains (lower $.RelPermalink) "/faq" }}
    {{ $isH3Question = strings.HasPrefix $line "### " }}
  {{ else }}
    {{ $isH3Question = and (strings.HasPrefix $line "### ") (strings.HasSuffix (trim $line " \t\n\r") "?") }}
  {{ end }}
  {{ $isH2Question := and (strings.HasPrefix $line "## ") (strings.HasSuffix (trim $line " \t\n\r") "?") }}
  {{ if or $isH3Question $isH2Question }}
    {{/* Save previous Q&A if exists */}}
    {{ if and $currentQuestion (gt (len $currentAnswer) 0) }}
      {{ $answerText := trim (delimit $currentAnswer " " | replaceRE "\\s+" " ") " \t\n\r" }}
      {{ $questionText := $currentQuestion }}
      {{/* Remove the heading prefix */}}
      {{ if strings.HasPrefix $questionText "### " }}
        {{ $questionText = strings.TrimPrefix "### " $questionText }}
      {{ else if strings.HasPrefix $questionText "## " }}
        {{ $questionText = strings.TrimPrefix "## " $questionText }}
      {{ end }}
      {{ $questionText = trim $questionText " \t\n\r" }}

      {{/* Only add if both question and answer have actual content after trimming */}}
      {{ if and (gt (len $questionText) 0) (gt (len $answerText) 0) }}
        {{ $qa := dict
          "@type" "Question"
          "name" $questionText
          "acceptedAnswer" (dict
            "@type" "Answer"
            "text" $answerText
          )
        }}
        {{ $questions = $questions | append $qa }}
      {{ end }}
    {{ end }}
    {{/* Start new question */}}
    {{ $currentQuestion = $line }}
    {{ $currentAnswer = slice }}
    {{ $inQuestion = true }}
  {{ else if strings.HasPrefix $line "## " }}
    {{/* New section, save previous Q&A if exists */}}
    {{ if and $currentQuestion (gt (len $currentAnswer) 0) }}
      {{ $answerText := trim (delimit $currentAnswer " " | replaceRE "\\s+" " ") " \t\n\r" }}
      {{ $questionText := $currentQuestion }}
      {{/* Remove the heading prefix */}}
      {{ if strings.HasPrefix $questionText "### " }}
        {{ $questionText = strings.TrimPrefix "### " $questionText }}
      {{ else if strings.HasPrefix $questionText "## " }}
        {{ $questionText = strings.TrimPrefix "## " $questionText }}
      {{ end }}
      {{ $questionText = trim $questionText " \t\n\r" }}

      {{/* Only add if both question and answer have actual content after trimming */}}
      {{ if and (gt (len $questionText) 0) (gt (len $answerText) 0) }}
        {{ $qa := dict
          "@type" "Question"
          "name" $questionText
          "acceptedAnswer" (dict
            "@type" "Answer"
            "text" $answerText
          )
        }}
        {{ $questions = $questions | append $qa }}
      {{ end }}
    {{ end }}
    {{ $currentQuestion = "" }}
    {{ $currentAnswer = slice }}
    {{ $inQuestion = false }}
  {{ else if $inQuestion }}
    {{/* Add to current answer if we're in a question and line isn't empty */}}
    {{ $trimmedLine := trim $line " \t\n\r" }}
    {{ if $trimmedLine }}
      {{/* Skip markdown links to other FAQ sections */}}
      {{ if not (and (strings.Contains $trimmedLine "[") (strings.Contains $trimmedLine "/faq/")) }}
        {{ $currentAnswer = $currentAnswer | append $trimmedLine }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Save last Q&A if exists */}}
{{ if and $currentQuestion (gt (len $currentAnswer) 0) }}
  {{ $answerText := trim (delimit $currentAnswer " " | replaceRE "\\s+" " ") " \t\n\r" }}
  {{ $questionText := $currentQuestion }}
  {{/* Remove the heading prefix */}}
  {{ if strings.HasPrefix $questionText "### " }}
    {{ $questionText = strings.TrimPrefix "### " $questionText }}
  {{ else if strings.HasPrefix $questionText "## " }}
    {{ $questionText = strings.TrimPrefix "## " $questionText }}
  {{ end }}
  {{ $questionText = trim $questionText " \t\n\r" }}

  {{/* Only add if both question and answer have actual content after trimming */}}
  {{ if and (gt (len $questionText) 0) (gt (len $answerText) 0) }}
    {{ $qa := dict
      "@type" "Question"
      "name" $questionText
      "acceptedAnswer" (dict
        "@type" "Answer"
        "text" $answerText
      )
    }}
    {{ $questions = $questions | append $qa }}
  {{ end }}
{{ end }}

{{/* Only return FAQPage schema if we have questions */}}
{{ if $questions }}
  {{/* Add mainEntity with questions */}}
  {{ $schema = merge $schema (dict "mainEntity" $questions) }}

  {{/* Add publisher reference */}}
  {{ $schema = merge $schema (dict
    "publisher" (dict "@id" "https://www.pulumi.com/#organization")
  ) }}

  {{/* Add breadcrumb reference if it exists */}}
  {{ $schema = merge $schema (dict
    "breadcrumb" (dict "@id" (printf "%s#breadcrumb" .Permalink))
  ) }}
{{ else }}
  {{/* No questions found, don't generate FAQPage schema */}}
  {{ $schema = dict }}
{{ end }}

{{ return $schema }}