{{/* Returns HowTo entity for tutorials in @graph */}}

{{/* Get content for analysis */}}
{{ $content := .Content | plainify }}
{{ $wordCount := $content | countwords }}
{{ if not $wordCount }}
  {{ $wordCount = 500 }}
{{ end }}

{{/* Build HowTo entity */}}
{{ $schema := dict
  "@type" "HowTo"
  "@id" "#main-content"
  "name" .Title
  "url" .Permalink
  "inLanguage" "en-US"
}}

{{/* Add description */}}
{{ with (or .Params.meta_desc .Summary (printf "Learn how to %s with Pulumi" .Title)) }}
  {{ $schema = merge $schema (dict "description" .) }}
{{ end }}

{{/* Extract real steps from content */}}
{{ $steps := slice }}
{{ $rawContent := .RawContent }}
{{ $lines := split $rawContent "\n" }}

{{/* Look for numbered lists (1., 2., etc.) or step-like headers */}}
{{ $currentStep := dict }}
{{ $stepNumber := 0 }}
{{ $inNumberedList := false }}
{{ $stepText := slice }}

{{ range $index, $line := $lines }}
  {{/* Check for numbered list items */}}
  {{ if findRE `^\d+\.\s+` $line }}
    {{/* Save previous step if exists */}}
    {{ if and (gt $stepNumber 0) (gt (len $stepText) 0) }}
      {{ $stepContent := delimit $stepText " " | replaceRE "\\s+" " " | trim " \t\n\r" }}
      {{ if $stepContent }}
        {{ $step := dict
          "@type" "HowToStep"
          "position" $stepNumber
          "name" (printf "Step %d" $stepNumber)
          "text" $stepContent
        }}
        {{ $steps = $steps | append $step }}
      {{ end }}
    {{ end }}

    {{/* Start new step */}}
    {{ $stepNumber = add $stepNumber 1 }}
    {{ $stepText = slice (replaceRE `^\d+\.\s+` "" $line) }}
    {{ $inNumberedList = true }}

  {{ else if and $inNumberedList (not (eq $line "")) (not (strings.HasPrefix $line "#")) }}
    {{/* Continue current step if we're in a numbered list and line is not empty or a header */}}
    {{ if not (strings.HasPrefix $line "```") }}
      {{ $trimmedLine := trim $line " \t\n\r" }}
      {{ if $trimmedLine }}
        {{ $stepText = $stepText | append $trimmedLine }}
      {{ end }}
    {{ end }}

  {{ else if or (eq $line "") (strings.HasPrefix $line "#") }}
    {{/* End current step on empty line or new section */}}
    {{ if and (gt $stepNumber 0) (gt (len $stepText) 0) }}
      {{ $stepContent := delimit $stepText " " | replaceRE "\\s+" " " | trim " \t\n\r" }}
      {{ if $stepContent }}
        {{ $step := dict
          "@type" "HowToStep"
          "position" $stepNumber
          "name" (printf "Step %d" $stepNumber)
          "text" $stepContent
        }}
        {{ $steps = $steps | append $step }}
      {{ end }}
    {{ end }}

    {{/* Reset if we hit a header */}}
    {{ if strings.HasPrefix $line "#" }}
      {{ $inNumberedList = false }}
      {{ $stepText = slice }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Save last step if exists */}}
{{ if and (gt $stepNumber 0) (gt (len $stepText) 0) }}
  {{ $stepContent := delimit $stepText " " | replaceRE "\\s+" " " | trim " \t\n\r" }}
  {{ if $stepContent }}
    {{ $step := dict
      "@type" "HowToStep"
      "position" $stepNumber
      "name" (printf "Step %d" $stepNumber)
      "text" $stepContent
    }}
    {{ $steps = $steps | append $step }}
  {{ end }}
{{ end }}

{{/* Add steps to schema if we found any */}}
{{ if $steps }}
  {{ $schema = merge $schema (dict "step" $steps) }}
{{ end }}

{{/* Calculate total time */}}
{{ $totalTime := "" }}
{{ with .Params.estimated_time }}
  {{ $totalTime = printf "PT%dM" . }}
{{ else }}
  {{ with .Params.duration }}
    {{ $totalTime = . }}
  {{ else }}
    {{/* Estimate based on word count */}}
    {{ $minutes := div $wordCount 200 }}
    {{ if lt $minutes 10 }}{{ $minutes = 10 }}{{ end }}
    {{ if gt $minutes 60 }}{{ $minutes = 60 }}{{ end }}
    {{ $totalTime = printf "PT%dM" $minutes }}
  {{ end }}
{{ end }}
{{ $schema = merge $schema (dict "totalTime" $totalTime) }}

{{/* Add tools/prerequisites */}}
{{ $tools := slice }}

{{/* Auto-detect common tools */}}
{{ if or (in $content "Pulumi CLI") (in $content "pulumi new") }}
  {{ $tools = $tools | append (dict
    "@type" "HowToTool"
    "name" "Pulumi CLI"
  ) }}
{{ end }}

{{ if in $content "AWS account" }}
  {{ $tools = $tools | append (dict
    "@type" "HowToTool"
    "name" "AWS Account"
  ) }}
{{ end }}

{{ if in $content "Azure account" }}
  {{ $tools = $tools | append (dict
    "@type" "HowToTool"
    "name" "Azure Account"
  ) }}
{{ end }}

{{ if in $content "Google Cloud account" }}
  {{ $tools = $tools | append (dict
    "@type" "HowToTool"
    "name" "Google Cloud Account"
  ) }}
{{ end }}

{{ if or (in $content "Node.js") (in $content "npm") }}
  {{ $tools = $tools | append (dict
    "@type" "HowToTool"
    "name" "Node.js"
  ) }}
{{ end }}

{{ if in $content "Python" }}
  {{ $tools = $tools | append (dict
    "@type" "HowToTool"
    "name" "Python"
  ) }}
{{ end }}

{{ if $tools }}
  {{ $schema = merge $schema (dict "tool" $tools) }}
{{ end }}

{{/* Add image */}}
{{ $image := "" }}
{{ if .Params.meta_image }}
  {{/* Fix URL concatenation to avoid double slashes */}}
  {{ $baseURL := .Permalink }}
  {{ if not (strings.HasSuffix $baseURL "/") }}
    {{ $baseURL = printf "%s/" $baseURL }}
  {{ end }}
  {{ $imagePath := .Params.meta_image }}
  {{ if strings.HasPrefix $imagePath "/" }}
    {{ $imagePath = strings.TrimPrefix "/" $imagePath }}
  {{ end }}
  {{ $image = printf "%s%s" $baseURL $imagePath }}
{{ else }}
  {{ $image = "https://www.pulumi.com/images/docs/meta-images/docs-meta.png" }}
{{ end }}
{{ $schema = merge $schema (dict "image" $image) }}

{{/* Note: Dates omitted for tutorial pages - they're evergreen content without meaningful publication dates */}}

{{/* Add keywords */}}
{{ $keywords := "infrastructure as code, cloud, devops, tutorial, pulumi" }}
{{ with .Params.tags }}
  {{ $keywords = delimit . ", " }}
{{ end }}
{{ $schema = merge $schema (dict "keywords" $keywords) }}

{{/* Add supply/yield (what the tutorial produces) */}}
{{ $titleLower := lower .Title }}
{{ if in $titleLower "creating resources" }}
  {{ $schema = merge $schema (dict "yield" "Cloud infrastructure resources deployed and managed through code") }}
{{ else if in $titleLower "import" }}
  {{ $schema = merge $schema (dict "yield" "Existing infrastructure imported into Pulumi management") }}
{{ else }}
  {{ $schema = merge $schema (dict "yield" "Infrastructure deployed using Pulumi") }}
{{ end }}

{{ return $schema }}