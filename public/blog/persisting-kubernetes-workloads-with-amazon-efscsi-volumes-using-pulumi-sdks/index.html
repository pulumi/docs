<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
    <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="google-site-verification" content="j-Opn93zR4YQcV5bbYN99BmNc48BT5mzd2VpzKaW9YY" />

    

    
    <meta property="og:type" content="article">
    <meta property="og:url" content="/blog/persisting-kubernetes-workloads-with-amazon-efscsi-volumes-using-pulumi-sdks/">
    <meta property="og:site_name" content="pulumi">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@PulumiCorp">

    
        
            
            
                
                    <meta name="twitter:creator" content="@nishidavidson">
                
            
        
    

    
        <meta property="og:title" content="Persisting Kubernetes workloads with Amazon EFS CSI volumes using Pulumi open source SDKs">
    

    
        <meta name="description" content="The Amazon Elastic File System Container Storage Interface (CSI) Driver implements the CSI specification for container orchestrators to manage the lifecycle of Amazon EFS filesystems. The CSI specification defines an interface along with the minimum operational and packaging recommendations for a storage provider to implement a CSI compatible plugin. The interface declares the RPCs that a plugin must expose. The CSI drivers are the right mechanism to work with, when using a cloud storage component with Kubernetes workloads.">
        <meta property="og:description" content="The Amazon Elastic File System Container Storage Interface (CSI) Driver implements the CSI specification for container orchestrators to manage the lifecycle of Amazon EFS filesystems. The CSI specification defines an interface along with the minimum operational and packaging recommendations for a storage provider to implement a CSI compatible plugin. The interface declares the RPCs that a plugin must expose. The CSI drivers are the right mechanism to work with, when using a cloud storage component with Kubernetes workloads.">
    

    
    
        
            
        
    
    <meta property="og:image" content="/blog/persisting-kubernetes-workloads-with-amazon-efscsi-volumes-using-pulumi-sdks/featured-img-efs-csi-driver.png">

    <title>Persisting Kubernetes workloads with Amazon EFS CSI volumes using Pulumi open source SDKs - Pulumi</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    
    <link rel="canonical" href="https://www.pulumi.com/blog/persisting-kubernetes-workloads-with-amazon-efscsi-volumes-using-pulumi-sdks/" >

    
    <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Pulumi Blog" />

    
    
    
        
        
        
        <link rel="stylesheet" href="/css/styles.3496f5522ba2ee3f8bbb9a51ff2cb20fb6827ca85a8ae61de0a9f960bacf1023.css" integrity="sha256-NJb1Uiui7j&#43;Lu5pR/yyyD7aCfKhaiuYd4Kn5YLrPECM=">
    

    <script async defer src="https://buttons.github.io/buttons.js"></script>

    
    
        <script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function(event) {
                anchors.add("h1:not(.no-anchor), h2:not(.no-anchor), h3:not(.no-anchor), h4:not(.no-anchor), h5:not(.no-anchor), h6:not(.no-anchor)");
            });
        </script>
    

    
    
        
            
                
            
        
        
    
</head>

    <body class="section-blog">
        <nav class="bg-black text-white text-sm py-2 px-4 lg:px-0 transition-all max-h-screen md:max-h-full">
    <div class="container mx-auto">
        <ul class="flex justify-end items-center h-6">
            <li class="mr-8"><a href="https://slack.pulumi.io/" target="_blank">Slack</a></li>
            <li class="mr-8"><a href="https://github.com/pulumi" target="_blank">GitHub</a></li>
            <li class="mr-8"><a href="https://app.pulumi.com/" target="_blank">Console</a></li>
            <li class="github-widget">
                <a class="github-button" href="https://github.com/pulumi/pulumi" data-size="small" data-show-count="true" aria-label="Star pulumi/pulumi on GitHub">Star</a>
            </li>
        </ul>
    </div>
</nav>



<nav class="nav-main bg-purple-700 py-6 px-4 lg:px-0 border-t border-purple-500">
    <div class="container mx-auto">
        <header class="flex items-center justify-between flex-wrap md:flex-no-wrap">
            <div class="flex items-center flex-shrink-0 text-white lg:mr-6">
                <a class="block" href="/">
                    <img class="h-10 block" src="/images/logo/logo-inv.svg" alt="Pulumi logo">
                </a>
            </div>

            <div class="nav-header-toggle block md:hidden">
                <button class="flex items-center px-3 py-2 border rounded text-white border-purple-400 bg-purple-600">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <ul class="nav-header-items hidden w-full flex-grow md:flex md:items-center md:w-auto text-white text-sm md:text-xs lg:text-sm uppercase pt-4 md:pt-0">
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/product/" data-submenu="product" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Products
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/why-pulumi/" data-submenu="why" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Why Pulumi
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/pricing/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Pricing
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/docs/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Docs
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/blog/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded bg-purple-400 hover:bg-purple-400">
                            Blog
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/about/" data-submenu="about" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            About
                        </a>
                    </li>
                

                <li class="md:ml-auto md:mr-2 lg:mr-4">
                    <a class="block mt-4 md:mt-0 md:text-xs lg:text-sm btn btn-orange-translucent" href="https://app.pulumi.com/">Sign In</a>
                </li>
                <li>
                    <a class="block mt-4 md:mt-0 md:text-xs lg:text-sm btn" href="https://app.pulumi.com/signup">Sign Up</a>
                </li>
            </ul>
        </header>
    </div>
</nav>
<div class="submenu">
    <div class="text-white relative overflow-visible">
        <div class="submenu-item submenu-item-product hidden absolute inset-x-0 z-50 bg-purple-700 shadow-lg pt-8 pb-16">
            <div class="container mx-auto flex items-start">
                <div class="w-1/2 pr-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">The Pulumi Platform</h3>
                    <p class="text-white">
                        Cloud Apps and Infrastructure for any cloud using languages you already know and love.
                    </p>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-sdk">Pulumi SDK</a>
                            <span>&rarr; Cloud native infrastructure as code.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-crosswalk">Pulumi Crosswalk</a>
                            <span>&rarr; Productive infrastructure as code with built-in best practices.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-saas">Pulumi SaaS</a>
                            <span>&rarr; Continuously deliver and manage cloud software for any cloud.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#multi-cloud-subscription">Multi-Cloud Subscription</a>
                            <span>&rarr; End-to-end Kubernetes solutions to achieve multi-cloud.</span>
                        </li>
                    </ul>
                    <p>
                        <span class="text-white">Pulumi is open source, free to start, and has plans available for teams.</span>
                        <a class="text-orange-500 hover:text-orange-400 hover:mr-1 transition-all" href="/pricing/">View Pricing</a> &rarr;
                    </p>
                </div>
                <div class="w-1/2 pl-12 text-purple-100 text-sm">
                    <h3 class="text-white">Get Started</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/reference/install/">Install (Mac, Windows, Linux)</a> &rarr;
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/">Documentation and Examples</a> &rarr;
                        </li>
                    </ul>
                    <h3 class="text-white">Migrate to Pulumi</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/cloudformation/">from CloudFormation</a> &rarr;
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/terraform/">from Terraform</a> &rarr;
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="submenu-item submenu-item-why hidden absolute inset-x-0 z-50 bg-purple-700 shadow pt-8 pb-16">
           <div class="container mx-auto flex items-start">
                <div class="w-1/2 pr-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">Solutions for All Teams and Engineers</h3>
                    <p class="text-white">
                        Maximize cloud velocity for Dev, DevOps, and IT, no matter your team size.
                    </p>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-developers">For Developers</a>
                            <span>&rarr; Your favorite languages, tools, and libraries.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-operators">For DevOps and IT</a>
                            <span>&rarr; Empower your team to deliver to many clouds.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-business-leaders">For Business Leaders</a>
                            <span>&rarr; Modern multi-cloud for startups and enterprises.</span>
                        </li>
                    </ul>
                </div>
                <div class="w-1/4 px-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">Any Code</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/serverless/">Serverless</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/containers/">Containers</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/kubernetes/">Kubernetes</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/reference/tutorials/aws/tutorial-ec2-webserver/">Infrastructure</a>
                            <span>&rarr;</span>
                        </li>
                    </ul>
                </div>
                <div class="w-1/4 pl-12 text-purple-100 text-sm">
                    <h3 class="text-white">Migrate to Pulumi</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/aws/">AWS</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/azure/">Azure</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/gcp/">GCP</a>
                            <span>&rarr;</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


        
        

        <main>
            
    <div class="container mx-auto px-8 py-8 md:px-0">
        <div class="md:flex">
            <div class="md:w-3/12 pr-8">
                
<aside class="md:pr-8">

    
    <div class="md:hidden">
        <button class="blog-sidebar-toggle items-center px-3 py-2 border rounded text-purple border-purple">
            <i class="fas fa-bars"></i>
        </button>
        <a href="/blog/">üçπ Pulumi Blog</a>
    </div>

    <h3 class="no-anchor hidden md:flex mt-4">
        <a href="/blog/">üçπ Pulumi Blog</a>
    </h3>

    
    <div class="blog-sidebar-content hidden md:block">
        <div class="bg-gray-100 rounded-lg p-4 my-6 text-gray-700">
            <h5 class="no-anchor text-gray-700">Program the Cloud</h5>
            <p class="text-sm my-0">
                Create, deploy, and manage cloud infrastructure using your favorite language.
            </p>
        </div>

        <ul class="list-none p-0 mb-4 inline-flex flex-wrap text-xs">
            
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/apigateway/">
                            apigateway
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/applications/">
                            applications
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/auth/">
                            auth
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/aws/">
                            aws
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/azure/">
                            azure
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/ci/cd/">
                            ci/cd
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/cloud-native/">
                            cloud-native
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/containers/">
                            containers
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/customer/">
                            customer
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/digitalocean/">
                            digitalocean
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/docker/">
                            docker
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/eks/">
                            eks
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/events/">
                            events
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/features/">
                            features
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/gcp/">
                            gcp
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/gke/">
                            gke
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/infrastructure/">
                            infrastructure
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/javascript/">
                            javascript
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/jupyter/">
                            jupyter
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/kubernetes/">
                            kubernetes
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/lambda/">
                            lambda
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/logging/">
                            logging
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/mysql/">
                            mysql
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/new-features/">
                            new-features
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/pulumi/">
                            pulumi
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/pulumi-news/">
                            pulumi-news
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/python/">
                            python
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/security/">
                            security
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/serverless/">
                            serverless
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/testing/">
                            testing
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/typescript/">
                            typescript
                        </a>
                    </li>
                
            
        </ul>

        <div class="hidden lg:block my-4">
            <h5 class="no-anchor">Recent Posts</h5>
            <ul class="list-none p-0">
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/day-2-kubernetes-migrating-eks-nodegroups-with-zero-downtime/">Day 2 Kubernetes: Migrating EKS Node Groups with Zero Downtime</a>
                        </li>
                    
                
                    
                        
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/getting-started-on-digitalocean-with-pulumi/">Getting Started on DigitalOcean with Pulumi</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/pulumi-meetup-recap-apis-custom-resources-and-github-webhooks/">Pulumi Meetup Recap: APIs, Custom Resources and GitHub Webhooks</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/persisting-kubernetes-workloads-with-amazon-efscsi-volumes-using-pulumi-sdks/">Persisting Kubernetes workloads with Amazon EFS CSI volumes using Pulumi open source SDKs</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/unit-testing-infrastructure-in-nodejs-and-mocha/">Unit Testing Your Infrastructure with Node.js and Mocha</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/kubernetes-ingress-with-aws-alb-ingress-controller-and-pulumi-crosswalk/">Kubernetes Ingress with AWS ALB Ingress Controller and Pulumi Crosswalk for AWS</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/globally-distributed-serverless-application-in-100-lines-of-code-infrastructure-included/">Globally-distributed Serverless Application in 100 Lines of Code. Infrastructure Included!</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/hosting-a-static-website-on-azure-with-pulumi/">Hosting a Static Website on Azure with Pulumi</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/running-containers-in-aws-the-lowdown-ecs-fargate-and-eks/">Running Containers in AWS, the Lowdown: ECS, Fargate, and EKS</a>
                        </li>
                    
                
            </ul>
        </div>
    </div>

    <div class="md:hidden pb-4">
        
    </div>
</aside>

            </div>

            <div class="md:w-7/12">
                <article class="mb-8 pb-8 border-b border-gray-200">
                    <h1 class="no-anchor"><a href="/blog/persisting-kubernetes-workloads-with-amazon-efscsi-volumes-using-pulumi-sdks/">Persisting Kubernetes workloads with Amazon EFS CSI volumes using Pulumi open source SDKs</a></h1>
                    <div class="flex items-center">
                        <span>
                            <span class="flex items-center">
    
        
        

        <span class="flex items-center mr-2">
            
                <a class="rounded-full p-1 bg-gray-300 mr-2" href="/blog/author/nishi-davidson/">
                    <img class="w-8 rounded-full" src="/images/team/nishi-davidson.jpg" alt="Nishi Davidson" title="Nishi Davidson">
                </a>
                <a class="" href="/blog/author/nishi-davidson/">Nishi Davidson</a>
            
        </span>
    
</span>

                        </span>
                    </div>
                    <section>
                        

<p>The Amazon Elastic File System Container Storage Interface (CSI) Driver implements the <a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI specification</a> for container orchestrators to manage the lifecycle of Amazon EFS filesystems. The CSI specification defines an interface along with the minimum operational and packaging recommendations for a storage provider to implement a CSI compatible plugin. The interface declares the RPCs that a plugin must expose. The CSI drivers are the right mechanism to work with, when using a cloud storage component with Kubernetes workloads. Amazon Elastic File System (Amazon EFS) provides parallel shared access through a standard file system interface to Amazon EC2 instances and Linux-based workloads without disrupting your applications. EFS is a regional service storing data across multiple Availability Zones (AZs) for high availability and durability.</p>

<p>The <a href="https://github.com/kubernetes-sigs/aws-efs-csi-driver">AWS EFS CSI Driver</a> is a Kubernetes <a href="https://github.com/kubernetes/community/tree/master/sig-aws">SIG-AWS</a> subproject. The AWS EFS CSI Driver triggers the creation of out-of-tree CSI volume plugins in any Kubernetes cluster. Thereafter Kubernetes storage classes, persistent volumes and claims can be used by a Kubernetes workload to access the EFS CSI volume plugin as before.</p>

<p>In this blog, we will work through an example that shows how to use AWS EFS CSI storage components with Kubernetes workloads running on Amazon EKS worker nodes using Pulumi libraries (<a href="https://github.com/pulumi/pulumi-eks">EKS</a>, <a href="https://github.com/pulumi/pulumi-aws">AWS</a>, and <a href="https://github.com/pulumi/pulumi-awsx/tree/master/nodejs/awsx">AWSX</a>). These example steps are running on OS X.</p>

<h2 id="step-1-initialize-pulumi-project-and-stack-for-your-organization">Step 1: Initialize Pulumi Project and Stack for your organization:</h2>

<p><a href="/docs/quickstart/">Install Pulumi CLI</a> and set up your <a href="/docs/quickstart/aws/">AWS credentials</a>. Initialize a new <a href="/docs/reference/project/">Pulumi project</a> from available templates. We use <code>aws-typescript</code> template here to install all library dependencies.</p>

<p>We will work with two Pulumi stacks in this example, one for the Amazon EKS cluster and AWS EFS CSI components caled k8sinfra. The other for the application and its storage class, persistent volume and persistent volume claim called app. The AWS EFS CSI (Container Storage Interface) is based on the initial <a href="https://github.com/kubernetes-sigs/aws-efs-csi-driver/">AWS EFS CSI Driver</a> work done by Kubernetes <a href="https://github.com/kubernetes/community/tree/master/sig-aws">SIG-AWS</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ brew install pulumi <span class="c1"># download Pulumi CLI</span>

$ mkdir k8sinfra <span class="o">&amp;&amp;</span> <span class="nb">cd</span> k8sinfra

$ pulumi new aws-typescript

$ npm install --save @pulumi/kubernetes @pulumi/eks

$ ls -la
drwxr-xr-x   <span class="m">10</span> nishidavidson  staff    <span class="m">320</span> Jun <span class="m">18</span> <span class="m">18</span>:22 .
drwxr-xr-x+ <span class="m">102</span> nishidavidson  staff   <span class="m">3264</span> Jun <span class="m">18</span> <span class="m">18</span>:13 ..
-rw-------    <span class="m">1</span> nishidavidson  staff     <span class="m">21</span> Jun <span class="m">18</span> <span class="m">18</span>:22 .gitignore
-rw-r--r--    <span class="m">1</span> nishidavidson  staff     <span class="m">32</span> Jun <span class="m">18</span> <span class="m">18</span>:22 Pulumi.dev.yaml
-rw-------    <span class="m">1</span> nishidavidson  staff     <span class="m">91</span> Jun <span class="m">18</span> <span class="m">18</span>:22 Pulumi.yaml
-rw-------    <span class="m">1</span> nishidavidson  staff    <span class="m">273</span> Jun <span class="m">18</span> <span class="m">18</span>:22 index.ts
drwxr-xr-x   <span class="m">95</span> nishidavidson  staff   <span class="m">3040</span> Jun <span class="m">18</span> <span class="m">18</span>:22 node_modules
-rw-r--r--    <span class="m">1</span> nishidavidson  staff  <span class="m">50650</span> Jun <span class="m">18</span> <span class="m">18</span>:22 package-lock.json
-rw-------    <span class="m">1</span> nishidavidson  staff    <span class="m">228</span> Jun <span class="m">18</span> <span class="m">18</span>:22 package.json
-rw-------    <span class="m">1</span> nishidavidson  staff    <span class="m">522</span> Jun <span class="m">18</span> <span class="m">18</span>:22 tsconfig.json</code></pre></div>
<h2 id="step-2-create-the-eks-cluster-efs-endpoint-and-mounttargets">Step 2: Create the EKS cluster, EFS endpoint and MountTargets:</h2>

<p>The code below first declares an EKS cluster attached to two public subnets in a new VPC. We then declare EFS endpoint and mount the same to both subnets so the the EKS worker nodes can access the filesystem. This code should be pasted into <code>index.ts</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">aws</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">awsx</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/awsx&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">eks</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/eks&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">k8s</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/kubernetes&#34;</span><span class="p">;</span>

<span class="c1">//* STEP 1: Create an EKS cluster, an EFS endpoint and mount the EFS endpoint in each public subnet of the EKS cluster
</span><span class="c1"></span>
<span class="c1">// Create an EKS Cluster
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">vpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">awsx</span><span class="p">.</span><span class="nx">Network</span><span class="p">(</span><span class="s2">&#34;vpc&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">usePrivateSubnets</span>: <span class="kt">false</span> <span class="p">});</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">eks</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="s2">&#34;eks-cluster&#34;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">vpcId</span>: <span class="kt">vpc.vpcId</span><span class="p">,</span>
  <span class="nx">subnetIds</span>: <span class="kt">vpc.publicSubnetIds</span><span class="p">,</span>
  <span class="nx">instanceType</span><span class="o">:</span> <span class="s2">&#34;t2.medium&#34;</span><span class="p">,</span>
  <span class="nx">version</span><span class="o">:</span> <span class="s2">&#34;1.12&#34;</span><span class="p">,</span>
  <span class="nx">nodeRootVolumeSize</span>: <span class="kt">200</span><span class="p">,</span>
  <span class="nx">desiredCapacity</span>: <span class="kt">2</span><span class="p">,</span>
  <span class="nx">maxSize</span>: <span class="kt">3</span><span class="p">,</span>
  <span class="nx">minSize</span>: <span class="kt">2</span><span class="p">,</span>
  <span class="nx">deployDashboard</span>: <span class="kt">true</span><span class="p">,</span>
  <span class="nx">vpcCniOptions</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">warmIpTarget</span>: <span class="kt">4</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">nodeSecurityGroup</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">nodeSecurityGroup</span><span class="p">;</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">nodesubnetIds</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">subnetIds</span><span class="p">;</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">clusterName</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">eksCluster</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">kubeconfig</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">kubeconfig</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">);</span>

<span class="c1">// Create an EFS endpoint
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">efsFilesystem</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">efs</span><span class="p">.</span><span class="nx">FileSystem</span><span class="p">(</span><span class="s2">&#34;MyEFS&#34;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">tags</span><span class="o">:</span> <span class="p">{</span> <span class="nx">Name</span><span class="o">:</span> <span class="s2">&#34;myEFS&#34;</span> <span class="p">}</span>
<span class="p">});</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">efsFilesystemId</span> <span class="o">=</span> <span class="nx">efsFilesystem</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="c1">// Create a mounttarget in each of the EKS cluster VPC&#39;s AZs so that EC2 instances across the VPC can access the filesystem
</span><span class="c1"></span><span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">efs</span><span class="p">.</span><span class="nx">MountTarget</span><span class="p">(</span><span class="s2">&#34;MyEFS-MountTarget1&#34;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">fileSystemId</span>: <span class="kt">efsFilesystemId</span><span class="p">,</span>
  <span class="nx">securityGroups</span><span class="o">:</span> <span class="p">[</span><span class="nx">nodeSecurityGroup</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span>
  <span class="nx">subnetId</span>: <span class="kt">nodesubnetIds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">});</span>

<span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">efs</span><span class="p">.</span><span class="nx">MountTarget</span><span class="p">(</span><span class="s2">&#34;MyEFS-MountTarget2&#34;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">fileSystemId</span>: <span class="kt">efsFilesystemId</span><span class="p">,</span>
  <span class="nx">securityGroups</span><span class="o">:</span> <span class="p">[</span><span class="nx">nodeSecurityGroup</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span>
  <span class="nx">subnetId</span>: <span class="kt">nodesubnetIds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">});</span></code></pre></div>
<h2 id="step-3-create-the-csi-driver-node-and-controller-components">Step 3: Create the CSI Driver Node and Controller Components</h2>

<p>Currently, only static provisioning for AWS EFS CSI drivers is supported by SIG-AWS, which implies the Amazon EFS filesystem needs to be manually created first. After that it can be mounted inside a container as a volume using the driver. The code below will allow you to deploy allow the CSI Driver components on the Amazon EKS cluster.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">//* STEP 3: Install EFS CSI Driver Node and Controller components
</span><span class="c1"></span>
<span class="c1">// Install EFS CSI Driver node components
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">svcacntcsiNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ServiceAccount</span><span class="p">(</span>
  <span class="s2">&#34;csi-node-sa&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-node-sa&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;kube-system&#34;</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">cluster.provider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">clusterolecsiNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">rbac</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ClusterRole</span><span class="p">(</span>
  <span class="s2">&#34;csi-node&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-node&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;default&#34;</span> <span class="p">},</span>
    <span class="nx">rules</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;secrets&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;nodes&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;update&#34;</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;namespaces&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;persistentvolumes&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;watch&#34;</span><span class="p">,</span> <span class="s2">&#34;update&#34;</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;storage.k8s.io&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;volumeattachments&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;watch&#34;</span><span class="p">,</span> <span class="s2">&#34;update&#34;</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;csi.storage.k8s.io&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;csinodeinfos&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;watch&#34;</span><span class="p">,</span> <span class="s2">&#34;update&#34;</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">cluster.provider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">clusterolebindingcsiNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">rbac</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ClusterRoleBinding</span><span class="p">(</span>
  <span class="s2">&#34;csi-node&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-node&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;default&#34;</span> <span class="p">},</span>
    <span class="nx">subjects</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;ServiceAccount&#34;</span><span class="p">,</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-node-sa&#34;</span><span class="p">,</span>
        <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;kube-system&#34;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nx">roleRef</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;ClusterRole&#34;</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-node&#34;</span><span class="p">,</span>
      <span class="nx">apiGroup</span><span class="o">:</span> <span class="s2">&#34;rbac.authorization.k8s.io&#34;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">cluster.provider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">daemonsetcsiNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">v1beta2</span><span class="p">.</span><span class="nx">DaemonSet</span><span class="p">(</span>
  <span class="s2">&#34;efs-csi-node&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;efs-csi-node&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;kube-system&#34;</span> <span class="p">},</span>
    <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">selector</span><span class="o">:</span> <span class="p">{</span> <span class="nx">matchLabels</span><span class="o">:</span> <span class="p">{</span> <span class="nx">app</span><span class="o">:</span> <span class="s2">&#34;efs-csi-node&#34;</span> <span class="p">}</span> <span class="p">},</span>
      <span class="nx">template</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">labels</span><span class="o">:</span> <span class="p">{</span> <span class="nx">app</span><span class="o">:</span> <span class="s2">&#34;efs-csi-node&#34;</span> <span class="p">}</span> <span class="p">},</span>
        <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">serviceAccount</span><span class="o">:</span> <span class="s2">&#34;csi-node-sa&#34;</span><span class="p">,</span>
          <span class="nx">hostNetwork</span>: <span class="kt">true</span><span class="p">,</span>
          <span class="nx">containers</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;efs-plugin&#34;</span><span class="p">,</span>
              <span class="nx">securityContext</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">privileged</span>: <span class="kt">true</span>
              <span class="p">},</span>
              <span class="nx">image</span><span class="o">:</span> <span class="s2">&#34;amazon/aws-efs-csi-driver:latest&#34;</span><span class="p">,</span>
              <span class="nx">imagePullPolicy</span><span class="o">:</span> <span class="s2">&#34;Always&#34;</span><span class="p">,</span>
              <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;--endpoint=$(CSI_ENDPOINT)&#34;</span><span class="p">,</span> <span class="s2">&#34;--logtostderr&#34;</span><span class="p">,</span> <span class="s2">&#34;--v=5&#34;</span><span class="p">],</span>
              <span class="nx">env</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;CSI_ENDPOINT&#34;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&#34;unix:/csi/csi.sock&#34;</span> <span class="p">}],</span>
              <span class="nx">volumeMounts</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;kubelet-dir&#34;</span><span class="p">,</span>
                  <span class="nx">mountPath</span><span class="o">:</span> <span class="s2">&#34;/var/lib/kubelet&#34;</span><span class="p">,</span>
                  <span class="nx">mountPropagation</span><span class="o">:</span> <span class="s2">&#34;Bidirectional&#34;</span>
                <span class="p">},</span>
                <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;plugin-dir&#34;</span><span class="p">,</span> <span class="nx">mountPath</span><span class="o">:</span> <span class="s2">&#34;/csi&#34;</span> <span class="p">},</span>
                <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;device-dir&#34;</span><span class="p">,</span> <span class="nx">mountPath</span><span class="o">:</span> <span class="s2">&#34;/dev&#34;</span> <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-driver-registrar&#34;</span><span class="p">,</span>
              <span class="nx">image</span><span class="o">:</span> <span class="s2">&#34;quay.io/k8scsi/driver-registrar:v0.4.2&#34;</span><span class="p">,</span>
              <span class="nx">imagePullPolicy</span><span class="o">:</span> <span class="s2">&#34;Always&#34;</span><span class="p">,</span>
              <span class="nx">args</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&#34;--csi-address=$(ADDRESS)&#34;</span><span class="p">,</span>
                <span class="s2">&#34;--mode=node-register&#34;</span><span class="p">,</span>
                <span class="s2">&#34;--driver-requires-attachment=true&#34;</span><span class="p">,</span>
                <span class="s2">&#34;--pod-info-mount-version=v1&#34;</span><span class="p">,</span>
                <span class="s2">&#34;--kubelet-registration-path=$(DRIVER_REG_SOCK_PATH)&#34;</span><span class="p">,</span>
                <span class="s2">&#34;--v=5&#34;</span>
              <span class="p">],</span>
              <span class="nx">env</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;ADDRESS&#34;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s2">&#34;/csi/csi.sock&#34;</span> <span class="p">},</span>
                <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;DRIVER_REG_SOCK_PATH&#34;</span><span class="p">,</span>
                  <span class="nx">value</span><span class="o">:</span> <span class="s2">&#34;/var/lib/kubelet/plugins/efs.csi.aws.com/csi.sock&#34;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;KUBE_NODE_NAME&#34;</span><span class="p">,</span>
                  <span class="nx">valueFrom</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fieldRef</span><span class="o">:</span> <span class="p">{</span> <span class="nx">fieldPath</span><span class="o">:</span> <span class="s2">&#34;spec.nodeName&#34;</span> <span class="p">}</span> <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="nx">volumeMounts</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;plugin-dir&#34;</span><span class="p">,</span> <span class="nx">mountPath</span><span class="o">:</span> <span class="s2">&#34;/csi&#34;</span> <span class="p">},</span>
                <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;registration-dir&#34;</span><span class="p">,</span> <span class="nx">mountPath</span><span class="o">:</span> <span class="s2">&#34;/registration&#34;</span> <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">],</span>
          <span class="nx">volumes</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;kubelet-dir&#34;</span><span class="p">,</span>
              <span class="nx">hostPath</span><span class="o">:</span> <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s2">&#34;/var/lib/kubelet&#34;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;Directory&#34;</span> <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;plugin-dir&#34;</span><span class="p">,</span>
              <span class="nx">hostPath</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">path</span><span class="o">:</span> <span class="s2">&#34;/var/lib/kubelet/plugins/efs.csi.aws.com/&#34;</span><span class="p">,</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;DirectoryOrCreate&#34;</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;registration-dir&#34;</span><span class="p">,</span>
              <span class="nx">hostPath</span><span class="o">:</span> <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s2">&#34;/var/lib/kubelet/plugins/&#34;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;Directory&#34;</span> <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;device-dir&#34;</span><span class="p">,</span>
              <span class="nx">hostPath</span><span class="o">:</span> <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s2">&#34;/dev&#34;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;Directory&#34;</span> <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">cluster.provider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Install EFS CSI Driver Controller components
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">svcacctcsiController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ServiceAccount</span><span class="p">(</span>
  <span class="s2">&#34;csi-controller-sa&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-controller-sa&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;kube-system&#34;</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">cluster.provider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">clusterrolecsiController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">rbac</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ClusterRole</span><span class="p">(</span>
  <span class="s2">&#34;external-attacher-role&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;external-attacher-role&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;default&#34;</span> <span class="p">},</span>
    <span class="nx">rules</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;persistentvolumes&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;watch&#34;</span><span class="p">,</span> <span class="s2">&#34;update&#34;</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;nodes&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;watch&#34;</span><span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;storage.k8s.io&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;volumeattachments&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span> <span class="s2">&#34;list&#34;</span><span class="p">,</span> <span class="s2">&#34;watch&#34;</span><span class="p">,</span> <span class="s2">&#34;update&#34;</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">cluster.provider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">clusterrolebindingcsiController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">rbac</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ClusterRoleBinding</span><span class="p">(</span>
  <span class="s2">&#34;csi-attacher-role&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-attacher-role&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;default&#34;</span> <span class="p">},</span>
    <span class="nx">subjects</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;ServiceAccount&#34;</span><span class="p">,</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-controller-sa&#34;</span><span class="p">,</span>
        <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;kube-system&#34;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nx">roleRef</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;ClusterRole&#34;</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;external-attacher-role&#34;</span><span class="p">,</span>
      <span class="nx">apiGroup</span><span class="o">:</span> <span class="s2">&#34;rbac.authorization.k8s.io&#34;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">cluster.provider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">statefulsetcsiController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">StatefulSet</span><span class="p">(</span>
  <span class="s2">&#34;efs-csi-controller&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;efs-csi-controller&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;kube-system&#34;</span> <span class="p">},</span>
    <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">serviceName</span><span class="o">:</span> <span class="s2">&#34;efs-csi-controller&#34;</span><span class="p">,</span>
      <span class="nx">replicas</span>: <span class="kt">1</span><span class="p">,</span>
      <span class="nx">template</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">labels</span><span class="o">:</span> <span class="p">{</span> <span class="nx">app</span><span class="o">:</span> <span class="s2">&#34;efs-csi-controller&#34;</span> <span class="p">}</span> <span class="p">},</span>
        <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">serviceAccount</span><span class="o">:</span> <span class="s2">&#34;csi-controller-sa&#34;</span><span class="p">,</span>
          <span class="nx">priorityClassName</span><span class="o">:</span> <span class="s2">&#34;system-cluster-critical&#34;</span><span class="p">,</span>
          <span class="nx">tolerations</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&#34;CriticalAddonsOnly&#34;</span><span class="p">,</span> <span class="nx">operator</span><span class="o">:</span> <span class="s2">&#34;Exists&#34;</span> <span class="p">}],</span>
          <span class="nx">containers</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;efs-plugin&#34;</span><span class="p">,</span>
              <span class="nx">image</span><span class="o">:</span> <span class="s2">&#34;amazon/aws-efs-csi-driver:latest&#34;</span><span class="p">,</span>
              <span class="nx">imagePullPolicy</span><span class="o">:</span> <span class="s2">&#34;Always&#34;</span><span class="p">,</span>
              <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;--endpoint=$(CSI_ENDPOINT)&#34;</span><span class="p">,</span> <span class="s2">&#34;--logtostderr&#34;</span><span class="p">,</span> <span class="s2">&#34;--v=5&#34;</span><span class="p">],</span>
              <span class="nx">env</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;CSI_ENDPOINT&#34;</span><span class="p">,</span>
                  <span class="nx">value</span><span class="o">:</span> <span class="s2">&#34;unix:///var/lib/csi/sockets/pluginproxy/csi.sock&#34;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="nx">volumeMounts</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;socket-dir&#34;</span><span class="p">,</span>
                  <span class="nx">mountPath</span><span class="o">:</span> <span class="s2">&#34;/var/lib/csi/sockets/pluginproxy/&#34;</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;csi-attacher&#34;</span><span class="p">,</span>
              <span class="nx">image</span><span class="o">:</span> <span class="s2">&#34;quay.io/k8scsi/csi-attacher:v0.4.2&#34;</span><span class="p">,</span>
              <span class="nx">imagePullPolicy</span><span class="o">:</span> <span class="s2">&#34;Always&#34;</span><span class="p">,</span>
              <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;--csi-address=$(ADDRESS)&#34;</span><span class="p">,</span> <span class="s2">&#34;--v=5&#34;</span><span class="p">],</span>
              <span class="nx">env</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;ADDRESS&#34;</span><span class="p">,</span>
                  <span class="nx">value</span><span class="o">:</span> <span class="s2">&#34;/var/lib/csi/sockets/pluginproxy/csi.sock&#34;</span>
                <span class="p">}</span>
              <span class="p">],</span>
              <span class="nx">volumeMounts</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;socket-dir&#34;</span><span class="p">,</span>
                  <span class="nx">mountPath</span><span class="o">:</span> <span class="s2">&#34;/var/lib/csi/sockets/pluginproxy/&#34;</span>
                <span class="p">}</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">],</span>
          <span class="nx">volumes</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;socket-dir&#34;</span><span class="p">,</span> <span class="nx">emptyDir</span><span class="o">:</span> <span class="p">{}</span> <span class="p">}]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">cluster.provider</span> <span class="p">}</span>
<span class="p">);</span></code></pre></div>
<h2 id="step-4-deploy-a-sample-app-with-the-efs-volume-mounts">Step 4: Deploy a sample app with the EFS volume mounts:</h2>

<p>Once the step above is complete, you will be ready to deploy your k8s sample application, storage class, persistent volume and persistent volume claim. Lets create a new stack for this called k8sapp as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ mkdir k8sapp <span class="o">&amp;&amp;</span> <span class="nb">cd</span> k8sapp

$ pulumi new typescript

$ npm install --save @pulumi/eks @pulumi/kubernetes</code></pre></div>
<p>Let&rsquo;s now declare the storage class, pv, pvc and application pod to complete our k8s application set-up for this example. We will update <code>index.ts</code> file again and run <code>pulumi up</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">k8s</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/kubernetes&#34;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">getStack</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">StackReference</span><span class="p">(</span><span class="sb">`d-nishi/k8sinfra/</span><span class="si">${</span><span class="nx">env</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">kubeconfig</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">getOutput</span><span class="p">(</span><span class="s2">&#34;kubeconfig&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">efsFilesystemId</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">getOutput</span><span class="p">(</span><span class="s2">&#34;efsFilesystemId&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">k8sProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">Provider</span><span class="p">(</span><span class="s2">&#34;cluster&#34;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">kubeconfig</span>: <span class="kt">kubeconfig</span>
<span class="p">});</span>

<span class="c1">//* STEP 5: Create a storage class, persistent volume and persistent volume claim
</span><span class="c1"></span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">storageclassEFS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">StorageClass</span><span class="p">(</span>
  <span class="s2">&#34;efs-sc&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;efs-sc&#34;</span> <span class="p">},</span>
    <span class="nx">provisioner</span><span class="o">:</span> <span class="s2">&#34;efs.csi.aws.com&#34;</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">k8sProvider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">pvEFS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">(</span>
  <span class="s2">&#34;efs-pv&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;efs-pv&#34;</span> <span class="p">},</span>
    <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">capacity</span><span class="o">:</span> <span class="p">{</span> <span class="nx">storage</span><span class="o">:</span> <span class="s2">&#34;5Gi&#34;</span> <span class="p">},</span>
      <span class="nx">volumeMode</span><span class="o">:</span> <span class="s2">&#34;Filesystem&#34;</span><span class="p">,</span>
      <span class="nx">accessModes</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;ReadWriteOnce&#34;</span><span class="p">],</span>
      <span class="nx">persistentVolumeReclaimPolicy</span><span class="o">:</span> <span class="s2">&#34;Recycle&#34;</span><span class="p">,</span>
      <span class="nx">storageClassName</span><span class="o">:</span> <span class="s2">&#34;efs-sc&#34;</span><span class="p">,</span>
      <span class="nx">csi</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">driver</span><span class="o">:</span> <span class="s2">&#34;efs.csi.aws.com&#34;</span><span class="p">,</span>
        <span class="nx">volumeHandle</span>: <span class="kt">efsFilesystemId</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">k8sProvider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="kr">const</span> <span class="nx">pvcEFS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolumeClaim</span><span class="p">(</span>
  <span class="s2">&#34;efs-claim&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;efs-claim&#34;</span> <span class="p">},</span>
    <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">accessModes</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;ReadWriteOnce&#34;</span><span class="p">],</span>
      <span class="nx">storageClassName</span><span class="o">:</span> <span class="s2">&#34;efs-sc&#34;</span><span class="p">,</span>
      <span class="nx">resources</span><span class="o">:</span> <span class="p">{</span> <span class="nx">requests</span><span class="o">:</span> <span class="p">{</span> <span class="nx">storage</span><span class="o">:</span> <span class="s2">&#34;5Gi&#34;</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">k8sProvider</span> <span class="p">}</span>
<span class="p">);</span>

<span class="c1">//* STEP 6: Mount the endpoint to pod in EKS cluster
</span><span class="c1"></span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">newPod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">(</span>
  <span class="s2">&#34;efs-app&#34;</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;efs-app&#34;</span> <span class="p">},</span>
    <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">containers</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;app&#34;</span><span class="p">,</span>
          <span class="nx">image</span><span class="o">:</span> <span class="s2">&#34;centos&#34;</span><span class="p">,</span>
          <span class="nx">command</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">],</span>
          <span class="nx">args</span><span class="o">:</span> <span class="p">[</span>
            <span class="s2">&#34;-c&#34;</span><span class="p">,</span>
            <span class="s2">&#34;while true; do echo $(date -u) &gt;&gt; /data/out.txt; sleep 5; done&#34;</span>
          <span class="p">],</span>
          <span class="nx">volumeMounts</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;persistent-storage&#34;</span><span class="p">,</span>
              <span class="nx">mountPath</span><span class="o">:</span> <span class="s2">&#34;/data&#34;</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">volumes</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;persistent-storage&#34;</span><span class="p">,</span>
          <span class="nx">persistentVolumeClaim</span><span class="o">:</span> <span class="p">{</span> <span class="nx">claimName</span><span class="o">:</span> <span class="s2">&#34;efs-claim&#34;</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">k8sProvider</span><span class="p">,</span> <span class="nx">dependsOn</span>: <span class="kt">pvcEFS</span> <span class="p">}</span>
<span class="p">);</span></code></pre></div>
<p>Verify the pod is running and that data is being written into the EFS filesystem using:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl <span class="nb">exec</span> -ti efs-app -- tail -f /data/out.txt
Mon Jul <span class="m">8</span> <span class="m">06</span>:12:00 UTC <span class="m">2019</span>
Mon Jul <span class="m">8</span> <span class="m">06</span>:12:05 UTC <span class="m">2019</span>
Mon Jul <span class="m">8</span> <span class="m">06</span>:12:10 UTC <span class="m">2019</span>
Mon Jul <span class="m">8</span> <span class="m">06</span>:12:15 UTC <span class="m">2019</span></code></pre></div>
<p>This brings us to the end of our solution with Pulumi and AWS EFS on Amazon EKS. For more examples, refer to Pulumi&rsquo;s open source repository <a href="https://github.com/pulumi/examples">here</a> or refer to my other <a href="https://www.pulumi.com/blog/author/nishi-davidson/">Kubernetes articles</a>.</p>

                    </section>
                    <div>
                        <p class="text-gray-500">Posted on <time>Monday, Jul 15, 2019</time>
                        
                        <ul class="m-0 p-0">
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/aws/">
                                    AWS
                                </a>
                            </li>
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/eks/">
                                    EKS
                                </a>
                            </li>
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/kubernetes/">
                                    Kubernetes
                                </a>
                            </li>
                            
                        </ul>
                        
                    </div>
                </article>
            </div>

            <div class="md:w-2/12 pl-8">
                
            </div>
        </div>
    </div>

        </main>

        <nav class="footer bg-purple-700 py-8 px-8 md:px-0">
    <div class="container mx-auto">
        <footer>
            <div class="md:flex items-top justify-between flex-wrap">

                <div class="mb-6 md:w-4/12">
                    <a class="block mt-2" href="/">
                        <img class="h-10 opacity-50" src="/images/logo/logo-white.svg" alt="Pulumi logo">
                    </a>
                    <a class="inline-block my-4 opacity-50 text-white text-lg" href="mailto:team@pulumi.com">team@pulumi.com</a>
                    <ul class="flex inline-items text-blue-300 text-2xl">
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://twitter.com/pulumicorp" target="_blank"><i class="fab fa-twitter"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://www.linkedin.com/company/pulumi/" target="_blank"><i class="fab fa-linkedin"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://github.com/pulumi/" target="_blank"><i class="fab fa-github"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://www.youtube.com/channel/UC2Dhyn4Ev52YSbcpfnfP0Mw" target="_blank"><i class="fab fa-youtube"></i></a></li>
                        <li><a class="hover:text-blue-200" href="https://slack.pulumi.io/" target="_blank"><i class="fab fa-slack-hash"></i></a></li>
                    </ul>
                </div>

                <div class="flex flex-wrap items-top md:w-8/12">
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/containers/">Containers</a></li>
                        <li class="mb-4"><a href="/serverless/">Serverless</a></li>
                        <li class="mb-4"><a href="/docs/reference/tutorials/aws/tutorial-ec2-webserver/">Infrastructure</a></li>
                        <li class="mb-4"><a href="/kubernetes/">Kubernetes</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/docs/reference/install/">Install</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/">Get Started</a></li>
                        <li class="mb-4"><a href="/docs/reference/">Documentation</a></li>
                        <li class="mb-4"><a href="/docs/reference/pkg/">APIs</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/docs/quickstart/aws/">AWS</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/azure/">Azure</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/gcp/">Google Cloud</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/kubernetes/">Kubernetes</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/cloudfx/">Cloud Framework</a></li>
                        <li class="mb-4"><a href="/docs/reference/clouds/openstack/">OpenStack</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/about/">About Us</a></li>
                        <li class="mb-4"><a href="/contact/">Contact Us</a></li>
                        <li class="mb-4"><a href="/support/">Support</a></li>
                        <li class="mb-4"><a href="/careers/">Careers</a></li>
                    </ul>
                </div>
            </div>

            <div class="text-white opacity-75 text-sm lg:flex items-center border-t border-purple-500 mt-4 pt-4">
                
                <p class="md:w-4/12">&copy; 2019 Pulumi. All rights reserved.</p>

                <ul class="md:w-8/12">
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/trademark/">Trademark Usage</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/acceptable-use/">Acceptable Use Policy</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/terms-and-conditions/">Terms &amp; Conditions</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/privacy/">Privacy Policy</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/professional-services-agreement/">Professional Services Agreement</a></li>
                    
                </ul>
            </div>
        </footer>
    </div>
</nav>

        <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>











    




<script src="/js/bundle.min.8d935315b94bf6e77843b9c51ebc10238af740294e751f49b183b5d1e27a1c27.js" integrity="sha256-jZNTFblL9ud4Q7nFHrwQI4r3QClOdR9JsYO10eJ6HCc="></script>

    </body>
</html>
