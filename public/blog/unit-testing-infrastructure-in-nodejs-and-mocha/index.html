<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
    <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="google-site-verification" content="j-Opn93zR4YQcV5bbYN99BmNc48BT5mzd2VpzKaW9YY" />

    

    
    <meta property="og:type" content="article">
    <meta property="og:url" content="/blog/unit-testing-infrastructure-in-nodejs-and-mocha/">
    <meta property="og:site_name" content="pulumi">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@PulumiCorp">

    
        
            
            
                
                    <meta name="twitter:creator" content="@funcOfJoe">
                
            
        
    

    
        <meta property="og:title" content="Unit Testing Your Infrastructure with Node.js and Mocha">
    

    
        <meta name="description" content="Testing your infrastructure using familiar tools like Node.js&rsquo;s Mocha
framework allows you to ensure configuration is correct before provisioning,
and that the resulting infrastructure has certain desirable properties
afterwards. This can enforce team standards, ensure security guidelines
are being followed, and so much more. Because Pulumi uses general purpose
languages, you can just embed tests alongside your infrastructure-as-code
definitions themselves, using a familiar authoring style and reporting
experience. In this post, we&rsquo;ll explore the ins and outs of unit testing
your infrastructure.">
        <meta property="og:description" content="Testing your infrastructure using familiar tools like Node.js&rsquo;s Mocha
framework allows you to ensure configuration is correct before provisioning,
and that the resulting infrastructure has certain desirable properties
afterwards. This can enforce team standards, ensure security guidelines
are being followed, and so much more. Because Pulumi uses general purpose
languages, you can just embed tests alongside your infrastructure-as-code
definitions themselves, using a familiar authoring style and reporting
experience. In this post, we&rsquo;ll explore the ins and outs of unit testing
your infrastructure.">
    

    
    
        
            
        
    
    <meta property="og:image" content="/blog/unit-testing-infrastructure-in-nodejs-and-mocha/meta.png">

    <title>Unit Testing Your Infrastructure with Node.js and Mocha - Pulumi</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    
    <link rel="canonical" href="https://www.pulumi.com/blog/unit-testing-infrastructure-in-nodejs-and-mocha/" >

    
    <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Pulumi Blog" />

    
    
    
        
        
        
        <link rel="stylesheet" href="/css/styles.3496f5522ba2ee3f8bbb9a51ff2cb20fb6827ca85a8ae61de0a9f960bacf1023.css" integrity="sha256-NJb1Uiui7j&#43;Lu5pR/yyyD7aCfKhaiuYd4Kn5YLrPECM=">
    

    <script async defer src="https://buttons.github.io/buttons.js"></script>

    
    
        <script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function(event) {
                anchors.add("h1:not(.no-anchor), h2:not(.no-anchor), h3:not(.no-anchor), h4:not(.no-anchor), h5:not(.no-anchor), h6:not(.no-anchor)");
            });
        </script>
    

    
    
        
            
                
            
        
        
    
</head>

    <body class="section-blog">
        <nav class="bg-black text-white text-sm py-2 px-4 lg:px-0 transition-all max-h-screen md:max-h-full">
    <div class="container mx-auto">
        <ul class="flex justify-end items-center h-6">
            <li class="mr-8"><a href="https://slack.pulumi.io/" target="_blank">Slack</a></li>
            <li class="mr-8"><a href="https://github.com/pulumi" target="_blank">GitHub</a></li>
            <li class="mr-8"><a href="https://app.pulumi.com/" target="_blank">Console</a></li>
            <li class="github-widget">
                <a class="github-button" href="https://github.com/pulumi/pulumi" data-size="small" data-show-count="true" aria-label="Star pulumi/pulumi on GitHub">Star</a>
            </li>
        </ul>
    </div>
</nav>



<nav class="nav-main bg-purple-700 py-6 px-4 lg:px-0 border-t border-purple-500">
    <div class="container mx-auto">
        <header class="flex items-center justify-between flex-wrap md:flex-no-wrap">
            <div class="flex items-center flex-shrink-0 text-white lg:mr-6">
                <a class="block" href="/">
                    <img class="h-10 block" src="/images/logo/logo-inv.svg" alt="Pulumi logo">
                </a>
            </div>

            <div class="nav-header-toggle block md:hidden">
                <button class="flex items-center px-3 py-2 border rounded text-white border-purple-400 bg-purple-600">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <ul class="nav-header-items hidden w-full flex-grow md:flex md:items-center md:w-auto text-white text-sm md:text-xs lg:text-sm uppercase pt-4 md:pt-0">
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/product/" data-submenu="product" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Products
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/why-pulumi/" data-submenu="why" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Why Pulumi
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/pricing/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Pricing
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/docs/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Docs
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/blog/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded bg-purple-400 hover:bg-purple-400">
                            Blog
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/about/" data-submenu="about" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            About
                        </a>
                    </li>
                

                <li class="md:ml-auto md:mr-2 lg:mr-4">
                    <a class="block mt-4 md:mt-0 md:text-xs lg:text-sm btn btn-orange-translucent" href="https://app.pulumi.com/">Sign In</a>
                </li>
                <li>
                    <a class="block mt-4 md:mt-0 md:text-xs lg:text-sm btn" href="https://app.pulumi.com/signup">Sign Up</a>
                </li>
            </ul>
        </header>
    </div>
</nav>
<div class="submenu">
    <div class="text-white relative overflow-visible">
        <div class="submenu-item submenu-item-product hidden absolute inset-x-0 z-50 bg-purple-700 shadow-lg pt-8 pb-16">
            <div class="container mx-auto flex items-start">
                <div class="w-1/2 pr-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">The Pulumi Platform</h3>
                    <p class="text-white">
                        Cloud Apps and Infrastructure for any cloud using languages you already know and love.
                    </p>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-sdk">Pulumi SDK</a>
                            <span>&rarr; Cloud native infrastructure as code.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-crosswalk">Pulumi Crosswalk</a>
                            <span>&rarr; Productive infrastructure as code with built-in best practices.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-saas">Pulumi SaaS</a>
                            <span>&rarr; Continuously deliver and manage cloud software for any cloud.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#multi-cloud-subscription">Multi-Cloud Subscription</a>
                            <span>&rarr; End-to-end Kubernetes solutions to achieve multi-cloud.</span>
                        </li>
                    </ul>
                    <p>
                        <span class="text-white">Pulumi is open source, free to start, and has plans available for teams.</span>
                        <a class="text-orange-500 hover:text-orange-400 hover:mr-1 transition-all" href="/pricing/">View Pricing</a> &rarr;
                    </p>
                </div>
                <div class="w-1/2 pl-12 text-purple-100 text-sm">
                    <h3 class="text-white">Get Started</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/reference/install/">Install (Mac, Windows, Linux)</a> &rarr;
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/">Documentation and Examples</a> &rarr;
                        </li>
                    </ul>
                    <h3 class="text-white">Migrate to Pulumi</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/cloudformation/">from CloudFormation</a> &rarr;
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/terraform/">from Terraform</a> &rarr;
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="submenu-item submenu-item-why hidden absolute inset-x-0 z-50 bg-purple-700 shadow pt-8 pb-16">
           <div class="container mx-auto flex items-start">
                <div class="w-1/2 pr-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">Solutions for All Teams and Engineers</h3>
                    <p class="text-white">
                        Maximize cloud velocity for Dev, DevOps, and IT, no matter your team size.
                    </p>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-developers">For Developers</a>
                            <span>&rarr; Your favorite languages, tools, and libraries.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-operators">For DevOps and IT</a>
                            <span>&rarr; Empower your team to deliver to many clouds.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-business-leaders">For Business Leaders</a>
                            <span>&rarr; Modern multi-cloud for startups and enterprises.</span>
                        </li>
                    </ul>
                </div>
                <div class="w-1/4 px-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">Any Code</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/serverless/">Serverless</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/containers/">Containers</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/kubernetes/">Kubernetes</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/reference/tutorials/aws/tutorial-ec2-webserver/">Infrastructure</a>
                            <span>&rarr;</span>
                        </li>
                    </ul>
                </div>
                <div class="w-1/4 pl-12 text-purple-100 text-sm">
                    <h3 class="text-white">Migrate to Pulumi</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/aws/">AWS</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/azure/">Azure</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/gcp/">GCP</a>
                            <span>&rarr;</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


        
        

        <main>
            
    <div class="container mx-auto px-8 py-8 md:px-0">
        <div class="md:flex">
            <div class="md:w-3/12 pr-8">
                
<aside class="md:pr-8">

    
    <div class="md:hidden">
        <button class="blog-sidebar-toggle items-center px-3 py-2 border rounded text-purple border-purple">
            <i class="fas fa-bars"></i>
        </button>
        <a href="/blog/">🍹 Pulumi Blog</a>
    </div>

    <h3 class="no-anchor hidden md:flex mt-4">
        <a href="/blog/">🍹 Pulumi Blog</a>
    </h3>

    
    <div class="blog-sidebar-content hidden md:block">
        <div class="bg-gray-100 rounded-lg p-4 my-6 text-gray-700">
            <h5 class="no-anchor text-gray-700">Program the Cloud</h5>
            <p class="text-sm my-0">
                Create, deploy, and manage cloud infrastructure using your favorite language.
            </p>
        </div>

        <ul class="list-none p-0 mb-4 inline-flex flex-wrap text-xs">
            
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/apigateway/">
                            apigateway
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/applications/">
                            applications
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/auth/">
                            auth
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/aws/">
                            aws
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/azure/">
                            azure
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/ci/cd/">
                            ci/cd
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/cloud-native/">
                            cloud-native
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/containers/">
                            containers
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/customer/">
                            customer
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/digitalocean/">
                            digitalocean
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/docker/">
                            docker
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/eks/">
                            eks
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/events/">
                            events
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/features/">
                            features
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/gcp/">
                            gcp
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/gke/">
                            gke
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/infrastructure/">
                            infrastructure
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/javascript/">
                            javascript
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/jupyter/">
                            jupyter
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/kubernetes/">
                            kubernetes
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/lambda/">
                            lambda
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/logging/">
                            logging
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/mysql/">
                            mysql
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/new-features/">
                            new-features
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/pulumi/">
                            pulumi
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/pulumi-news/">
                            pulumi-news
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/python/">
                            python
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/security/">
                            security
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/serverless/">
                            serverless
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/testing/">
                            testing
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/typescript/">
                            typescript
                        </a>
                    </li>
                
            
        </ul>

        <div class="hidden lg:block my-4">
            <h5 class="no-anchor">Recent Posts</h5>
            <ul class="list-none p-0">
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/day-2-kubernetes-migrating-eks-nodegroups-with-zero-downtime/">Day 2 Kubernetes: Migrating EKS Node Groups with Zero Downtime</a>
                        </li>
                    
                
                    
                        
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/getting-started-on-digitalocean-with-pulumi/">Getting Started on DigitalOcean with Pulumi</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/pulumi-meetup-recap-apis-custom-resources-and-github-webhooks/">Pulumi Meetup Recap: APIs, Custom Resources and GitHub Webhooks</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/persisting-kubernetes-workloads-with-amazon-efscsi-volumes-using-pulumi-sdks/">Persisting Kubernetes workloads with Amazon EFS CSI volumes using Pulumi open source SDKs</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/unit-testing-infrastructure-in-nodejs-and-mocha/">Unit Testing Your Infrastructure with Node.js and Mocha</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/kubernetes-ingress-with-aws-alb-ingress-controller-and-pulumi-crosswalk/">Kubernetes Ingress with AWS ALB Ingress Controller and Pulumi Crosswalk for AWS</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/globally-distributed-serverless-application-in-100-lines-of-code-infrastructure-included/">Globally-distributed Serverless Application in 100 Lines of Code. Infrastructure Included!</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/hosting-a-static-website-on-azure-with-pulumi/">Hosting a Static Website on Azure with Pulumi</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/running-containers-in-aws-the-lowdown-ecs-fargate-and-eks/">Running Containers in AWS, the Lowdown: ECS, Fargate, and EKS</a>
                        </li>
                    
                
            </ul>
        </div>
    </div>

    <div class="md:hidden pb-4">
        
    </div>
</aside>

            </div>

            <div class="md:w-7/12">
                <article class="mb-8 pb-8 border-b border-gray-200">
                    <h1 class="no-anchor"><a href="/blog/unit-testing-infrastructure-in-nodejs-and-mocha/">Unit Testing Your Infrastructure with Node.js and Mocha</a></h1>
                    <div class="flex items-center">
                        <span>
                            <span class="flex items-center">
    
        
        

        <span class="flex items-center mr-2">
            
                <a class="rounded-full p-1 bg-gray-300 mr-2" href="/blog/author/joe-duffy/">
                    <img class="w-8 rounded-full" src="/images/team/joe-duffy.jpg" alt="Joe Duffy" title="Joe Duffy">
                </a>
                <a class="" href="/blog/author/joe-duffy/">Joe Duffy</a>
            
        </span>
    
</span>

                        </span>
                    </div>
                    <section>
                        <p>Testing your infrastructure using familiar tools like Node.js&rsquo;s Mocha
framework allows you to ensure configuration is correct before provisioning,
and that the resulting infrastructure has certain desirable properties
afterwards. This can enforce team standards, ensure security guidelines
are being followed, and so much more. Because Pulumi uses general purpose
languages, you can just embed tests alongside your infrastructure-as-code
definitions themselves, using a familiar authoring style and reporting
experience. In this post, we&rsquo;ll explore the ins and outs of unit testing
your infrastructure.</p>

<h2 id="test-driven-infrastructure">Test-Driven Infrastructure</h2>

<p>We <a href="https://www.pulumi.com/blog/testing-your-infrastructure-as-code-with-pulumi/">previously explored many reasons and solutions</a> for
testing your infrastructure. In this post, we&rsquo;ll see a very simple approach that
leverages existing test tools and frameworks. For this blog post, we&rsquo;ll be using
Node.js with TypeScript, the Mocha test framework, and the Chai assertion library.</p>

<p>Our example will be testing two things about an Amazon EKS cluster; that it is</p>

<ol>
<li>Running Kubernetes version 1.13.</li>
<li>Provisioned inside a private VPC, rather than the default one.</li>
</ol>

<p>In true test-driven development (TDD) form, let&rsquo;s start with the tests themselves. If
you&rsquo;re familiar with Mocha and Chai, this should look like ordinary testing to you.
If you&rsquo;re not familiar with them, don&rsquo;t worry &ndash; they are quite easy to read and learn:
<a href="https://mochajs.org/">Mocha</a> and <a href="https://www.chaijs.com/">Chai</a>.</p>

<p>Here is the contents of our <code>tests/eks.spec.ts</code> test file:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">aws</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">expect</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;chai&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">promise</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;./&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">cluster</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;../&#34;</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s2">&#34;#Amazon EKS Cluster&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s2">&#34;Should use an approved Kubernetes version&#34;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">promise</span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">eksCluster</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">version</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">&#34;1.13&#34;</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">it</span><span class="p">(</span><span class="s2">&#34;Should be provisioned inside a custom, non-default VPC&#34;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">vpcId</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">promise</span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">vpcId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">vpcId</span><span class="p">)</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">defaultVpc</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">getVpc</span><span class="p">({</span> <span class="k">default</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">vpcId</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">defaultVpc</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pulumi</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">isDryRun</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">pulumi</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&#34;Skipped VPC ID check: not known during preview -- will test after apply&#34;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;VPC unknown during deployment&#34;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></div>
<p>This code does a few things worth describing. First, it imports all the packages
that we&rsquo;re going to use. Notably, this includes the normal Chai package for assertions,
the AWS and Pulumi SDK packages, the EKS cluster provisioned by this project itself,
and a utility function <code>promise</code> that we&rsquo;ll dive into momentarily. Then it simply uses
the Mocha functions <code>describe</code> and <code>it</code> to register test cases that will be run.</p>

<p>The version test fetches a property from our EKS cluster, <code>cluster.eksCluster.version</code>,
and then uses the Chai assertion <code>expect(version).to.equal(&quot;1.13&quot;)</code>. This will fail the
test if the version is anything but <code>1.13</code> (including if it is unknown).</p>

<p>The VPC test is slightly more complex. For the most part, it is simply checking the
<code>cluster.core.vpcId</code> property and ensuring it doesn&rsquo;t equal the default VPC ID, which
we fetch with <code>aws.ec2.getVpc</code>. However, because we might be creating the custom VPC in the
program itself, it&rsquo;s possible we won&rsquo;t know the ID during previews. (A <a href="https://www.pulumi.com/docs/reference/cli/pulumi_preview/">preview</a> is when
Pulumi shows you a dry-run of your deployment without actually doing it yet.) That&rsquo;s why
we check <code>pulumi.runtime.isDryRun</code> and let things slide, with a little warning message.
We could always be conservative and fail the test, but in this case, we&rsquo;ll actually permit the
deployment to proceed &ndash; but ensure we check it afterwards. This means we might fail the
test <em>after</em> the bad cluster has been deployed, but that&rsquo;s better than not checking at all.</p>

<h2 id="our-base-failing-program">Our Base (Failing) Program</h2>

<p>Here is the program we&rsquo;ll be testing. Keeping with our TDD theme, let&rsquo;s start with the
tests failing to begin with (we are using the default VPC and not specifying a version):</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">eks</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/eks&#34;</span><span class="p">;</span>

<span class="c1">// Create a basic EKS cluster.
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">eks</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="s2">&#34;my-cluster&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">desiredCapacity</span>: <span class="kt">2</span><span class="p">,</span>
    <span class="nx">minSize</span>: <span class="kt">1</span><span class="p">,</span>
    <span class="nx">maxSize</span>: <span class="kt">2</span><span class="p">,</span>
    <span class="nx">storageClasses</span><span class="o">:</span> <span class="s2">&#34;gp2&#34;</span><span class="p">,</span>
    <span class="nx">deployDashboard</span>: <span class="kt">false</span><span class="p">,</span>
<span class="p">});</span></code></pre></div>
<blockquote>
<p>If you want to create a fresh Pulumi project and follow along, simply
<a href="https://www.pulumi.com/docs/reference/install/">install the CLI</a>, ensure it is
<a href="https://www.pulumi.com/docs/reference/clouds/aws/setup/">configured for your AWS account</a>,
and run <code>pulumi new aws-typescript</code> to create an empty project. Swap out the contents
of <code>index.ts</code> with the above.</p>
</blockquote>

<p>Before we add our tests, we can run a <code>pulumi preview</code> and all will work just fine:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ pulumi preview
Previewing update <span class="o">(</span>tdd-infra<span class="o">)</span>:

     Type                                          Name                                          Plan
 +   pulumi:pulumi:Stack                           infra-eks-tdd-infra                           create
 +   └─ eks:index:Cluster                          my-cluster                                    create
 +      ├─ eks:index:ServiceRole                   my-cluster-eksRole                            create
 +      │  ├─ aws:iam:Role                         my-cluster-eksRole-role                       create
 +      │  ├─ aws:iam:RolePolicyAttachment         my-cluster-eksRole-90eb1c99                   create
 +      │  └─ aws:iam:RolePolicyAttachment         my-cluster-eksRole-4b490823                   create
 +      ├─ eks:index:ServiceRole                   my-cluster-instanceRole                       create
 +      │  ├─ aws:iam:Role                         my-cluster-instanceRole-role                  create
 +      │  ├─ aws:iam:RolePolicyAttachment         my-cluster-instanceRole-03516f97              create
 +      │  ├─ aws:iam:RolePolicyAttachment         my-cluster-instanceRole-e1b295bd              create
 +      │  └─ aws:iam:RolePolicyAttachment         my-cluster-instanceRole-3eb088f2              create
 +      ├─ pulumi-nodejs:dynamic:Resource          my-cluster-cfnStackName                       create
 +      ├─ aws:iam:InstanceProfile                 my-cluster-instanceProfile                    create
 +      ├─ aws:ec2:SecurityGroup                   my-cluster-eksClusterSecurityGroup            create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksClusterInternetEgressRule       create
 +      ├─ aws:eks:Cluster                         my-cluster-eksCluster                         create
 +      ├─ pulumi:providers:kubernetes             my-cluster-eks-k8s                            create
 +      ├─ pulumi-nodejs:dynamic:Resource          my-cluster-vpc-cni                            create
 +      ├─ kubernetes:core:ConfigMap               my-cluster-nodeAccess                         create
 +      ├─ aws:ec2:SecurityGroup                   my-cluster-nodeSecurityGroup                  create
 +      ├─ kubernetes:storage.k8s.io:StorageClass  my-cluster-gp2                                create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksExtApiServerClusterIngressRule  create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksClusterIngressRule              create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksNodeIngressRule                 create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksNodeInternetEgressRule          create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksNodeClusterIngressRule          create
 +      ├─ aws:ec2:LaunchConfiguration             my-cluster-nodeLaunchConfiguration            create
 +      ├─ aws:cloudformation:Stack                my-cluster-nodes                              create
 +      └─ pulumi:providers:kubernetes             my-cluster-provider                           create

Resources:
    + <span class="m">29</span> to create</code></pre></div>
<p>As usual, this shows us all of the resources that Pulumi would provision were we to
proceed with a deployment. No tests yet, however.</p>

<h2 id="adding-the-test-harness-boilerplate">Adding the Test Harness Boilerplate</h2>

<p>Now let&rsquo;s hook up the tests so they run anytime we do a <code>pulumi preview</code> or <code>pulumi up</code>.</p>

<p>Note that we won&rsquo;t be running these tests using the <code>mocha</code> CLI. Instead, we will
<a href="https://github.com/mochajs/mocha/wiki/Using-Mocha-programmatically">run Mocha programmatically</a>.
This lets us run the tests inside of our Pulumi program where all of the necessary functionality
is available. It also automatically coordinates test execution with previews and updates.</p>

<p>First, create a test file, <code>tests/index.ts</code>, that runs Mocha. This is basic boilerplate that
registers all of the test files in the <code>tests/</code> directory and will work for any project:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">fs</span> <span class="nx">from</span> <span class="s2">&#34;fs&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">Mocha</span> <span class="nx">from</span> <span class="s2">&#34;mocha&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">path</span> <span class="nx">from</span> <span class="s2">&#34;path&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>

<span class="c1">// runTests executes all test files (*.ts) in the current directory.
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">runTests() {</span>
    <span class="c1">// Create a new Mocha test runner (with a long timeout).
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">mocha</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mocha</span><span class="p">({</span> <span class="nx">timeout</span>: <span class="kt">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">30</span> <span class="p">});</span>

    <span class="c1">// Only keep the .ts files, and skip this file (index.ts).
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">testDir</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="p">;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">testDir</span><span class="p">).</span>
        <span class="nx">filter</span><span class="p">(</span><span class="nx">file</span> <span class="o">=&gt;</span> <span class="nx">file</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s2">&#34;.ts&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">file</span> <span class="o">!==</span> <span class="s2">&#34;index.ts&#34;</span><span class="p">).</span>
            <span class="nx">forEach</span><span class="p">(</span><span class="nx">file</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">mocha</span><span class="p">.</span><span class="nx">addFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">testDir</span><span class="p">,</span> <span class="nx">file</span><span class="p">));</span> <span class="p">});</span>

    <span class="c1">// Now actually run the tests with the desired reporter.
</span><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Running Mocha Tests: </span><span class="si">${</span><span class="nx">mocha</span><span class="p">.</span><span class="nx">files</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">mocha</span><span class="p">.</span><span class="nx">reporter</span><span class="p">(</span><span class="s2">&#34;spec&#34;</span><span class="p">).</span><span class="nx">run</span><span class="p">(</span><span class="nx">failures</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exitCode</span> <span class="o">=</span> <span class="nx">failures</span> <span class="o">?</span> <span class="nx">1</span> : <span class="kt">0</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// promise returns a resource output&#39;s value, even if it&#39;s undefined.
</span><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">output</span>: <span class="kt">pulumi.Output</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">|</span> <span class="kc">undefined</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">output</span> <span class="kr">as</span> <span class="nx">any</span><span class="p">).</span><span class="nx">promise</span><span class="p">()</span> <span class="kr">as</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>The <code>runTests</code> function creates an instance of the Mocha runner, registers all the test
files, configures the desired reporter, and runs the tests. We adjust the timeout to be
30 minutes, since provisioning things can take some time and we don&rsquo;t want Mocha to
timeout. For complete information on the options available, see <a href="https://github.com/mochajs/mocha/wiki/Using-Mocha-programmatically">the Mocha documentation</a>; effectively, if you
can do it with the <code>mocha</code> CLI, there is a way to do it using the API.</p>

<p>This file also defines the <code>promise</code> function used to access resource properties in our
tests. We&rsquo;ll see why this is needed shortly.</p>

<h2 id="running-the-tests">Running the Tests</h2>

<p>Now that we have <code>runTests</code>, let&rsquo;s go back and add a call to it in our primary <code>index.ts</code> file.
First we need to import our custom function at the top of the file:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">runTests</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;./tests&#34;</span><span class="p">;</span></code></pre></div>
<p>And now we&rsquo;ll add a call to <code>runTests</code> at the very bottom of the file:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// Run deployment validation tests.
</span><span class="c1"></span><span class="nx">runTests</span><span class="p">();</span></code></pre></div>
<p>That&rsquo;s it. Now when we run <code>pulumi up</code>, we will see that our tests are running!</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ pulumi up
Previewing update <span class="o">(</span>tdd-infra<span class="o">)</span>:

     Type                                          Name                                          Plan       Info
 +   pulumi:pulumi:Stack                           infra-eks-tdd-infra                           create     <span class="m">1</span> error<span class="p">;</span> <span class="m">19</span> messages
 +   └─ eks:index:Cluster                          my-cluster                                    create
 +      ├─ eks:index:ServiceRole                   my-cluster-eksRole                            create
 +      │  ├─ aws:iam:Role                         my-cluster-eksRole-role                       create
 +      │  ├─ aws:iam:RolePolicyAttachment         my-cluster-eksRole-4b490823                   create
 +      │  └─ aws:iam:RolePolicyAttachment         my-cluster-eksRole-90eb1c99                   create
 +      ├─ eks:index:ServiceRole                   my-cluster-instanceRole                       create
 +      │  ├─ aws:iam:Role                         my-cluster-instanceRole-role                  create
 +      │  ├─ aws:iam:RolePolicyAttachment         my-cluster-instanceRole-03516f97              create
 +      │  ├─ aws:iam:RolePolicyAttachment         my-cluster-instanceRole-e1b295bd              create
 +      │  └─ aws:iam:RolePolicyAttachment         my-cluster-instanceRole-3eb088f2              create
 +      ├─ pulumi-nodejs:dynamic:Resource          my-cluster-cfnStackName                       create
 +      ├─ aws:iam:InstanceProfile                 my-cluster-instanceProfile                    create
 +      ├─ aws:ec2:SecurityGroup                   my-cluster-eksClusterSecurityGroup            create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksClusterInternetEgressRule       create
 +      ├─ aws:eks:Cluster                         my-cluster-eksCluster                         create
 +      ├─ pulumi:providers:kubernetes             my-cluster-eks-k8s                            create
 +      ├─ aws:ec2:SecurityGroup                   my-cluster-nodeSecurityGroup                  create
 +      ├─ kubernetes:core:ConfigMap               my-cluster-nodeAccess                         create
 +      ├─ kubernetes:storage.k8s.io:StorageClass  my-cluster-gp2                                create
 +      ├─ pulumi-nodejs:dynamic:Resource          my-cluster-vpc-cni                            create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksClusterIngressRule              create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksNodeClusterIngressRule          create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksNodeInternetEgressRule          create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksNodeIngressRule                 create
 +      ├─ aws:ec2:SecurityGroupRule               my-cluster-eksExtApiServerClusterIngressRule  create
 +      ├─ aws:ec2:LaunchConfiguration             my-cluster-nodeLaunchConfiguration            create
 +      ├─ aws:cloudformation:Stack                my-cluster-nodes                              create
 +      └─ pulumi:providers:kubernetes             my-cluster-provider                           create

Diagnostics:
  pulumi:pulumi:Stack <span class="o">(</span>infra-eks-tdd-infra<span class="o">)</span>:
    Running Mocha Tests: infra-eks/tests/eks.spec.ts
      <span class="c1">#Amazon EKS Cluster</span>
        <span class="m">1</span><span class="o">)</span> Should use an approved Kubernetes version
        <span class="m">2</span><span class="o">)</span> Should be provisioned inside a custom, non-default VPC
      <span class="m">0</span> passing <span class="o">(</span>9s<span class="o">)</span>
      <span class="m">2</span> failing
      <span class="m">1</span><span class="o">)</span> <span class="c1">#Amazon EKS Cluster</span>
           Should use an approved Kubernetes version:
         AssertionError: expected undefined to equal <span class="s1">&#39;1.13&#39;</span>
          at Object.&lt;anonymous&gt; <span class="o">(</span>tests/eks.spec.ts:19:35<span class="o">)</span>
          at Generator.next <span class="o">(</span>&lt;anonymous&gt;<span class="o">)</span>
          at fulfilled <span class="o">(</span>tests/eks.spec.ts:4:58<span class="o">)</span>
      <span class="m">2</span><span class="o">)</span> <span class="c1">#Amazon EKS Cluster</span>
           Should be provisioned inside a custom, non-default VPC:
          AssertionError: expected <span class="s1">&#39;vpc-c93b06ae&#39;</span> to not equal <span class="s1">&#39;vpc-c93b06ae&#39;</span>
          + expected - actual
          at Object.&lt;anonymous&gt; <span class="o">(</span>tests/eks.spec.ts:25:38<span class="o">)</span>
          at Generator.next <span class="o">(</span>&lt;anonymous&gt;<span class="o">)</span>
          at fulfilled <span class="o">(</span>tests/eks.spec.ts:4:58<span class="o">)</span>

    error: an unhandled error occurred: Program exited with non-zero <span class="nb">exit</span> code: <span class="m">1</span></code></pre></div>
<p>As expected, our tests fail for two reasons:</p>

<ol>
<li>The Kubernetes version is <code>undefined</code> and not <code>1.13</code>.</li>
<li>The VPC ID is equal to the default VPC, since the EKS cluster uses that by default.</li>
</ol>

<h2 id="fixing-our-program">Fixing Our Program</h2>

<p>Now let&rsquo;s refactor our infrastructure so the tests start passing.</p>

<p>To fix the first problem, we simply need to pass the Kubernetes version explicitly when
creating our cluster. That&rsquo;s as simple as passing a new argument:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">eks</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="s2">&#34;my-cluster&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="nx">version</span><span class="o">:</span> <span class="s2">&#34;1.13&#34;</span><span class="p">,</span>
<span class="p">});</span></code></pre></div>
<p>Note that we could have done what we did with the VPC ID, and change the test to verify
that the version is correct <em>after</em> provisioning. It turns out that at the time of this
writing, the default version is in fact <code>1.13</code>, so our test would then pass. But we&rsquo;d
be depending on a brittle default that could change at any moment &ndash; so it&rsquo;s probably
better for us to be explicit about this!</p>

<p>If we rerun <code>pulumi up</code>, we&rsquo;ll see that this test now passes &ndash; huzzah:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Diagnostics:
  pulumi:pulumi:Stack <span class="o">(</span>infra-eks-tdd-infra<span class="o">)</span>:
    Running Mocha Tests: infra-eks/tests/eks.spec.ts
      <span class="c1">#Amazon EKS Cluster</span>
        ✓ Should use an approved Kubernetes version <span class="o">(</span>3704ms<span class="o">)</span>
        <span class="m">1</span><span class="o">)</span> Should be provisioned inside a custom, non-default VPC
      <span class="m">1</span> passing <span class="o">(</span>4s<span class="o">)</span>
      <span class="m">1</span> failing
      <span class="m">1</span><span class="o">)</span> <span class="c1">#Amazon EKS Cluster</span>
           Should be provisioned inside a custom, non-default VPC:
          AssertionError: expected <span class="s1">&#39;vpc-c93b06ae&#39;</span> to not equal <span class="s1">&#39;vpc-c93b06ae&#39;</span>
          + expected - actual
          at Object.&lt;anonymous&gt; <span class="o">(</span>tests/eks.spec.ts:25:38<span class="o">)</span>
          at Generator.next <span class="o">(</span>&lt;anonymous&gt;<span class="o">)</span>
          at fulfilled <span class="o">(</span>tests/eks.spec.ts:4:58<span class="o">)</span>

    error: an unhandled error occurred: Program exited with non-zero <span class="nb">exit</span> code: <span class="m">1</span></code></pre></div>
<p>But the VPC test still fails. Let&rsquo;s fix that one by creating a custom VPC &ndash; the
<code>awsx.ec2.Vpc</code> component makes this easy &ndash; and then passing its resulting ID and
subnet IDs as arguments.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">vpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">awsx</span><span class="p">.</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Vpc</span><span class="p">(</span><span class="s2">&#34;my-vpc&#34;</span><span class="p">);</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">eks</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="s2">&#34;my-cluster&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">vpcId</span>: <span class="kt">vpc.id</span><span class="p">,</span>
    <span class="nx">subnetIds</span>: <span class="kt">vpc.publicSubnetIds</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">});</span></code></pre></div>
<p>For reference, here is the complete corrected <code>index.ts</code> file we have now:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">awsx</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/awsx&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">eks</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/eks&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">runTests</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./tests&#39;</span><span class="p">;</span>

<span class="c1">// Create a basic EKS cluster.
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">vpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">awsx</span><span class="p">.</span><span class="nx">ec2</span><span class="p">.</span><span class="nx">Vpc</span><span class="p">(</span><span class="s2">&#34;my-vpc&#34;</span><span class="p">);</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">eks</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="s2">&#34;my-cluster&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">vpcId</span>: <span class="kt">vpc.id</span><span class="p">,</span>
    <span class="nx">subnetIds</span>: <span class="kt">vpc.publicSubnetIds</span><span class="p">,</span>
    <span class="nx">desiredCapacity</span>: <span class="kt">2</span><span class="p">,</span>
    <span class="nx">minSize</span>: <span class="kt">1</span><span class="p">,</span>
    <span class="nx">maxSize</span>: <span class="kt">2</span><span class="p">,</span>
    <span class="nx">storageClasses</span><span class="o">:</span> <span class="s2">&#34;gp2&#34;</span><span class="p">,</span>
    <span class="nx">deployDashboard</span>: <span class="kt">false</span><span class="p">,</span>
    <span class="nx">version</span><span class="o">:</span> <span class="s2">&#34;1.13&#34;</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// Run deployment validation.
</span><span class="c1"></span><span class="nx">runTests</span><span class="p">();</span></code></pre></div>
<p>Now if we rerun <code>pulumi up</code>, we will see that the tests pass during the preview,
landing us at the prompt asking us whether to deploy our infrastructure:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ pulumi up
Previewing update <span class="o">(</span>tdd-infra<span class="o">)</span>:

     Type                       Name                    Plan
 +   pulumi:pulumi:Stack        infra-eks-tdd-infra     create
 +   ├─ awsx:x:ec2:Vpc          my-vpc                  create
...
 +   └─ eks:index:Cluster       my-cluster              create
...

Diagnostics:
  pulumi:pulumi:Stack <span class="o">(</span>infra-eks-tdd-infra<span class="o">)</span>:
    Running Mocha Tests: infra-eks/tests/eks.spec.ts
      <span class="c1">#Amazon EKS Cluster</span>
        ✓ Should use an approved Kubernetes version <span class="o">(</span>839ms<span class="o">)</span>
        ✓ Should be provisioned inside a custom, non-default VPC
      <span class="m">2</span> passing <span class="o">(</span>928ms<span class="o">)</span>

    warning: Skipped VPC ID check: not known during preview -- will <span class="nb">test</span> after apply

Resources:
    + <span class="m">59</span> to create

Do you want to perform this update?
  yes
&gt; no
  details</code></pre></div>
<p>They passed! Notice, however, that the VPC test was skipped. That&rsquo;s because we can&rsquo;t know
whether the resulting ID is going to end up resolving to the default VPC or not. There
are myriad ways that the program could have supplied the ID, including by querying and
looking up the default VPC ID dynamically and passing it as an argument.</p>

<p>If we choose <code>yes</code> and deploy the changes, we will a more confidently passing test:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Updating <span class="o">(</span>tdd-infra<span class="o">)</span>:

     Type                       Name                    Status
 +   pulumi:pulumi:Stack        infra-eks-tdd-infra     created
 +   ├─ awsx:x:ec2:Vpc          my-vpc                  created
...
 +   └─ eks:index:Cluster       my-cluster              created
...

Diagnostics:
  pulumi:pulumi:Stack <span class="o">(</span>infra-eks-tdd-infra<span class="o">)</span>:
    Running Mocha Tests: infra-eks/tests/eks.spec.ts
      <span class="c1">#Amazon EKS Cluster</span>
        ✓ Should use an approved Kubernetes version <span class="o">(</span>666477ms<span class="o">)</span>
        ✓ Should be provisioned inside a custom, non-default VPC <span class="o">(</span>917ms<span class="o">)</span>
      <span class="m">2</span> passing <span class="o">(</span>11m<span class="o">)</span>

Resources:
    + <span class="m">59</span> created

Duration: 12m40s</code></pre></div>
<p>Voila! A successfully stood up EKS cluster, with built-in TDD security safeguards.</p>

<h2 id="keeping-track-of-failures">Keeping Track of Failures</h2>

<p>Anytime we try to deploy a program that fails, Pulumi is keeping a record of it.</p>

<p>For instance, let&rsquo;s say somehow the VPC wasn&rsquo;t known at preview time, and ended up
resolving to the default VPC. Even though the deployment occurred, we&rsquo;d want to
know that we now have an issue that we need to go track down.</p>

<p>We can very clearly see such failures on the Pulumi SaaS console:</p>

<p><img src="./failed-deployment.png" alt="Failed Deployment" /></p>

<p>And if we click into it, we&rsquo;ll see the complete Mocha test output:</p>

<p><img src="./failed-deployment-details.png" alt="Failed Deployment Details" /></p>

<p>We could even <a href="https://www.pulumi.com/docs/reference/service/webhooks/">use webhooks</a> to
fire off a Slack alarm so that nobody misses the issue. This is often very helpful in
unattended scenarios, like <a href="https://www.pulumi.com/docs/reference/cd/">continuous deployment</a>.</p>

<p>Better to catch these things late than never!</p>

<h2 id="about-resource-properties-and-outputs">About Resource Properties and Outputs</h2>

<p>A brief aside on resource properties is worthwhile, because they are &ldquo;special&rdquo; in some
important ways when writing test cases.</p>

<p>All properties on resources are of type <code>Output&lt;T&gt;</code>. This behaves a lot like a promise,
in that the value isn&rsquo;t readily available to your program. Instead, you use the <code>apply</code>
function to get at it, and Pulumi calls this when your resource&rsquo;s properties are known.</p>

<p>Sometimes, however, properties cannot be known. A good example is the VPC ID we&rsquo;re
using above. Amazon will automatically assign a VPC ID when the resource is provisioned.
That means that during previews, we won&rsquo;t actually have a known value &ndash; it doesn&rsquo;t even
exist yet! We somehow need a way to deal with these situations.</p>

<p>The <code>Output&lt;T&gt;.apply</code> function tries to shield you from these circumstances. It would
be maddening to need to check inside of these functions whether a value is known or not,
and then you&rsquo;d have all sorts of conditional code that differs between previews and updates &ndash;
generally an anti-pattern, because the entire point of a preview is to show you exactly
what will be done during an update. Any differences run the risk of showing different results.</p>

<p>Tests are special, however, in that you will need to think about what tests make sense
to run <em>before</em> an update, versus those that should run <em>after</em> an update.</p>

<p>That&rsquo;s why we need the <code>promise&lt;T&gt;</code> function defined earlier. It uses an internal
<code>promise()</code> property to get at the raw underlying promise for any resource property,
and returns it so you can either <code>await</code> it or call <code>then</code> in the usual promise ways.
This does mean we aren&rsquo;t hidden from the details of whether a preview is running or not.</p>

<blockquote>
<p>This function, or functionality like it, will be made available as an official SDK
feature as soon as <a href="https://github.com/pulumi/pulumi/issues/2287">pulumi/pulumi#2287</a>
has been resolved.</p>
</blockquote>

<p>By using this function in our tests, we have the following cases to consider:</p>

<ul>
<li>The value is known, which could be due to the following cases

<ul>
<li>It was explicitly supplied in our program</li>
<li>It was a default populated by the underlying resource provider during a preview</li>
<li>We are doing an update and the full outputs are available</li>
</ul></li>
<li>The value is <code>undefined</code>, which could be due to the following cases

<ul>
<li>We are in a preview and the value hasn&rsquo;t been computed yet</li>
<li>We have done an update and the property was not made available as an output value</li>
</ul></li>
</ul>

<p>In all cases, the <code>pulumi.runtime.isDryRun</code> function will return <code>true</code> during a preview.</p>

<p>In general, it&rsquo;s easiest to write tests that just run at deployment time, rather than during
a preview, when all of these different states are possible. That has the downside to not
catching problems before they get deployed, however. As with many things, this is a tradeoff.</p>

<p>For a more complete overview of <code>Output&lt;T&gt;</code>, please see the
<a href="https://www.pulumi.com/docs/reference/programming-model/#outputs">Pulumi Programming Model documentation</a>.</p>

<h2 id="next-steps">Next Steps</h2>

<p>In this post, we&rsquo;ve seen how to test your infrastructure using familiar test driven
development (TDD) techniques and frameworks like Node.js&rsquo;s Mocha and Chai libraries.
This is a powerful capability that builds atop Pulumi&rsquo;s use of general purpose languages,
letting you apply existing software development best practices to your infrastructure.</p>

<p>Although we&rsquo;ve just scratched the surface with our EKS cluster example, this capability
can be used to enforce a wide array of team standards, best practices, and security
guidelines. If you can express it in your favorite test framework, you can check it!</p>

<p>Everything we&rsquo;ve seen in this article is open source and free to use &ndash;
<a href="https://pulumi.com/docs/quickstart">give Pulumi a try today</a>.</p>
                    </section>
                    <div>
                        <p class="text-gray-500">Posted on <time>Saturday, Jul 13, 2019</time>
                        
                        <ul class="m-0 p-0">
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/testing/">
                                    Testing
                                </a>
                            </li>
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/infrastructure/">
                                    Infrastructure
                                </a>
                            </li>
                            
                        </ul>
                        
                    </div>
                </article>
            </div>

            <div class="md:w-2/12 pl-8">
                
            </div>
        </div>
    </div>

        </main>

        <nav class="footer bg-purple-700 py-8 px-8 md:px-0">
    <div class="container mx-auto">
        <footer>
            <div class="md:flex items-top justify-between flex-wrap">

                <div class="mb-6 md:w-4/12">
                    <a class="block mt-2" href="/">
                        <img class="h-10 opacity-50" src="/images/logo/logo-white.svg" alt="Pulumi logo">
                    </a>
                    <a class="inline-block my-4 opacity-50 text-white text-lg" href="mailto:team@pulumi.com">team@pulumi.com</a>
                    <ul class="flex inline-items text-blue-300 text-2xl">
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://twitter.com/pulumicorp" target="_blank"><i class="fab fa-twitter"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://www.linkedin.com/company/pulumi/" target="_blank"><i class="fab fa-linkedin"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://github.com/pulumi/" target="_blank"><i class="fab fa-github"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://www.youtube.com/channel/UC2Dhyn4Ev52YSbcpfnfP0Mw" target="_blank"><i class="fab fa-youtube"></i></a></li>
                        <li><a class="hover:text-blue-200" href="https://slack.pulumi.io/" target="_blank"><i class="fab fa-slack-hash"></i></a></li>
                    </ul>
                </div>

                <div class="flex flex-wrap items-top md:w-8/12">
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/containers/">Containers</a></li>
                        <li class="mb-4"><a href="/serverless/">Serverless</a></li>
                        <li class="mb-4"><a href="/docs/reference/tutorials/aws/tutorial-ec2-webserver/">Infrastructure</a></li>
                        <li class="mb-4"><a href="/kubernetes/">Kubernetes</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/docs/reference/install/">Install</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/">Get Started</a></li>
                        <li class="mb-4"><a href="/docs/reference/">Documentation</a></li>
                        <li class="mb-4"><a href="/docs/reference/pkg/">APIs</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/docs/quickstart/aws/">AWS</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/azure/">Azure</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/gcp/">Google Cloud</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/kubernetes/">Kubernetes</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/cloudfx/">Cloud Framework</a></li>
                        <li class="mb-4"><a href="/docs/reference/clouds/openstack/">OpenStack</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/about/">About Us</a></li>
                        <li class="mb-4"><a href="/contact/">Contact Us</a></li>
                        <li class="mb-4"><a href="/support/">Support</a></li>
                        <li class="mb-4"><a href="/careers/">Careers</a></li>
                    </ul>
                </div>
            </div>

            <div class="text-white opacity-75 text-sm lg:flex items-center border-t border-purple-500 mt-4 pt-4">
                
                <p class="md:w-4/12">&copy; 2019 Pulumi. All rights reserved.</p>

                <ul class="md:w-8/12">
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/trademark/">Trademark Usage</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/acceptable-use/">Acceptable Use Policy</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/terms-and-conditions/">Terms &amp; Conditions</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/privacy/">Privacy Policy</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/professional-services-agreement/">Professional Services Agreement</a></li>
                    
                </ul>
            </div>
        </footer>
    </div>
</nav>

        <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>











    




<script src="/js/bundle.min.8d935315b94bf6e77843b9c51ebc10238af740294e751f49b183b5d1e27a1c27.js" integrity="sha256-jZNTFblL9ud4Q7nFHrwQI4r3QClOdR9JsYO10eJ6HCc="></script>

    </body>
</html>
