<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
    <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="google-site-verification" content="j-Opn93zR4YQcV5bbYN99BmNc48BT5mzd2VpzKaW9YY" />

    

    
    <meta property="og:type" content="article">
    <meta property="og:url" content="/blog/continuous-delivery-with-gitlab-and-pulumi-on-amazon-eks/">
    <meta property="og:site_name" content="pulumi">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@PulumiCorp">

    
        
            
            
                
                    <meta name="twitter:creator" content="@nishidavidson">
                
            
        
    

    
        <meta property="og:title" content="Continuous Delivery with GitLab and Pulumi on Amazon EKS">
    

    
        <meta name="description" content="In this blog, we will work through an example that shows how to use Pulumi to enable GitLab-based
continuous delivery with your Kubernetes workloads on Amazon EKS. This integration will work just
as seamlessly for any Kubernetes cluster, including Azure AKS or Google GKE, using the relevant
Pulumi libraries for Azure and
GCP.">
        <meta property="og:description" content="In this blog, we will work through an example that shows how to use Pulumi to enable GitLab-based
continuous delivery with your Kubernetes workloads on Amazon EKS. This integration will work just
as seamlessly for any Kubernetes cluster, including Azure AKS or Google GKE, using the relevant
Pulumi libraries for Azure and
GCP.">
    

    
    
        
            
        
    
    <meta property="og:image" content="/blog/continuous-delivery-with-gitlab-and-pulumi-on-amazon-eks/post-image.png">

    <title>Continuous Delivery with GitLab and Pulumi on Amazon EKS - Pulumi</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    
    <link rel="canonical" href="https://www.pulumi.com/blog/continuous-delivery-with-gitlab-and-pulumi-on-amazon-eks/" >

    
    <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Pulumi Blog" />

    
    
    
        
        
        
        <link rel="stylesheet" href="/css/styles.3496f5522ba2ee3f8bbb9a51ff2cb20fb6827ca85a8ae61de0a9f960bacf1023.css" integrity="sha256-NJb1Uiui7j&#43;Lu5pR/yyyD7aCfKhaiuYd4Kn5YLrPECM=">
    

    <script async defer src="https://buttons.github.io/buttons.js"></script>

    
    
        <script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function(event) {
                anchors.add("h1:not(.no-anchor), h2:not(.no-anchor), h3:not(.no-anchor), h4:not(.no-anchor), h5:not(.no-anchor), h6:not(.no-anchor)");
            });
        </script>
    

    
    
        
            
                
            
        
        
    
</head>

    <body class="section-blog">
        <nav class="bg-black text-white text-sm py-2 px-4 lg:px-0 transition-all max-h-screen md:max-h-full">
    <div class="container mx-auto">
        <ul class="flex justify-end items-center h-6">
            <li class="mr-8"><a href="https://slack.pulumi.io/" target="_blank">Slack</a></li>
            <li class="mr-8"><a href="https://github.com/pulumi" target="_blank">GitHub</a></li>
            <li class="mr-8"><a href="https://app.pulumi.com/" target="_blank">Console</a></li>
            <li class="github-widget">
                <a class="github-button" href="https://github.com/pulumi/pulumi" data-size="small" data-show-count="true" aria-label="Star pulumi/pulumi on GitHub">Star</a>
            </li>
        </ul>
    </div>
</nav>



<nav class="nav-main bg-purple-700 py-6 px-4 lg:px-0 border-t border-purple-500">
    <div class="container mx-auto">
        <header class="flex items-center justify-between flex-wrap md:flex-no-wrap">
            <div class="flex items-center flex-shrink-0 text-white lg:mr-6">
                <a class="block" href="/">
                    <img class="h-10 block" src="/images/logo/logo-inv.svg" alt="Pulumi logo">
                </a>
            </div>

            <div class="nav-header-toggle block md:hidden">
                <button class="flex items-center px-3 py-2 border rounded text-white border-purple-400 bg-purple-600">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <ul class="nav-header-items hidden w-full flex-grow md:flex md:items-center md:w-auto text-white text-sm md:text-xs lg:text-sm uppercase pt-4 md:pt-0">
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/product/" data-submenu="product" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Products
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/why-pulumi/" data-submenu="why" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Why Pulumi
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/pricing/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Pricing
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/docs/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Docs
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/blog/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded bg-purple-400 hover:bg-purple-400">
                            Blog
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/about/" data-submenu="about" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            About
                        </a>
                    </li>
                

                <li class="md:ml-auto md:mr-2 lg:mr-4">
                    <a class="block mt-4 md:mt-0 md:text-xs lg:text-sm btn btn-orange-translucent" href="https://app.pulumi.com/">Sign In</a>
                </li>
                <li>
                    <a class="block mt-4 md:mt-0 md:text-xs lg:text-sm btn" href="https://app.pulumi.com/signup">Sign Up</a>
                </li>
            </ul>
        </header>
    </div>
</nav>
<div class="submenu">
    <div class="text-white relative overflow-visible">
        <div class="submenu-item submenu-item-product hidden absolute inset-x-0 z-50 bg-purple-700 shadow-lg pt-8 pb-16">
            <div class="container mx-auto flex items-start">
                <div class="w-1/2 pr-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">The Pulumi Platform</h3>
                    <p class="text-white">
                        Cloud Apps and Infrastructure for any cloud using languages you already know and love.
                    </p>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-sdk">Pulumi SDK</a>
                            <span>&rarr; Cloud native infrastructure as code.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-crosswalk">Pulumi Crosswalk</a>
                            <span>&rarr; Productive infrastructure as code with built-in best practices.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-saas">Pulumi SaaS</a>
                            <span>&rarr; Continuously deliver and manage cloud software for any cloud.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#multi-cloud-subscription">Multi-Cloud Subscription</a>
                            <span>&rarr; End-to-end Kubernetes solutions to achieve multi-cloud.</span>
                        </li>
                    </ul>
                    <p>
                        <span class="text-white">Pulumi is open source, free to start, and has plans available for teams.</span>
                        <a class="text-orange-500 hover:text-orange-400 hover:mr-1 transition-all" href="/pricing/">View Pricing</a> &rarr;
                    </p>
                </div>
                <div class="w-1/2 pl-12 text-purple-100 text-sm">
                    <h3 class="text-white">Get Started</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/reference/install/">Install (Mac, Windows, Linux)</a> &rarr;
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/">Documentation and Examples</a> &rarr;
                        </li>
                    </ul>
                    <h3 class="text-white">Migrate to Pulumi</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/cloudformation/">from CloudFormation</a> &rarr;
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/terraform/">from Terraform</a> &rarr;
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="submenu-item submenu-item-why hidden absolute inset-x-0 z-50 bg-purple-700 shadow pt-8 pb-16">
           <div class="container mx-auto flex items-start">
                <div class="w-1/2 pr-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">Solutions for All Teams and Engineers</h3>
                    <p class="text-white">
                        Maximize cloud velocity for Dev, DevOps, and IT, no matter your team size.
                    </p>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-developers">For Developers</a>
                            <span>&rarr; Your favorite languages, tools, and libraries.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-operators">For DevOps and IT</a>
                            <span>&rarr; Empower your team to deliver to many clouds.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-business-leaders">For Business Leaders</a>
                            <span>&rarr; Modern multi-cloud for startups and enterprises.</span>
                        </li>
                    </ul>
                </div>
                <div class="w-1/4 px-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">Any Code</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/serverless/">Serverless</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/containers/">Containers</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/kubernetes/">Kubernetes</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/reference/tutorials/aws/tutorial-ec2-webserver/">Infrastructure</a>
                            <span>&rarr;</span>
                        </li>
                    </ul>
                </div>
                <div class="w-1/4 pl-12 text-purple-100 text-sm">
                    <h3 class="text-white">Migrate to Pulumi</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/aws/">AWS</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/azure/">Azure</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/gcp/">GCP</a>
                            <span>&rarr;</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


        
        

        <main>
            
    <div class="container mx-auto px-8 py-8 md:px-0">
        <div class="md:flex">
            <div class="md:w-3/12 pr-8">
                
<aside class="md:pr-8">

    
    <div class="md:hidden">
        <button class="blog-sidebar-toggle items-center px-3 py-2 border rounded text-purple border-purple">
            <i class="fas fa-bars"></i>
        </button>
        <a href="/blog/">🍹 Pulumi Blog</a>
    </div>

    <h3 class="no-anchor hidden md:flex mt-4">
        <a href="/blog/">🍹 Pulumi Blog</a>
    </h3>

    
    <div class="blog-sidebar-content hidden md:block">
        <div class="bg-gray-100 rounded-lg p-4 my-6 text-gray-700">
            <h5 class="no-anchor text-gray-700">Program the Cloud</h5>
            <p class="text-sm my-0">
                Create, deploy, and manage cloud infrastructure using your favorite language.
            </p>
        </div>

        <ul class="list-none p-0 mb-4 inline-flex flex-wrap text-xs">
            
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/apigateway/">
                            apigateway
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/applications/">
                            applications
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/auth/">
                            auth
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/aws/">
                            aws
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/azure/">
                            azure
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/ci/cd/">
                            ci/cd
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/cloud-native/">
                            cloud-native
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/containers/">
                            containers
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/customer/">
                            customer
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/digitalocean/">
                            digitalocean
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/docker/">
                            docker
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/eks/">
                            eks
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/events/">
                            events
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/features/">
                            features
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/gcp/">
                            gcp
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/gke/">
                            gke
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/infrastructure/">
                            infrastructure
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/javascript/">
                            javascript
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/jupyter/">
                            jupyter
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/kubernetes/">
                            kubernetes
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/lambda/">
                            lambda
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/logging/">
                            logging
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/mysql/">
                            mysql
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/new-features/">
                            new-features
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/pulumi/">
                            pulumi
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/pulumi-news/">
                            pulumi-news
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/python/">
                            python
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/security/">
                            security
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/serverless/">
                            serverless
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/testing/">
                            testing
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/typescript/">
                            typescript
                        </a>
                    </li>
                
            
        </ul>

        <div class="hidden lg:block my-4">
            <h5 class="no-anchor">Recent Posts</h5>
            <ul class="list-none p-0">
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/day-2-kubernetes-migrating-eks-nodegroups-with-zero-downtime/">Day 2 Kubernetes: Migrating EKS Node Groups with Zero Downtime</a>
                        </li>
                    
                
                    
                        
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/getting-started-on-digitalocean-with-pulumi/">Getting Started on DigitalOcean with Pulumi</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/pulumi-meetup-recap-apis-custom-resources-and-github-webhooks/">Pulumi Meetup Recap: APIs, Custom Resources and GitHub Webhooks</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/persisting-kubernetes-workloads-with-amazon-efscsi-volumes-using-pulumi-sdks/">Persisting Kubernetes workloads with Amazon EFS CSI volumes using Pulumi open source SDKs</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/unit-testing-infrastructure-in-nodejs-and-mocha/">Unit Testing Your Infrastructure with Node.js and Mocha</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/kubernetes-ingress-with-aws-alb-ingress-controller-and-pulumi-crosswalk/">Kubernetes Ingress with AWS ALB Ingress Controller and Pulumi Crosswalk for AWS</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/globally-distributed-serverless-application-in-100-lines-of-code-infrastructure-included/">Globally-distributed Serverless Application in 100 Lines of Code. Infrastructure Included!</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/hosting-a-static-website-on-azure-with-pulumi/">Hosting a Static Website on Azure with Pulumi</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="/blog/running-containers-in-aws-the-lowdown-ecs-fargate-and-eks/">Running Containers in AWS, the Lowdown: ECS, Fargate, and EKS</a>
                        </li>
                    
                
            </ul>
        </div>
    </div>

    <div class="md:hidden pb-4">
        
    </div>
</aside>

            </div>

            <div class="md:w-7/12">
                <article class="mb-8 pb-8 border-b border-gray-200">
                    <h1 class="no-anchor"><a href="/blog/continuous-delivery-with-gitlab-and-pulumi-on-amazon-eks/">Continuous Delivery with GitLab and Pulumi on Amazon EKS</a></h1>
                    <div class="flex items-center">
                        <span>
                            <span class="flex items-center">
    
        
        

        <span class="flex items-center mr-2">
            
                <a class="rounded-full p-1 bg-gray-300 mr-2" href="/blog/author/nishi-davidson/">
                    <img class="w-8 rounded-full" src="/images/team/nishi-davidson.jpg" alt="Nishi Davidson" title="Nishi Davidson">
                </a>
                <a class="" href="/blog/author/nishi-davidson/">Nishi Davidson</a>
            
        </span>
    
</span>

                        </span>
                    </div>
                    <section>
                        <p>In this blog, we will work through an example that shows how to use Pulumi to enable GitLab-based
continuous delivery with your Kubernetes workloads on Amazon EKS. This integration will work just
as seamlessly for any Kubernetes cluster, including Azure AKS or Google GKE, using the relevant
Pulumi libraries for <a href="https://github.com/pulumi/pulumi-azure">Azure</a> and
<a href="https://github.com/pulumi/pulumi-gcp">GCP</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
<li>An account on <a href="https://app.pulumi.com/">https://app.pulumi.com</a> with
an organization.</li>
<li>The latest <code>pulumi</code> CLI. Installation instructions are <a href="/docs/reference/install/">here</a>.</li>
<li>A bare repository. Set the remote URL to be your GitLab project.</li>
</ul>

<h2 id="concepts-in-pulumi">Concepts in Pulumi</h2>

<h3 id="organization-of-pulumi-projects-and-pulumi-stacks">Organization of Pulumi Projects and Pulumi Stacks</h3>

<p>All users in the Pulumi service will start with the hierarchy of an
organization. This can be a specific GitHub, GitLab or Atlassian
organization or your solo organization. Inside each organization, users
create Pulumi projects and stacks.</p>

<p>Pulumi <a href="/docs/reference/project/">projects</a>
and <a href="/docs/reference/stack/">stacks</a>
are flexible to accommodate the diverse needs across teams, applications,
and infrastructure scenarios. Just like Git repos that work with varying
approaches Pulumi projects and stacks allow you to organize your code
within them. Immediate options include:</p>

<ul>
<li><strong>Monolithic project/stack structure:</strong> A single project defines the
infrastructure and application resources for an entire vertical
service as represented in the image below:</li>
</ul>

<p><img src="./image-2.png" alt="Monolithic structure" /></p>

<ul>
<li><strong>Micro-stacks project/stack structure:</strong> A project broken into
separately managed smaller projects, often across different
dimensions as represented in the image below:</li>
</ul>

<p><img src="./image-3.png" alt="Micro-stack structure structure" /></p>

<p>Working with Inter-Stack Dependencies with the latter option is more
suited in a production setup giving users more flexibility and
boundaries between their teams. We will use this structure in our
example below. For more information on Pulumi projects and stacks,
please refer to our documentation
<a href="/docs/reference/organizing-stacks-projects/">here</a>.</p>

<h3 id="use-tags-to-group-pulumi-stacks-as-environments">Use Tags to group Pulumi Stacks as Environments:</h3>

<ul>
<li>Pulumi Stacks have associated metadata in the form of key/value
tags.</li>
<li>You can assign custom tags to stacks (when logged into the
<a href="/docs/reference/state/">web backend</a> to customize how
stacks are listed in the <a href="https://app.pulumi.com/">Pulumi Cloud Console</a>.

<ul>
<li>In our example below we have two environments <em>prod</em> and <em>dev</em>.</li>
<li>To group stacks by environment we assign custom tags
<code>environment: prod</code> and <code>environment: dev</code> to the respective
stacks</li>
<li>In the Pulumi Cloud Console, you&rsquo;ll be able to group stacks by
tag: <code>environment:dev</code> and tag: <code>environment:prod</code>.</li>
</ul></li>
</ul>

<p>Please read more about managing <a href="/docs/reference/stack/#stack-tags">stack tags in Pulumi</a>.</p>

<p><img src="./image-4.png" alt="Stack tags" /></p>

<p>Let&rsquo;s now work through our example with GitLab Pipelines.</p>

<blockquote>
<p>Please replace the highlighted <strong><code>&lt;org-name-in-pulumi&gt;</code></strong> below with your Pulumi organization
name to run through the steps successfully.</p>
</blockquote>

<h2 id="gitlab-pipeline-by-environment">GitLab Pipeline by Environment</h2>

<ol>
<li>We created a GitLab Group called <strong>pulumi-gitlab</strong>.</li>
<li>We created three GitLab projects called <strong>sample-iam</strong>,
<strong>sample-eks</strong> and <strong>sample-k8sapp</strong>. These projects match the
project names in Pulumi SaaS platform.</li>
<li>We have two pipelines: <strong>environment:dev</strong> and <strong>environment:prod</strong>.
In the two pipelines, we have a total of six pulumi stacks:

<ul>
<li><code>&lt;org-name-in-pulumi&gt;/sample-iam/dev</code>, and <code>&lt;org-name-in-pulumi&gt;/sample-iam/prod</code>.</li>
<li><code>&lt;org-name-in-pulumi&gt;/sample-eks/dev</code> and <code>&lt;org-name-in-pulumi&gt;/sample-eks/prod</code>.</li>
<li><code>&lt;org-name-in-pulumi&gt;/sample-k8sapp/dev</code> and <code>&lt;org-name-in-pulumi&gt;/sample-k8sapp/prod</code>.</li>
</ul></li>
</ol>

<p><code>&lt;org-name-in-pulumi&gt;/sample-iam/dev</code> stack will trigger the
downstream stack <code>&lt;org-name-in-pulumi&gt;/sample-eks/dev</code>
provided the cycle of <code>pulumi preview</code> and <code>pulumi deploy</code> completes
without any failure.</p>

<p>Similarly, <code>&lt;org-name-in-pulumi&gt;/sample-eks/dev</code> will trigger
the downstream stack <code>&lt;org-name-in-pulumi&gt;/sample-k8sapp/dev</code>
provided the cycle of <code>pulumi preview</code> and <code>pulumi deploy</code> completes
without any failure.</p>

<p><img src="./image-4.png" alt="No failures" /></p>

<ol>
<li>To use Pulumi within GitLab CI, there are a few environment
variables you&rsquo;ll need to set for each build.

<ul>
<li>The first is <code>PULUMI_ACCESS_TOKEN</code>, which is required to
authenticate with <a href="http://pulumi.com"><strong>pulumi.com</strong></a> in order
to perform the preview or update. You can create a new Pulumi
access token specifically for your CI/CD job on your
<a href="https://app.pulumi.com/account/tokens">Pulumi Account page</a>.</li>
<li>Next, you will also need to set environment variables specific
to your cloud resource provider. For example, if your stack is
managing resources on AWS, <code>AWS_ACCESS_KEY_ID</code> and
<code>AWS_SECRET_ACCESS_KEY</code>.</li>
</ul></li>
</ol>

<h2 id="create-pulumi-stacks-and-push-the-files-to-your-gitlab-project">Create Pulumi stacks and push the files to your GitLab project</h2>

<p>If you run <code>pulumi</code> from any branch other than the <code>master</code> branch, you
will hit an error that the <code>PULUMI_ACCESS_TOKEN</code> environment variable
cannot be accessed. You can fix this by specifying a wildcard regex to
allow specific branches to be able to access the secret environment
variables. Please refer to the <a href="https://gitlab.com/help/user/project/protected_branches.md">GitLab
documentation</a>
to understand this better.</p>

<p>First we set up three Pulumi stacks: <strong>sample-iam</strong>; <strong>sample-eks</strong> and
<strong>sample-k8sapp</strong> with group stack tag: <code>environment:dev</code></p>

<p><strong>Step 1:</strong> Create the pulumi stack &ldquo;sample-IAM&rdquo; and set stack tag
&ldquo;key:value&rdquo; = &ldquo;environment:dev&rdquo;.
We update the <code>index.ts</code> file with the relevant code block as shown
below and run <code>pulumi up</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ pulumi new aws-typescript --dir &lt;org-name-in-pulumi&gt;/sample-iam/dev
$ <span class="nb">cd</span> &lt;org-name-in-pulumi&gt;/sample-iam/dev</code></pre></div>
<p>Let&rsquo;s run <code>pulumi up</code> with the following <code>index.ts</code> file.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">aws</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">createIAMRole</span><span class="p">(</span><span class="nx">name</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Role</span> <span class="p">{</span>
    <span class="c1">// Create an IAM Role
</span><span class="c1"></span>    <span class="k">return</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">iam</span><span class="p">.</span><span class="nx">Role</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">assumeRolePolicy</span><span class="o">:</span> <span class="sb">`{
</span><span class="sb">            &#34;Version&#34;: &#34;2012-10-17&#34;,
</span><span class="sb">            &#34;Statement&#34;:[
</span><span class="sb">              {
</span><span class="sb">                &#34;Sid&#34;: &#34;&#34;,
</span><span class="sb">                &#34;Effect&#34;: &#34;Allow&#34;,
</span><span class="sb">                &#34;Principal&#34;: {
</span><span class="sb">                  &#34;AWS&#34;: &#34;arn:aws:iam::153052954103:root&#34;
</span><span class="sb">                },
</span><span class="sb">                &#34;Action&#34;: &#34;sts:AssumeRole&#34;
</span><span class="sb">              }
</span><span class="sb">            ]
</span><span class="sb">        }`</span><span class="p">,</span>
        <span class="nx">tags</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&#34;clusterAccess&#34;</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">-usr`</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Administer automation role for use in pipelines, e.g. gitlab CI, Teamcity, etc.
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">automationRole</span> <span class="o">=</span> <span class="nx">createIAMRole</span><span class="p">(</span><span class="s2">&#34;automationRole&#34;</span><span class="p">);</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">automationRoleArn</span> <span class="o">=</span> <span class="nx">automationRole</span><span class="p">.</span><span class="nx">arn</span><span class="p">;</span></code></pre></div>
<p>We then group the stack by initializing it with a new stack tag
&ldquo;key:value&rdquo; = &ldquo;environment:prod&rdquo; and run <code>pulumi up</code> with the same
<code>index.ts</code> file.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ pulumi up

<span class="c1"># Initialize new pulumi stack in the format:</span>
<span class="c1"># pulumi stack init &lt;org-name-in-pulumi&gt;/&lt;project&gt;/&lt;stack&gt;</span>
$ pulumi stack init &lt;org-name-in-pulumi&gt;/sample-iam/prod
$ pulumi stack tag <span class="nb">set</span> environment prod
$ pulumi up</code></pre></div>
<p><strong>Step 2:</strong> Create the pulumi stack <strong>sample-eks</strong> and set stack tag
&ldquo;key:value&rdquo; = &ldquo;environment:dev&rdquo;.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ pulumi new aws-typescript --dir &lt;org-name-in-pulumi&gt;/sample-eks/dev
$ <span class="nb">cd</span> &lt;org-name-in-pulumi&gt;/sample-eks/dev</code></pre></div>
<p>Update the <code>index.ts</code> file with the relevant code block as shown below:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">aws</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">awsx</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/awsx&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">eks</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/eks&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">k8s</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/kubernetes&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">getStack</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">iamstack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">StackReference</span><span class="p">(</span><span class="sb">`&lt;org-name-in-pulumi&gt;/sample-iam/</span><span class="si">${</span><span class="nx">env</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">automationRoleArn</span> <span class="o">=</span> <span class="nx">iamstack</span><span class="p">.</span><span class="nx">getOutput</span><span class="p">(</span><span class="s2">&#34;automationRoleArn&#34;</span><span class="p">)</span>

<span class="cm">/* * Single step deployment of EKS cluster with the most important variables and simple function to create two namespaces */</span>

<span class="kr">const</span> <span class="nx">vpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">awsx</span><span class="p">.</span><span class="nx">Network</span><span class="p">(</span><span class="s2">&#34;vpc&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">eks</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="s2">&#34;eks-cluster&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">vpcId</span>             : <span class="kt">vpc.vpcId</span><span class="p">,</span>
    <span class="nx">subnetIds</span>         : <span class="kt">vpc.subnetIds</span><span class="p">,</span>
    <span class="nx">instanceType</span>      <span class="o">:</span> <span class="s2">&#34;t2.medium&#34;</span><span class="p">,</span>
    <span class="nx">nodeRootVolumeSize</span>: <span class="kt">200</span><span class="p">,</span>
    <span class="nx">desiredCapacity</span>   : <span class="kt">1</span><span class="p">,</span>
    <span class="nx">maxSize</span>           : <span class="kt">2</span><span class="p">,</span>
    <span class="nx">minSize</span>           : <span class="kt">1</span><span class="p">,</span>
    <span class="nx">deployDashboard</span>   : <span class="kt">false</span><span class="p">,</span>
    <span class="nx">vpcCniOptions</span>     <span class="o">:</span> <span class="p">{</span>
        <span class="nx">warmIpTarget</span>    : <span class="kt">4</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">roleMappings</span>      <span class="o">:</span> <span class="p">[</span>
        <span class="c1">// Map IAM role arn &#34;automationRoleArn&#34; to the k8s user with name &#34;automation-usr&#34;, e.g. gitlab CI
</span><span class="c1"></span>        <span class="p">{</span>
            <span class="nx">groups</span>    <span class="o">:</span> <span class="p">[</span><span class="s2">&#34;pulumi:automation-grp&#34;</span><span class="p">],</span>
            <span class="nx">roleArn</span>   : <span class="kt">automationRoleArn</span><span class="p">,</span>
            <span class="nx">username</span>  <span class="o">:</span> <span class="s2">&#34;pulumi:automation-usr&#34;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">],</span>
<span class="p">});</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">clusterName</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">eksCluster</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

<span class="cm">/* * Single Step deployment of k8s RBAC configuration */</span>

<span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">rbac</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Role</span><span class="p">(</span><span class="s2">&#34;automationRole&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;automationRole&#34;</span><span class="p">,</span>
        <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;automation&#34;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">rules</span><span class="o">:</span> <span class="p">[{</span>
        <span class="nx">apiGroups</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">],</span>
        <span class="nx">resources</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">],</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">],</span>
    <span class="p">}]</span>
<span class="p">},</span> <span class="p">{</span><span class="nx">provider</span>: <span class="kt">cluster.provider</span><span class="p">});</span>

<span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">rbac</span><span class="p">.</span><span class="nx">v1</span><span class="p">.</span><span class="nx">RoleBinding</span><span class="p">(</span><span class="s2">&#34;automation-binding&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;automation-binding&#34;</span><span class="p">,</span>
        <span class="nx">namespace</span><span class="o">:</span> <span class="s2">&#34;automation&#34;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">subjects</span><span class="o">:</span> <span class="p">[{</span>
        <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;pulumi:automation-usr&#34;</span><span class="p">,</span>
        <span class="nx">apiGroup</span><span class="o">:</span> <span class="s2">&#34;rbac.authorization.k8s.io&#34;</span><span class="p">,</span>
    <span class="p">}],</span>
    <span class="nx">roleRef</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;Role&#34;</span><span class="p">,</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;automationRole&#34;</span><span class="p">,</span>
        <span class="nx">apiGroup</span><span class="o">:</span> <span class="s2">&#34;rbac.authorization.k8s.io&#34;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">},</span> <span class="p">{</span><span class="nx">provider</span>: <span class="kt">cluster.provider</span><span class="p">});</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">kubeconfig</span> <span class="o">=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">kubeconfig</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">)</span></code></pre></div>
<p>Let&rsquo;s download the additional npm packages for EKS and Kubernetes and
run <code>pulumi up</code> and initialize a new stack tag &ldquo;key:value&rdquo; =
&ldquo;environment:prod&rdquo; to run <code>pulumi up</code> with the same <code>index.ts</code> file.</p>

<pre><code>$ npm install --save @pulumi/eks @pulumi/kubernetes
$ pulumi up

# Initialize new pulumi stack in the format:
# pulumi stack init &lt;org-name-in-pulumi&gt;/&lt;project&gt;/&lt;stack&gt;
$ pulumi stack init &lt;org-name-in-pulumi&gt;/sample-eks/prod
$ pulumi stack tag set environment prod
$ pulumi up
</code></pre>

<p><strong>Step 3:</strong> Create the pulumi stack &ldquo;sample-k8sapp&rdquo; and set stack tag
&ldquo;key:value&rdquo; = &ldquo;environment:dev&rdquo;.
We will then update the <code>index.ts</code> file with the relevant code block as
shown below:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ pulumi new aws-typescript --dir &lt;org-name-in-pulumi&gt;/sample-k8sapp/dev
$ <span class="nb">cd</span> &lt;org-name-in-pulumi&gt;/sample-k8sapp/dev</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">aws</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/aws&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">docker</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/docker&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">k8s</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/kubernetes&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">getStack</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">eksCluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">StackReference</span><span class="p">(</span><span class="sb">`&lt;org-name-in-pulumi&gt;/sample-eks/</span><span class="si">${</span><span class="nx">env</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">kubeconfig</span> <span class="o">=</span> <span class="nx">eksCluster</span><span class="p">.</span><span class="nx">getOutput</span><span class="p">(</span><span class="s2">&#34;kubeconfig&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">k8sProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">Provider</span><span class="p">(</span><span class="s2">&#34;eks-cluster&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">kubeconfig</span>: <span class="kt">kubeconfig</span><span class="p">,</span>
  <span class="p">});</span>

<span class="cm">/* * Single step deployment of one docker container in ECR */</span>

<span class="kd">function</span> <span class="nx">getImageRegistry</span><span class="p">(</span><span class="nx">repo</span>: <span class="kt">aws.ecr.Repository</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">registryId</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">async</span> <span class="nx">registryId</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">registryId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;Expected registry ID to be defined during push&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kr">const</span> <span class="nx">credentials</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">ecr</span><span class="p">.</span><span class="nx">getCredentials</span><span class="p">({</span> <span class="nx">registryId</span>: <span class="kt">registryId</span> <span class="p">});</span>
        <span class="kr">const</span> <span class="nx">decodedCredentials</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">authorizationToken</span><span class="p">,</span> <span class="s2">&#34;base64&#34;</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
        <span class="kr">const</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">]</span> <span class="o">=</span> <span class="nx">decodedCredentials</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">password</span> <span class="o">||</span> <span class="o">!</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;Invalid credentials&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">server</span>: <span class="kt">credentials.proxyEndpoint</span><span class="p">,</span>
            <span class="nx">username</span>: <span class="kt">username</span><span class="p">,</span>
            <span class="nx">password</span>: <span class="kt">password</span><span class="p">,</span>
        <span class="p">};</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">ecr1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">ecr</span><span class="p">.</span><span class="nx">Repository</span><span class="p">(</span><span class="s2">&#34;breathe&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">image1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">docker</span><span class="p">.</span><span class="nx">Image</span><span class="p">(</span><span class="s2">&#34;breathe&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">imageName</span>: <span class="kt">ecr1.repositoryUrl</span><span class="p">,</span>
    <span class="nx">build</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">context</span><span class="o">:</span> <span class="s2">&#34;./app&#34;</span><span class="p">,</span>
        <span class="nx">cacheFrom</span>: <span class="kt">true</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">registry</span>: <span class="kt">getImageRegistry</span><span class="p">(</span><span class="nx">ecr1</span><span class="p">),</span>
<span class="p">});</span>

<span class="c1">// Declare the docker container based deployment
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">appLabels</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">app</span>: <span class="kt">appName</span> <span class="p">};</span>
<span class="kr">const</span> <span class="nx">breathecontainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">k8s</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">(</span><span class="nx">appName</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">selector</span><span class="o">:</span> <span class="p">{</span> <span class="nx">matchLabels</span>: <span class="kt">appLabels</span> <span class="p">},</span>
        <span class="nx">replicas</span>: <span class="kt">1</span><span class="p">,</span>
        <span class="nx">template</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span> <span class="nx">labels</span>: <span class="kt">appLabels</span> <span class="p">},</span>
            <span class="nx">spec</span><span class="o">:</span> <span class="p">{</span> <span class="nx">containers</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">name</span>: <span class="kt">appName</span><span class="p">,</span> <span class="nx">image</span>: <span class="kt">image1.imageName</span> <span class="p">}]</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">},</span> <span class="p">{</span> <span class="nx">provider</span>: <span class="kt">k8sProvider</span> <span class="p">});</span></code></pre></div>
<p>We download the additional npm packages for EKS and Kubernetes and run
<code>pulumi up</code> and group a new stack by initializing it with a new stack
tag &ldquo;key:value&rdquo; = &ldquo;environment:prod&rdquo; and run <code>pulumi up</code> with the same
<code>index.ts</code> file.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ npm install --save @pulumi/kubernetes @pulumi/docker
$ pulumi up

<span class="c1"># Initialize new pulumi stack</span>
$ pulumi stack init &lt;org-name-in-pulumi&gt;/sample-eks/prod
$ pulumi stack tag <span class="nb">set</span> environment prod
$ pulumi up</code></pre></div>
<h2 id="using-gitlab-pipelines-with-the-six-pulumi-stacks-in-environment-dev-and-environment-prod">Using GitLab Pipelines with the six Pulumi stacks in <code>environment:dev</code> and <code>environment:prod</code></h2>

<p>GitLab pipelines are configured using <code>.gitlab-ci.yml</code> files in the root
of each repository. GitLab Silver and above is capable of <a href="https://docs.gitlab.com/ee/ci/multi_project_pipelines.html#passing-variables-to-a-downstream-pipeline">running
pipelines that cross project
boundaries</a>,
so we will be using that to construct our pipeline.</p>

<p>All three <code>.gitlab-ci.yml</code> files that we use are very similar in
structure. The base one,<code>sample-iam</code>, looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">image<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>pulumi/pulumi<span class="p">:</span>v0.<span class="m">17.10</span><span class="w">
</span><span class="w">  </span>entrypoint<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span><span class="s1">&#39;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>stages<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>preview<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>update<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>downstream<span class="w">
</span><span class="w">
</span><span class="w"></span>Pulumi<span class="w"> </span>Preview<span class="p">:</span><span class="w">
</span><span class="w">  </span>stage<span class="p">:</span><span class="w"> </span>preview<span class="w">
</span><span class="w">  </span>script<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>npm<span class="w"> </span>ci<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>pulumi<span class="w"> </span>stack<span class="w"> </span>select<span class="w"> </span>pulumi/sample-iam/$DEPLOY_ENVIRONMENT<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>pulumi<span class="w"> </span>preview<span class="w">
</span><span class="w">
</span><span class="w"></span>Pulumi<span class="w"> </span>Update<span class="p">:</span><span class="w">
</span><span class="w">  </span>stage<span class="p">:</span><span class="w"> </span>update<span class="w">
</span><span class="w">  </span>script<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>npm<span class="w"> </span>ci<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>pulumi<span class="w"> </span>stack<span class="w"> </span>select<span class="w"> </span>pulumi/sample-iam/$DEPLOY_ENVIRONMENT<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>pulumi<span class="w"> </span>update<span class="w"> </span>--skip-preview<span class="w">
</span><span class="w">
</span><span class="w"></span>Update<span class="w"> </span>EKS<span class="p">:</span><span class="w">
</span><span class="w">  </span>stage<span class="p">:</span><span class="w"> </span>downstream<span class="w">
</span><span class="w">  </span>trigger<span class="p">:</span><span class="w"> </span>pulumi-gitlab/sample-eks</code></pre></div>
<p>This file describes a three-stage pipeline for the <code>sample-iam</code> project:</p>

<ol>
<li>First, we run a preview for the requested deployment environment,
failing the pipeline if the preview fails.</li>
<li>If the preview was successful, we run <code>pulumi update</code>, which deploys
the IAM changes.</li>
<li>Finally, we trigger the pipeline in <code>pulumi-gilab/sample-eks</code>, which
triggers the next pipeline in our pipeline daisy chain illustrated
in the above image.</li>
</ol>

<p>Despite being powerful, conceptually this setup is quite simple and
doesn&rsquo;t require much code to get right.</p>

<p><img src="./image-5.png" alt="The final result" /></p>

<p>Upon a successful update, each tier&rsquo;s pipeline will trigger a pipeline
for the tiers that depend on it. Pulumi&rsquo;s StackReference feature ensures
that the dependent tiers receive new copies of the outputs exported from
the IAM stack, so the deployment flows naturally through the pipeline!</p>

<p>This brings us to the end of our CD solution with Pulumi and GitLab on
Amazon EKS. For more examples, refer to the <a href="https://github.com/pulumi/examples">Pulumi examples</a>
repository. Refer to my previous post on
<a href="/blog/simplify-kubernetes-rbac-in-amazon-eks-with-open-source-pulumi-packages/">Amazon EKS and k8s RBAC in Pulumi</a>.</p>
                    </section>
                    <div>
                        <p class="text-gray-500">Posted on <time>Wednesday, May 22, 2019</time>
                        
                        <ul class="m-0 p-0">
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/aws/">
                                    AWS
                                </a>
                            </li>
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/kubernetes/">
                                    Kubernetes
                                </a>
                            </li>
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/ci/cd/">
                                    CI/CD
                                </a>
                            </li>
                            
                        </ul>
                        
                    </div>
                </article>
            </div>

            <div class="md:w-2/12 pl-8">
                
            </div>
        </div>
    </div>

        </main>

        <nav class="footer bg-purple-700 py-8 px-8 md:px-0">
    <div class="container mx-auto">
        <footer>
            <div class="md:flex items-top justify-between flex-wrap">

                <div class="mb-6 md:w-4/12">
                    <a class="block mt-2" href="/">
                        <img class="h-10 opacity-50" src="/images/logo/logo-white.svg" alt="Pulumi logo">
                    </a>
                    <a class="inline-block my-4 opacity-50 text-white text-lg" href="mailto:team@pulumi.com">team@pulumi.com</a>
                    <ul class="flex inline-items text-blue-300 text-2xl">
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://twitter.com/pulumicorp" target="_blank"><i class="fab fa-twitter"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://www.linkedin.com/company/pulumi/" target="_blank"><i class="fab fa-linkedin"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://github.com/pulumi/" target="_blank"><i class="fab fa-github"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://www.youtube.com/channel/UC2Dhyn4Ev52YSbcpfnfP0Mw" target="_blank"><i class="fab fa-youtube"></i></a></li>
                        <li><a class="hover:text-blue-200" href="https://slack.pulumi.io/" target="_blank"><i class="fab fa-slack-hash"></i></a></li>
                    </ul>
                </div>

                <div class="flex flex-wrap items-top md:w-8/12">
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/containers/">Containers</a></li>
                        <li class="mb-4"><a href="/serverless/">Serverless</a></li>
                        <li class="mb-4"><a href="/docs/reference/tutorials/aws/tutorial-ec2-webserver/">Infrastructure</a></li>
                        <li class="mb-4"><a href="/kubernetes/">Kubernetes</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/docs/reference/install/">Install</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/">Get Started</a></li>
                        <li class="mb-4"><a href="/docs/reference/">Documentation</a></li>
                        <li class="mb-4"><a href="/docs/reference/pkg/">APIs</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/docs/quickstart/aws/">AWS</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/azure/">Azure</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/gcp/">Google Cloud</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/kubernetes/">Kubernetes</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/cloudfx/">Cloud Framework</a></li>
                        <li class="mb-4"><a href="/docs/reference/clouds/openstack/">OpenStack</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/about/">About Us</a></li>
                        <li class="mb-4"><a href="/contact/">Contact Us</a></li>
                        <li class="mb-4"><a href="/support/">Support</a></li>
                        <li class="mb-4"><a href="/careers/">Careers</a></li>
                    </ul>
                </div>
            </div>

            <div class="text-white opacity-75 text-sm lg:flex items-center border-t border-purple-500 mt-4 pt-4">
                
                <p class="md:w-4/12">&copy; 2019 Pulumi. All rights reserved.</p>

                <ul class="md:w-8/12">
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/trademark/">Trademark Usage</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/acceptable-use/">Acceptable Use Policy</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/terms-and-conditions/">Terms &amp; Conditions</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/privacy/">Privacy Policy</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/professional-services-agreement/">Professional Services Agreement</a></li>
                    
                </ul>
            </div>
        </footer>
    </div>
</nav>

        <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>











    




<script src="/js/bundle.min.8d935315b94bf6e77843b9c51ebc10238af740294e751f49b183b5d1e27a1c27.js" integrity="sha256-jZNTFblL9ud4Q7nFHrwQI4r3QClOdR9JsYO10eJ6HCc="></script>

    </body>
</html>
