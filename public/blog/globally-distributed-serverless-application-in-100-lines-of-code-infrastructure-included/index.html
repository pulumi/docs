<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
    <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="google-site-verification" content="j-Opn93zR4YQcV5bbYN99BmNc48BT5mzd2VpzKaW9YY" />

    

    
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://www.pulumi.com/blog/globally-distributed-serverless-application-in-100-lines-of-code-infrastructure-included/">
    <meta property="og:site_name" content="pulumi">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@PulumiCorp">

    
        
            
            
                
                    <meta name="twitter:creator" content="@MikhailShilkov">
                
            
        
    

    
        <meta property="og:title" content="Globally-distributed Serverless Application in 100 Lines of Code. Infrastructure Included!">
    

    
        <meta name="description" content="Pulumi is excellent at connecting multiple cloud components into a
cohesive application. In my previous post,
I introduced the way to mix JavaScript or TypeScript serverless
functions directly into the cloud infrastructure programs.

Today, I will build a serverless application with both the data store
and the HTTP endpoint located close to end users to ensure prompt
response time. The entire application runs on top of managed Azure
services and is defined as a single Pulumi program in TypeScript.">
        <meta property="og:description" content="Pulumi is excellent at connecting multiple cloud components into a
cohesive application. In my previous post,
I introduced the way to mix JavaScript or TypeScript serverless
functions directly into the cloud infrastructure programs.

Today, I will build a serverless application with both the data store
and the HTTP endpoint located close to end users to ensure prompt
response time. The entire application runs on top of managed Azure
services and is defined as a single Pulumi program in TypeScript.">
    

    
    
        
            
        
    
    <meta property="og:image" content="https://www.pulumi.com/blog/globally-distributed-serverless-application-in-100-lines-of-code-infrastructure-included/feature.jpg">

    <title>Globally-distributed Serverless Application in 100 Lines of Code. Infrastructure Included! - Pulumi</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    
    <link rel="canonical" href="https://www.pulumi.com/blog/globally-distributed-serverless-application-in-100-lines-of-code-infrastructure-included/" >

    
    <link rel="alternate" type="application/rss+xml" href="https://www.pulumi.com/blog/rss.xml" title="Pulumi Blog" />

    
    
    
        
        
        
        <link rel="stylesheet" href="https://www.pulumi.com/css/styles.3496f5522ba2ee3f8bbb9a51ff2cb20fb6827ca85a8ae61de0a9f960bacf1023.css" integrity="sha256-NJb1Uiui7j&#43;Lu5pR/yyyD7aCfKhaiuYd4Kn5YLrPECM=">
    

    <script async defer src="https://buttons.github.io/buttons.js"></script>
    
    <script>
    !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t,e){var n=document.createElement("script");n.type="text/javascript";n.async=!0;n.src="https://cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(n,a);analytics._loadOptions=e};analytics.SNIPPET_VERSION="4.1.0";
    analytics.load("UK90Ofwacetj5VCPJ7cUgkbNcKLSHO3u");
    analytics.page();
    }}();
    </script>

    
    
        <script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function(event) {
                anchors.add("h1:not(.no-anchor), h2:not(.no-anchor), h3:not(.no-anchor), h4:not(.no-anchor), h5:not(.no-anchor), h6:not(.no-anchor)");
            });
        </script>
    

    
    
        
            
                
            
        
        
    
</head>

    <body class="section-blog">
        <nav class="bg-black text-white text-sm py-2 px-4 lg:px-0 transition-all max-h-screen md:max-h-full">
    <div class="container mx-auto">
        <ul class="flex justify-end items-center h-6">
            <li class="mr-8"><a href="https://slack.pulumi.io/" target="_blank">Slack</a></li>
            <li class="mr-8"><a href="https://github.com/pulumi" target="_blank">GitHub</a></li>
            <li class="mr-8"><a href="https://app.pulumi.com/" target="_blank">Console</a></li>
            <li class="github-widget">
                <a class="github-button" href="https://github.com/pulumi/pulumi" data-size="small" data-show-count="true" aria-label="Star pulumi/pulumi on GitHub">Star</a>
            </li>
        </ul>
    </div>
</nav>



<nav class="nav-main bg-purple-700 py-6 px-4 lg:px-0 border-t border-purple-500">
    <div class="container mx-auto">
        <header class="flex items-center justify-between flex-wrap md:flex-no-wrap">
            <div class="flex items-center flex-shrink-0 text-white lg:mr-6">
                <a class="block" href="/">
                    <img class="h-10 block" src="/images/logo/logo-inv.svg" alt="Pulumi logo">
                </a>
            </div>

            <div class="nav-header-toggle block md:hidden">
                <button class="flex items-center px-3 py-2 border rounded text-white border-purple-400 bg-purple-600">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <ul class="nav-header-items hidden w-full flex-grow md:flex md:items-center md:w-auto text-white text-sm md:text-xs lg:text-sm uppercase pt-4 md:pt-0">
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/product/" data-submenu="product" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Products
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/why-pulumi/" data-submenu="why" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Why Pulumi
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/pricing/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Pricing
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/docs/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            Docs
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/blog/" data-submenu="" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded bg-purple-400 hover:bg-purple-400">
                            Blog
                        </a>
                    </li>
                
                    <li class="whitespace-no-wrap">
                        
                        <a href="/about/" data-submenu="about" class="block py-2 px-4 md:px-0 md:py-0 md:px-4 md:py-2 my-2 md:my-0 lg:mx-4 rounded hover:bg-purple-500">
                            About
                        </a>
                    </li>
                

                <li class="md:ml-auto md:mr-2 lg:mr-4">
                    <a class="block mt-4 md:mt-0 md:text-xs lg:text-sm btn btn-orange-translucent" href="https://app.pulumi.com/">Sign In</a>
                </li>
                <li>
                    <a class="block mt-4 md:mt-0 md:text-xs lg:text-sm btn" href="https://app.pulumi.com/signup">Sign Up</a>
                </li>
            </ul>
        </header>
    </div>
</nav>
<div class="submenu">
    <div class="text-white relative overflow-visible">
        <div class="submenu-item submenu-item-product hidden absolute inset-x-0 z-50 bg-purple-700 shadow-lg pt-8 pb-16">
            <div class="container mx-auto flex items-start">
                <div class="w-1/2 pr-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">The Pulumi Platform</h3>
                    <p class="text-white">
                        Cloud Apps and Infrastructure for any cloud using languages you already know and love.
                    </p>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-sdk">Pulumi SDK</a>
                            <span>&rarr; Cloud native infrastructure as code.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-crosswalk">Pulumi Crosswalk</a>
                            <span>&rarr; Productive infrastructure as code with built-in best practices.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#pulumi-saas">Pulumi SaaS</a>
                            <span>&rarr; Continuously deliver and manage cloud software for any cloud.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/product/#multi-cloud-subscription">Multi-Cloud Subscription</a>
                            <span>&rarr; End-to-end Kubernetes solutions to achieve multi-cloud.</span>
                        </li>
                    </ul>
                    <p>
                        <span class="text-white">Pulumi is open source, free to start, and has plans available for teams.</span>
                        <a class="text-orange-500 hover:text-orange-400 hover:mr-1 transition-all" href="/pricing/">View Pricing</a> &rarr;
                    </p>
                </div>
                <div class="w-1/2 pl-12 text-purple-100 text-sm">
                    <h3 class="text-white">Get Started</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/reference/install/">Install (Mac, Windows, Linux)</a> &rarr;
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/">Documentation and Examples</a> &rarr;
                        </li>
                    </ul>
                    <h3 class="text-white">Migrate to Pulumi</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/cloudformation/">from CloudFormation</a> &rarr;
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/terraform/">from Terraform</a> &rarr;
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="submenu-item submenu-item-why hidden absolute inset-x-0 z-50 bg-purple-700 shadow pt-8 pb-16">
           <div class="container mx-auto flex items-start">
                <div class="w-1/2 pr-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">Solutions for All Teams and Engineers</h3>
                    <p class="text-white">
                        Maximize cloud velocity for Dev, DevOps, and IT, no matter your team size.
                    </p>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-developers">For Developers</a>
                            <span>&rarr; Your favorite languages, tools, and libraries.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-operators">For DevOps and IT</a>
                            <span>&rarr; Empower your team to deliver to many clouds.</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400" href="/why-pulumi/#for-business-leaders">For Business Leaders</a>
                            <span>&rarr; Modern multi-cloud for startups and enterprises.</span>
                        </li>
                    </ul>
                </div>
                <div class="w-1/4 px-12 border-r border-purple-500 text-purple-100 text-sm">
                    <h3 class="text-white">Any Code</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/serverless/">Serverless</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/containers/">Containers</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/kubernetes/">Kubernetes</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/docs/reference/tutorials/aws/tutorial-ec2-webserver/">Infrastructure</a>
                            <span>&rarr;</span>
                        </li>
                    </ul>
                </div>
                <div class="w-1/4 pl-12 text-purple-100 text-sm">
                    <h3 class="text-white">Migrate to Pulumi</h3>
                    <ul class="p-0 leading-loose">
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/aws/">AWS</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/azure/">Azure</a>
                            <span>&rarr;</span>
                        </li>
                        <li>
                            <a class="text-orange-500 font-bold hover:text-orange-400 hover:mr-1 transition-all" href="/gcp/">GCP</a>
                            <span>&rarr;</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


        
        

        <main>
            
    <div class="container mx-auto px-8 py-8 md:px-0">
        <div class="md:flex">
            <div class="md:w-3/12 pr-8">
                
<aside class="md:pr-8">

    
    <div class="md:hidden">
        <button class="blog-sidebar-toggle items-center px-3 py-2 border rounded text-purple border-purple">
            <i class="fas fa-bars"></i>
        </button>
        <a href="/blog/">🍹 Pulumi Blog</a>
    </div>

    <h3 class="no-anchor hidden md:flex mt-4">
        <a href="/blog/">🍹 Pulumi Blog</a>
    </h3>

    
    <div class="blog-sidebar-content hidden md:block">
        <div class="bg-gray-100 rounded-lg p-4 my-6 text-gray-700">
            <h5 class="no-anchor text-gray-700">Program the Cloud</h5>
            <p class="text-sm my-0">
                Create, deploy, and manage cloud infrastructure using your favorite language.
            </p>
        </div>

        <ul class="list-none p-0 mb-4 inline-flex flex-wrap text-xs">
            
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/apigateway/">
                            apigateway
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/applications/">
                            applications
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/auth/">
                            auth
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/aws/">
                            aws
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/azure/">
                            azure
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/ci/cd/">
                            ci/cd
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/cloud-native/">
                            cloud-native
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/containers/">
                            containers
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/customer/">
                            customer
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/digitalocean/">
                            digitalocean
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/docker/">
                            docker
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/eks/">
                            eks
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/events/">
                            events
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/features/">
                            features
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/gcp/">
                            gcp
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/gke/">
                            gke
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/infrastructure/">
                            infrastructure
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/javascript/">
                            javascript
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/jupyter/">
                            jupyter
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/kubernetes/">
                            kubernetes
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/lambda/">
                            lambda
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/logging/">
                            logging
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/mysql/">
                            mysql
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/new-features/">
                            new-features
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/pulumi/">
                            pulumi
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/pulumi-news/">
                            pulumi-news
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/python/">
                            python
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/security/">
                            security
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/serverless/">
                            serverless
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/testing/">
                            testing
                        </a>
                    </li>
                
            
                
                    <li>
                        
                        
                        <a class="px-2 py-1 mr-1 rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="https://www.pulumi.com/blog/tag/typescript/">
                            typescript
                        </a>
                    </li>
                
            
        </ul>

        <div class="hidden lg:block my-4">
            <h5 class="no-anchor">Recent Posts</h5>
            <ul class="list-none p-0">
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/day-2-kubernetes-migrating-eks-nodegroups-with-zero-downtime/">Day 2 Kubernetes: Migrating EKS Node Groups with Zero Downtime</a>
                        </li>
                    
                
                    
                        
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/getting-started-on-digitalocean-with-pulumi/">Getting Started on DigitalOcean with Pulumi</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/pulumi-meetup-recap-apis-custom-resources-and-github-webhooks/">Pulumi Meetup Recap: APIs, Custom Resources and GitHub Webhooks</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/persisting-kubernetes-workloads-with-amazon-efscsi-volumes-using-pulumi-sdks/">Persisting Kubernetes workloads with Amazon EFS CSI volumes using Pulumi open source SDKs</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/unit-testing-infrastructure-in-nodejs-and-mocha/">Unit Testing Your Infrastructure with Node.js and Mocha</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/kubernetes-ingress-with-aws-alb-ingress-controller-and-pulumi-crosswalk/">Kubernetes Ingress with AWS ALB Ingress Controller and Pulumi Crosswalk for AWS</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/globally-distributed-serverless-application-in-100-lines-of-code-infrastructure-included/">Globally-distributed Serverless Application in 100 Lines of Code. Infrastructure Included!</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/hosting-a-static-website-on-azure-with-pulumi/">Hosting a Static Website on Azure with Pulumi</a>
                        </li>
                    
                
                    
                        <li class="my-4 leading-snug">
                            <a class="text-sm" href="https://www.pulumi.com/blog/running-containers-in-aws-the-lowdown-ecs-fargate-and-eks/">Running Containers in AWS, the Lowdown: ECS, Fargate, and EKS</a>
                        </li>
                    
                
            </ul>
        </div>
    </div>

    <div class="md:hidden pb-4">
        
    </div>
</aside>

            </div>

            <div class="md:w-7/12">
                <article class="mb-8 pb-8 border-b border-gray-200">
                    <h1 class="no-anchor"><a href="https://www.pulumi.com/blog/globally-distributed-serverless-application-in-100-lines-of-code-infrastructure-included/">Globally-distributed Serverless Application in 100 Lines of Code. Infrastructure Included!</a></h1>
                    <div class="flex items-center">
                        <span>
                            <span class="flex items-center">
    
        
        

        <span class="flex items-center mr-2">
            
                <a class="rounded-full p-1 bg-gray-300 mr-2" href="https://www.pulumi.com/blog/author/mikhail-shilkov/">
                    <img class="w-8 rounded-full" src="/images/team/mikhail-shilkov.jpg" alt="Mikhail Shilkov" title="Mikhail Shilkov">
                </a>
                <a class="" href="https://www.pulumi.com/blog/author/mikhail-shilkov/">Mikhail Shilkov</a>
            
        </span>
    
</span>

                        </span>
                    </div>
                    <section>
                        <p>Pulumi is excellent at connecting multiple cloud components into a
cohesive application. In my <a href="/blog/serverless-as-simple-callbacks-with-pulumi-and-azure-functions/">previous post</a>,
I introduced the way to mix JavaScript or TypeScript serverless
functions directly into the cloud infrastructure programs.</p>

<p>Today, I will build a serverless application with both the data store
and the HTTP endpoint located close to end users to ensure prompt
response time. The entire application runs on top of managed Azure
services and is defined as a single Pulumi program in TypeScript.</p>

<h2 id="baseline">Baseline</h2>

<p>I&rsquo;m going to build a URL shortener: a simple HTTP endpoint which accepts
a shortcode in the URL and then redirects a user to the full URL
associated with the given short code.</p>

<p>I start simple and make a non-distributed version of the application
first. It consists of two main components: a Cosmos DB container to
store URL mappings and two Azure Functions to handle HTTP requests:</p>

<p><img src="./pulumi-azure-url-shortener-basic.png" alt="The basic version of URL Shortener with Azure and Pulumi" /></p>

<p>Let&rsquo;s define this infrastructure in a Pulumi program.</p>

<h3 id="cosmos-db-collection">Cosmos DB Collection</h3>

<p>Arguably, Cosmos DB is overkill in such a simple scenario: we just need
a key-value store, so Table Storage would suffice. However, Cosmos DB
comes handy at the multi-region setup later on.</p>

<p>Next to a standard resource group definition, I create a Cosmos DB
account with location set to a single region and <code>Session</code> consistency
level:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">pulumi</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/pulumi&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">azure</span> <span class="nx">from</span> <span class="s2">&#34;@pulumi/azure&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">cosmos</span> <span class="nx">from</span> <span class="s2">&#34;@azure/cosmos&#34;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">location</span> <span class="o">=</span> <span class="s2">&#34;westus&#34;</span><span class="p">;</span> <span class="c1">// To be changed to multiple configurable locations
</span><span class="c1"></span>
<span class="kd">let</span> <span class="nx">resourceGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">ResourceGroup</span><span class="p">(</span><span class="s2">&#34;UrlShorterner&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">location</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">let</span> <span class="nx">cosmosdb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">cosmosdb</span><span class="p">.</span><span class="nx">Account</span><span class="p">(</span><span class="s2">&#34;UrlStore&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">resourceGroupName</span>: <span class="kt">resourceGroup.name</span><span class="p">,</span>
    <span class="nx">location</span><span class="p">,</span>
    <span class="nx">geoLocations</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">failoverPriority</span>: <span class="kt">0</span> <span class="p">}],</span>
    <span class="nx">offerType</span><span class="o">:</span> <span class="s2">&#34;Standard&#34;</span><span class="p">,</span>
    <span class="nx">consistencyPolicy</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">consistencyLevel</span><span class="o">:</span> <span class="s2">&#34;Session&#34;</span><span class="p">,</span>
        <span class="nx">maxIntervalInSeconds</span>: <span class="kt">5</span><span class="p">,</span>
        <span class="nx">maxStalenessPrefix</span>: <span class="kt">100</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">});</span></code></pre></div>
<p>Cosmos DB has a hierarchical structure of Accounts, Databases, and
Containers. Unfortunately, Cosmos DB containers can&rsquo;t be defined as
Pulumi resources yet. As a workaround, I defined a helper function
<code>getContainer</code> to create a database and a container using Cosmos SDK,
see
<a href="https://github.com/pulumi/examples/blob/master/azure-ts-serverless-url-shortener-global/cosmosclient.ts">here</a>.</p>

<h3 id="function-app">Function App</h3>

<p>Serverless Azure Functions are going to handle the HTTP layer in my
application. I use the technique of <a href="/blog/serverless-as-simple-callbacks-with-pulumi-and-azure-functions/">serverless functions as callbacks</a>
to define Azure Functions inline inside my Pulumi program:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">appservice</span><span class="p">.</span><span class="nx">HttpEventSubscription</span><span class="p">(</span><span class="s2">&#34;GetUrl&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">resourceGroup</span><span class="p">,</span>
    <span class="nx">location</span><span class="p">,</span>
    <span class="nx">route</span><span class="o">:</span> <span class="s2">&#34;{key}&#34;</span><span class="p">,</span>
    <span class="nx">callback</span>: <span class="kt">async</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">request</span>: <span class="kt">azure.appservice.HttpRequest</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="nx">cosmosdb</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="kr">const</span> <span class="nx">masterKey</span> <span class="o">=</span> <span class="nx">cosmosdb</span><span class="p">.</span><span class="nx">primaryMasterKey</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>

        <span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getContainer</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="nx">masterKey</span><span class="p">);</span>
        
        <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">];</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">container</span><span class="p">.</span><span class="nx">item</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">toString</span><span class="p">()).</span><span class="nx">read</span><span class="p">();</span>       
            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">status</span>: <span class="kt">301</span><span class="p">,</span>
                <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&#34;location&#34;</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">url</span> <span class="p">},</span>
                <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="p">};</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">404</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Short URL not found&#39;</span> <span class="p">}</span>
        
    
<span class="p">});</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span></code></pre></div>
<p>I supply the template <code>{key}</code> as <code>route</code> parameter so that the function
accepts wildcard URLs and extract the wildcard value as a <code>key</code>
parameter available inside the <code>request</code> object. Then, I use the
received key to look up the full URL. The URL is returned to the client
as a header of the <code>301</code> Redirect response. <code>404</code> Not Found is returned
in case the requested document does not exist&mdash;the naughty Cosmos SDK
throws an error in this scenario.</p>

<p>Note how the Cosmos DB parameters <code>endpoint</code> and <code>primaryMasterKey</code> are
used directly inside the function. There is no need to manage the keys
manually or explicitly put them into application settings: the generated
keys are injected into the code at the time of deployment. In practice,
a better idea is to store the key in a KeyVault and read it via
application settings, but I&rsquo;ll leave this for a separate article.</p>

<p>A function to add a URL to the database looks quite similar to the
above:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">appservice</span><span class="p">.</span><span class="nx">HttpEventSubscription</span><span class="p">(</span><span class="s2">&#34;AddUrl&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">resourceGroup</span><span class="p">,</span>
    <span class="nx">methods</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;POST&#34;</span><span class="p">],</span>
    <span class="nx">callback</span>: <span class="kt">async</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">request</span>: <span class="kt">azure.appservice.HttpRequest</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="nx">cosmosdb</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="kr">const</span> <span class="nx">masterKey</span> <span class="o">=</span> <span class="nx">cosmosdb</span><span class="p">.</span><span class="nx">primaryMasterKey</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
        <span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getContainer</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="nx">masterKey</span><span class="p">,</span> <span class="nx">location</span><span class="p">);</span>

        <span class="nx">await</span> <span class="nx">container</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">200</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Short URL saved&#39;</span> <span class="p">};</span>
    
<span class="p">});</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">addEndpoint</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span></code></pre></div>
<p>The key differences are:</p>

<ul>
<li>Using <code>POST</code> as the accepted HTTP method</li>
<li>Creating a new item in Cosmos DB</li>
<li>Using <code>request.body</code> as the payload to save</li>
</ul>

<p>I might need to add some validation in a real application&mdash;skipped for
now.</p>

<h3 id="trying-it-out">Trying It Out</h3>

<p>Now, when a user navigates to an address like
<code>https://geturl-xyz.azurewebsites.net/api/URLKEY</code>, they get redirected
to the full URL associated with the key. The URL is not quite short yet,
but we could make it so with a custom domain configuration.</p>

<p>Presumably, we expect our URL shortener to be popular around the world.
Therefore, one key aspect is to make sure that the service responds fast
and enables a smooth user experience. Let&rsquo;s measure the response time of
our first version from different spots around the world:</p>

<table>
<thead>
<tr>
<th>Location</th>
<th>Response time</th>
</tr>
</thead>

<tbody>
<tr>
<td>San Francisco</td>
<td>133 ms</td>
</tr>

<tr>
<td>New York</td>
<td>272 ms</td>
</tr>

<tr>
<td>London</td>
<td>383 ms</td>
</tr>

<tr>
<td>Frankfurt</td>
<td>420 ms</td>
</tr>

<tr>
<td>Tel-Aviv</td>
<td>470 ms</td>
</tr>

<tr>
<td>Hong-Kong</td>
<td>437 ms</td>
</tr>

<tr>
<td>Brisbane</td>
<td>449 ms</td>
</tr>
</tbody>
</table>

<p>The further we get from the West US region, the slower the responses
become.</p>

<p>How can we do better?</p>

<h2 id="bring-compute-and-data-closer-to-users">Bring Compute and Data Closer to Users</h2>

<p>It&rsquo;s hard to beat the speed of light, so if we want to respond fast, we
need to bring both code and data close to any target user.</p>

<p>Luckily, the most involved aspect of that&mdash;the data distribution&mdash;can
be handled by Cosmos DB multi-region accounts. We need to take care of
deploying the code in multiple locations and routing the traffic to the
nearest one. Here is the plan:</p>

<p><img src="./pulumi-azure-url-shortener-distributed.png" alt="The distributed version of URL Shortener with Azure and Pulumi" /></p>

<p>I don&rsquo;t care too much about the latency of Add URL function, so I left
it out of the picture.</p>

<h3 id="configuring-the-locations">Configuring the locations</h3>

<p>The above picture shows three Azure regions, but since I&rsquo;m using a
general-purpose programming language, I can handle any number of
locations in the same way. Actually, I put the list of target regions in
Pulumi config file and read it at execution time:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">locations</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&#34;locations&#34;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">primaryLocation</span> <span class="o">=</span> <span class="nx">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></code></pre></div>
<p>The order of regions defines the priority.</p>

<h3 id="multi-region-cosmos-db-account">Multi-region Cosmos DB Account</h3>

<p>Since <code>locations</code> is a simple array, I can <code>map</code> this array to produce
the array of <code>geoLocations</code> to be set for my Cosmos DB:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">let</span> <span class="nx">cosmosdb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">cosmosdb</span><span class="p">.</span><span class="nx">Account</span><span class="p">(</span><span class="s2">&#34;url-cosmos&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">location</span>: <span class="kt">primaryLocation</span><span class="p">,</span>
    <span class="nx">geoLocations</span>: <span class="kt">locations.map</span><span class="p">((</span><span class="nx">location</span><span class="p">,</span> <span class="nx">failoverPriority</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="nx">location</span><span class="p">,</span>
        <span class="nx">failoverPriority</span>
    <span class="p">})),</span>
    <span class="cm">/* ... other properties stay the same ... */</span></code></pre></div>
<p>Right here, the full power of a programming language at my fingertips!</p>

<h3 id="multi-region-serverless-app">Multi-region Serverless App</h3>

<blockquote>
<p>Azure Traffic Manager is a DNS-based traffic load balancer that
enables you to distribute traffic optimally to services across global
Azure regions while providing high availability and responsiveness.</p>
</blockquote>

<p>Sounds like what I need for my global application! Let&rsquo;s define a
Traffic Manager profile:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">const</span> <span class="nx">profile</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">trafficmanager</span><span class="p">.</span><span class="nx">Profile</span><span class="p">(</span><span class="s2">&#34;UrlShortEndpoint&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">resourceGroupName</span>: <span class="kt">resourceGroup.name</span><span class="p">,</span>
    <span class="nx">trafficRoutingMethod</span><span class="o">:</span> <span class="s1">&#39;Performance&#39;</span><span class="p">,</span>       
    <span class="nx">dnsConfigs</span><span class="o">:</span> <span class="p">[{</span>
        <span class="nx">relativeName</span><span class="o">:</span> <span class="s2">&#34;shorturls&#34;</span><span class="p">,</span>
        <span class="nx">ttl</span>: <span class="kt">60</span><span class="p">,</span>
    <span class="p">}],</span>
    <span class="nx">monitorConfigs</span><span class="o">:</span> <span class="p">[{</span>
        <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;HTTP&#39;</span><span class="p">,</span>
        <span class="nx">port</span>: <span class="kt">80</span><span class="p">,</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/api/ping&#39;</span><span class="p">,</span>
    <span class="p">}]</span>
<span class="p">});</span></code></pre></div>
<p>I set the routing method to Performance:</p>

<blockquote>
<p>Select Performance when you have endpoints in different geographic
locations and you want end users to use the &ldquo;closest&rdquo; endpoint in
terms of the lowest network latency.</p>
</blockquote>

<p>Now, I need to create a Function App in each of the target regions.
That&rsquo;s easy to achieve with a <code>for..of</code> loop:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">location</span> <span class="nx">of</span> <span class="nx">locations</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">appservice</span><span class="p">.</span><span class="nx">HttpEventSubscription</span><span class="p">(</span><span class="sb">`GetUrl-</span><span class="si">${</span><span class="nx">location</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">resourceGroup</span><span class="p">,</span>
        <span class="nx">location</span><span class="p">,</span>
        <span class="nx">route</span><span class="o">:</span> <span class="s2">&#34;{key}&#34;</span><span class="p">,</span>
        <span class="nx">callback</span><span class="o">:</span> <span class="cm">/* ... the function stays the same ... */</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></div>
<p>Finally, I set up an Endpoint for each Function App to bind them to the
Traffic Manager. I do so in the same loop as above:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">location</span> <span class="nx">of</span> <span class="nx">locations</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">appservice</span><span class="p">.</span><span class="nx">HttpEventSubscription</span><span class="p">(</span><span class="sb">`GetUrl-</span><span class="si">${</span><span class="nx">location</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span>
        <span class="cm">/* ... function definition as shown above ... */</span>
    <span class="p">});</span>

    <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">functionApp</span><span class="p">;</span>

    <span class="k">new</span> <span class="nx">azure</span><span class="p">.</span><span class="nx">trafficmanager</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">(</span><span class="sb">`tme</span><span class="si">${</span><span class="nx">location</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">resourceGroupName</span>: <span class="kt">resourceGroup.name</span><span class="p">,</span>
        <span class="nx">profileName</span>: <span class="kt">profile.name</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;azureEndpoints&#39;</span><span class="p">,</span>
        <span class="nx">targetResourceId</span>: <span class="kt">app.id</span><span class="p">,</span>
        <span class="nx">target</span>: <span class="kt">app.defaultHostname</span><span class="p">,</span>
        <span class="nx">endpointLocation</span>: <span class="kt">app.location</span><span class="p">,</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></div>
<p>I assign the properties of each Function App to the corresponding
Endpoint with a simple object initializer expression.</p>

<p>Everything is in place. I can export the Traffic Manager endpoint:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="nx">pulumi</span><span class="p">.</span><span class="nx">interpolate</span> <span class="sb">`http://</span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">fqdn</span><span class="si">}</span><span class="sb">/api/{key}`</span><span class="p">;</span></code></pre></div>
<p>Time to re-run the latency tests.</p>

<h2 id="results">Results</h2>

<p>I deployed the distributed infrastructure to five Azure regions: West
US, East US, West Europe, East Asia, and Australia East. The results are
shown in the table below, next to the values from the initial run:</p>

<table>
<thead>
<tr>
<th>Location</th>
<th>Single region</th>
<th>Multiple regions</th>
</tr>
</thead>

<tbody>
<tr>
<td>San Francisco</td>
<td>133 ms</td>
<td>140 ms</td>
</tr>

<tr>
<td>New York</td>
<td>272 ms</td>
<td>152 ms</td>
</tr>

<tr>
<td>London</td>
<td>383 ms</td>
<td>150 ms</td>
</tr>

<tr>
<td>Frankfurt</td>
<td>420 ms</td>
<td>130 ms</td>
</tr>

<tr>
<td>Tel-Aviv</td>
<td>470 ms</td>
<td>307 ms</td>
</tr>

<tr>
<td>Hong-Kong</td>
<td>437 ms</td>
<td>149 ms</td>
</tr>

<tr>
<td>Brisbane</td>
<td>449 ms</td>
<td>529 ms</td>
</tr>
</tbody>
</table>

<p>We got a much smoother distribution of response time. There&rsquo;s no region
close enough to Tel-Aviv, so its latency is still high-ish. I checked
Brisbane, and the traffic was somehow directed to the East US region, so
the latency hasn&rsquo;t improved at all. For today, I guess I&rsquo;ll stick to the
hypothesis &ldquo;Australian internet is slow&rdquo; and advise to always test your
target scenarios without trusting the providers blindly.</p>

<p>More importantly, I walked you through a scenario of developing an
end-to-end application with Pulumi. I highlighted the power of
leveraging familiar techniques coming from the TypeScript realm. You can
find the full code in <a href="https://github.com/pulumi/examples/tree/master/azure-ts-serverless-url-shortener-global">Pulumi examples</a>.</p>

<p>Cloud brings superpowers to developer&rsquo;s hands. You just need to use
those efficiently.</p>
                    </section>
                    <div>
                        <p class="text-gray-500">Posted on <time>Tuesday, Jul 2, 2019</time>
                        
                        <ul class="m-0 p-0">
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/serverless/">
                                    Serverless
                                </a>
                            </li>
                            
                            <li class="inline-flex">
                                
                                <a class="px-2 text-s rounded transition-all bg-white border border-gray-200 text-blue-600 hover:border-blue-600" href="/blog/tag/azure/">
                                    Azure
                                </a>
                            </li>
                            
                        </ul>
                        
                    </div>
                </article>
            </div>

            <div class="md:w-2/12 pl-8">
                
            </div>
        </div>
    </div>

        </main>

        <nav class="footer bg-purple-700 py-8 px-8 md:px-0">
    <div class="container mx-auto">
        <footer>
            <div class="md:flex items-top justify-between flex-wrap">

                <div class="mb-6 md:w-4/12">
                    <a class="block mt-2" href="/">
                        <img class="h-10 opacity-50" src="/images/logo/logo-white.svg" alt="Pulumi logo">
                    </a>
                    <a class="inline-block my-4 opacity-50 text-white text-lg" href="mailto:team@pulumi.com">team@pulumi.com</a>
                    <ul class="flex inline-items text-blue-300 text-2xl">
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://twitter.com/pulumicorp" target="_blank"><i class="fab fa-twitter"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://www.linkedin.com/company/pulumi/" target="_blank"><i class="fab fa-linkedin"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://github.com/pulumi/" target="_blank"><i class="fab fa-github"></i></a></li>
                        <li class="mr-4"><a class="hover:text-blue-200" href="https://www.youtube.com/channel/UC2Dhyn4Ev52YSbcpfnfP0Mw" target="_blank"><i class="fab fa-youtube"></i></a></li>
                        <li><a class="hover:text-blue-200" href="https://slack.pulumi.io/" target="_blank"><i class="fab fa-slack-hash"></i></a></li>
                    </ul>
                </div>

                <div class="flex flex-wrap items-top md:w-8/12">
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/containers/">Containers</a></li>
                        <li class="mb-4"><a href="/serverless/">Serverless</a></li>
                        <li class="mb-4"><a href="/docs/reference/tutorials/aws/tutorial-ec2-webserver/">Infrastructure</a></li>
                        <li class="mb-4"><a href="/kubernetes/">Kubernetes</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/docs/reference/install/">Install</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/">Get Started</a></li>
                        <li class="mb-4"><a href="/docs/reference/">Documentation</a></li>
                        <li class="mb-4"><a href="/docs/reference/pkg/">APIs</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/docs/quickstart/aws/">AWS</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/azure/">Azure</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/gcp/">Google Cloud</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/kubernetes/">Kubernetes</a></li>
                        <li class="mb-4"><a href="/docs/quickstart/cloudfx/">Cloud Framework</a></li>
                        <li class="mb-4"><a href="/docs/reference/clouds/openstack/">OpenStack</a></li>
                    </ul>
                    <ul class="my-4 text-white w-1/2 md:w-3/12">
                        <li class="mb-4"><a href="/about/">About Us</a></li>
                        <li class="mb-4"><a href="/contact/">Contact Us</a></li>
                        <li class="mb-4"><a href="/support/">Support</a></li>
                        <li class="mb-4"><a href="/careers/">Careers</a></li>
                    </ul>
                </div>
            </div>

            <div class="text-white opacity-75 text-sm lg:flex items-center border-t border-purple-500 mt-4 pt-4">
                
                <p class="md:w-4/12">&copy; 2019 Pulumi. All rights reserved.</p>

                <ul class="md:w-8/12">
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/trademark/">Trademark Usage</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/acceptable-use/">Acceptable Use Policy</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/terms-and-conditions/">Terms &amp; Conditions</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/privacy/">Privacy Policy</a></li>
                    
                        <li class="inline mr-2 lg:mr-4"><a href="/professional-services-agreement/">Professional Services Agreement</a></li>
                    
                </ul>
            </div>
        </footer>
    </div>
</nav>

        <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>











    




<script src="/js/bundle.min.8d935315b94bf6e77843b9c51ebc10238af740294e751f49b183b5d1e27a1c27.js" integrity="sha256-jZNTFblL9ud4Q7nFHrwQI4r3QClOdR9JsYO10eJ6HCc="></script>

    </body>
</html>
